# lsof
## Документация
https://www.opennet.ru/base/sys/lsof_util.txt.html

## Значение столбцов lsof

Типов открытых файлов много, и далеко не все столбцы применимы к каждому из них. Поэтому если для каких-то файлов некоторые столбцы не заполнены данными, то это нормально.

    COMMAND: Имя команды, связанной с процессом, который открыл файл.
    PID: Идентификационный номер процесса, который открыл файл.
    TID: Идентификационный номер задачи (потока) . Пустой столбец означает, что это не задача; это процесс.
    TASKCMD: это имя команды задачи. Обычно это будет то же самое, что и процесс, названный в столбце COMMAND, но некоторые реализации задач (например, Linux) позволяют задаче изменить имя своей команды.
    USER: идентификатор пользователя или имя пользователя, которому принадлежит процесс, или идентификатор пользователя или логин человека, которому принадлежит каталог в /proc, где lsof находит информацию о процессе (также смотрите Что такое файловая система /proc в Linux)
    FD: показывает файловый дескриптор файла. Файловые дескрипторы описаны ниже.
    TYPE: тип узла, связанного с файлом. Виды данных типов описаны ниже.
    DEVICE: содержит номера устройств, разделённые запятыми, для специальных символьных, специальных блочных, обычных файлов, каталогов или NFS. Также может отображаться базовый адрес или имя устройства с сокетом Linux AX.25.
    SIZE/OFF: Показывает размер файла или смещение файла в байтах.
    NODE: Показывает номер узла локального файла или номер узла NFS-файла на хосте сервера или тип интернет-протокола. Может отображаться STR для потока, IRQ или номер инода устройства с сокетом Linux AX.25.
    NAME: показывает имя точки монтирования и файловой системы, в которой находится файл.

__Колонка FD__

Дескриптор файла в столбце FD может быть одним из многих вариантов; на странице руководства они перечислены все: 

Запись в столбце FD может состоять из трёх частей: дескриптор файла, символ режима и символ блокировки.

Некоторые популярные файловые дескрипторы:

    cwd: текущий рабочий каталог.
    err: информация об ошибке FD (см. столбец NAME).
    ltx: текст разделяемой библиотеки (код и данные).
    m86: файл сопоставления DOS Merge.
    mem: файл с отображением в памяти.
    mmap: устройство с отображением в памяти.
    pd: родительский каталог.
    rtd: корневой каталог.
    txt: текст программы (код и данные)

Символ режима может быть одним из следующих:

    r: доступ для чтения.
    w: доступ для записи.
    u: Доступ для чтения и записи.
     : Пробел, если режим неизвестен и нет символа блокировки.
    -: режим неизвестен и есть символ блокировки.

Символ блокировки может быть одним из:

    r: Блокировка чтения на часть файла.
    R: Блокировка чтения на весь файл.
    w: Блокировка записи для на часть файла.
    W: Блокировка записи для на весь файл.
    u: Блокировка чтения и записи любой длины.
    U: неизвестный тип блокировки.
     : символ пробела. Нет блокировки.

__Колонка TYPE__

В столбце TYPE может отображаться более 70 записей. Далее перечислены только некоторые из часто встречающихся записей:

    REG: Обычный файл файловой системы.
    DIR: Директория.
    FIFO: Специальный файл FIFO (First In First Out).
    CHR: Специальный символьный файл.
    BLK: Специальный блочный файл.
    INET: Интернет-сокет.
    unix: Доменный сокет UNIX.
    IPv4: IPv4 сокет.
    IPv6: Файлы IPv6 сети — даже если её адрес IPv4 преобразован в IPv6 адрес.
    sock: Сокет неизвестного домена.
    DEL: Указатель Linux для удалённого файла.
    LINK: Файл символьной ссылки.
    PIPE: Труба (pipe) — способ обмена данными между процессами.



lsof -U -u kos


   выдаст данные о всех открытых UNIX-сокетах и всех файлах,
   принадлежащих процессам, запущенным пользователем "kos".

---

   lsof -a -U -u kos


   выдаст список только сокетов UNIX, принадлежащих процессам, владельцем которых является пользователь "kos"'. Обратите внимание на то, что опция -a стоит не между объединяемыми ею другими опциями. Впрочем, ее можно ставить где угодно, все равно все перечисленные в командной строке опции будут работать по принципу "логическое И".

---

Но если указывается, например, несколько однотипных опций, то вначале к ним применяется операция логического ИЛИ, а затем уже работает опция -a. Пример: по команде

    lsof -i@aaa.bbb -i@ccc.ddd -a -ufff,ggg


будет выведен список файлов, принадлежащих ЛИБО пользователю "fff", ЛИБО пользователю "ggg" И имеющих сетевые соединения ЛИБО к хосту
aaa.bbb ЛИБО к хосту ccc.ddd.

---
Пример 1. Кто работает с файлом или каталогом?

    lsof +d /mnt/cdrom

Надо отметить, что при использовании опции +d dir выдается информация только о тех файлах и подкаталогах, которые содержатся в самом
каталоге dir, а не в его подкаталогах.
Но, если вы все же захотите
получить список всех открытых файлов во всех вложенных подкаталогах
каталога dir, надо воспользоваться опцией +D.

---
Пример 2. Какой процесс использует данный файл?

lsof /etc/passwd

Приведенный пример очень похож на предыдущий, только вы получаете
сведения о процессах, использующих конкретный файл.

---
Пример 3. Какие ресурсы использует процесс?

lsof -c mc

Если вы хотите конкретизировать ваш запрос, вы можете
воспользоваться другой опцией: -p pid. Например:

    lsof -p 409


Команда lsof -p pid выводит список файлов, открытых процессами, чьи
идентификаторы (PID) находятся в списке pid, например, "3593" или
"823,451" (отдельные идентификаторы разделяются запятыми, пробелы в
списке недопустимы). С помощью этой команды вы сможете увидеть,
например, какие библиотеки используются процессом. Номер нужного PID
можно извлечь из результатов выполнения команды /usr/sbin/lsof -c string.

Аналогичным образом можно вывести список файлов, открытых процессами,
чьи идентификаторы группы (PGID) находятся в разделенном запятыми
списке gid. Это позволяет сделать команда
 lsof -g gid.

---
Пример 4. С какими файлами работает пользователь?

lsof -u names

позволяет вывести список файлов, открытых всеми процессами, запущенными пользователями, чье имя или идентификатор содержится в
списке names. Отдельные элементы списка разделяются запятыми,
например, "548,root" (пробелов быть не должно).

---
Пример 5. Кто подключился к вашему компьютеру?

Команда lsof очень полезна в том случае, когда вы хотите обеспечить
безопасность работы вашего компьютера в сети. С ее помощью вы можете
определить, какие порты открыты для приема входящих соединений и какая
программа прослушивает каждый порт. После это можно закрыть ненужные
порты, чтобы минимизировать риск проникновения в систему
злоумышленника. Для того, чтобы узнать, какие процессы в данный момент
прослушивают сетевые соединения, воспользуйтесь командой lsof с опцией -i :

    lsof -i

    lsof -i :80
В этом случае будет выдан список всех процессов, прослушивающих или установивших соединение через порт 80.

    lsof -i TCP:1-1024
Если нужно увидеть все запущенные процессы, которые открыли файлы TCP портов в диапазоне 1-1024

    lsof -i TCP:1-1024,8000-9000,10000
Кроме диапазона портов через дефис, можно указать несколько портов или их диапазонов через запятую

    lsof -i :smtp
В этом примере будут перечислены все соединения, ассоциированные с почтовым протоколом SMTP.

    lsof -i @rus-linux.net
В третьем случае будет выдан список всех входящих и исходящих соединений с хостом rus-linux.net.

    lsof -i UDP@rus-linux.net:123
Эта команда покажет, какие процессы установили UDP-соединения с хостом rus-linux.net через порт 123 (ntp).

    lsof -i -a -p 606
Здесь мы ищем файлы, открытые через Интернет или сетевое соединение, с помощью процесса с идентификатором 606. 

    lsof -i -a -c ssh
Мы можем использовать опцию -c (КОМАНДА) для поиска файлов, открытых определёнными процессами. Чтобы найти файлы, которые были открыты через Интернет или сетевые подключения, связанные с процессом ssh.    

Очевидно, что указание параметра adress полезно только в том случае, когда вы заранее знаете, что именно вам нужно искать. Вы можете таким
образом проверить, например, что какой-то конкретный сервис фактически работает и какой порт он прослушивает. Вы можете увидеть, подключился
ли кто-то извне к вашему компьютеру по таким протоколам как SSH, Telnet, FTP или другим возможным способом.

---
Пример 6. Кто открыл файлы по NFS?

Если вы хотите узнать, открыты ли какие-то файлы, предоставленные удаленным пользователям по протоколу NFS, используйте опцию -N.

---
Пример 7. Наблюдаем за процессом копирования

Предположим, что вы решили переместить из одного каталога в другой большое количество файлов (или большой каталог целиком). И вы хотите
видеть, какой именно файл перемещается в данный момент. Тут вам и может помочь утилита lsof. Для этого достаточно дать команду примерно
такого вида (в этом примере предполагается, что перемещаются куда-то файлы из каталога Photo):

    lsof | grep Photo


При этом нужно иметь в виду, что команда lsof делает как-бы "мгновенный снимок", отображающий только лишь состояние процессов и соответствующих файлов в момент ее выполнения. Так что для "наблюдения за процессом" надо повторять ее запуск многократно. И в таком случае может оказаться полезной опция +r, которая служит для ериодического повторения запуска команды через заданный промежуток времени.

С опцией -r это будет продолжаться пока вы не нажмете Ctrl+c. В формате +r программа будет продолжаться до тех пор, пока не будет получен пустой результат, или пока вы не нажмете Ctrl+c.
    lsof -u mial -c ssh -a -r5

Обратите внимание на пунктирную линию внизу списка. Она отделяет каждое новое отображение данных при обновлении вывода. 

---
Как узнать идентификаторы процессов, которые открыли файл

Чтобы увидеть идентификаторы процессов, которые открыли конкретный файл, используйте параметр -t (ФАЙЛ).

    lsof -t /usr/share/mime/mime.cache

---
Как остановить всю активность определённого пользователя
Иногда нужно убить все процессы определённого пользователя. Ниже команда, которая закроет все процессы пользователя mial: 
Опция -t подавляет вывод всей информации за исключением ID процессов. Я часто использую её, если хочу перенаправить список PID какой-нибудь другой команде, в основном kill-9

    kill -9 `lsof -t -u mial`