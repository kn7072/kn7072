[источник](https://selectel.ru/blog/tutorials/qemu/?ysclid=mknn0pfy7w518925781)
# Как установить и пользоваться QEMU

Эта статья предназначена для системных администраторов, разработчиков и ИТ-специалистов, которые хотят освоить QEMU — мощный инструмент для виртуализации и эмуляции. Вы узнаете, как эффективно работать с виртуальными машинами, управлять дисками и эмулировать различные архитектуры, даже если раньше не сталкивались с QEMU.

Материал будет особенно полезен тем, кто ищет альтернативу VirtualBox и VMware, хочет освоить консольные инструменты виртуализации или разрабатывает ПО для нескольких архитектур. Мы рассмотрим как базовые операции, так и продвинутые сценарии работы с QEMU.

## Что такое QEMU и зачем ее используют

QEMU (Quick Emulator) — это мощный инструмент для виртуализации и эмуляции, позволяющий запускать виртуальные машины с различными операционными системами на одном физическом устройстве. Благодаря поддержке множества архитектур, включая x86, ARM и PowerPC, QEMU способен эмулировать как современные системы, так и устаревшее оборудование. Программа работает в разных режимах, включая полную эмуляцию, что позволяет, например, запускать Windows на Linux без модификации кода.

Одним из ключевых преимуществ QEMU является возможность аппаратного ускорения через интеграцию с KVM (Kernel-based Virtual Machine), что значительно повышает производительность виртуальных машин. QEMU поддерживает различные форматы виртуальных дисков, включая QCOW2, VMDK и RAW, что делает ее гибким решением для работы с образами систем. Для удобства управления виртуальными машинами QEMU можно использовать вместе с libvirt и графическими менеджерами, такими как Virt-Manager.

QEMU применяют для самых разных задач. Разработчики используют ее для тестирования программного обеспечения в изолированных средах, а также для работы с альтернативными архитектурами. Системные администраторы ценят QEMU за возможность развертывания виртуальных серверов и настройки сложных сетевых конфигураций. Кроме того, QEMU полезна для обучения, поскольку позволяет экспериментировать с разными операционными системами без риска повредить основную систему.

В отличие от таких решений, как VirtualBox или VMware, QEMU может полностью управляться через командную строку, что делает ее особенно удобной для администрирования серверов. Однако при необходимости можно подключить графический интерфейс для более наглядной работы. Благодаря своей универсальности и открытому исходному коду, QEMU остается одним из самых востребованных инструментов в сфере виртуализации.


## Установка на Linux

Установка QEMU в операционных системах Linux осуществляется через встроенные пакетные менеджеры. Процесс установки может незначительно отличаться в зависимости от используемого дистрибутива, но общий принцип остается одинаковым.

Для дистрибутивов на основе Debian и Ubuntu, включая Linux Mint и другие производные системы, установка базового пакета QEMU выполняется следующей командой:

      `sudo apt install qemu qemu-kvm`

Перед началом установки рекомендуется проверить поддержку аппаратной виртуализации вашим процессором. Это можно сделать с помощью следующих команд:

      `grep -E '(vmx|svm)' /proc/cpuinfo`

Или команду:

      `kvm-ok`

Если система поддерживает аппаратную виртуализацию, но соответствующие модули ядра не загружены, их можно активировать командой:

      `sudo modprobe kvm`

Для процессоров Intel дополнительно выполните:

      `sudo modprobe kvm_intel`

Для процессоров AMD используйте:

      `sudo modprobe kvm_amd`

Рекомендуется установить дополнительные пакеты, чтобы получить полный функционал, включая графический интерфейс управления виртуальными машинами:

      `sudo apt install libvirt-daemon-system libvirt-clients bridge-utils virt-manager`

После завершения установки необходимо добавить текущего пользователя в соответствующие группы для работы с виртуализацией:

      `sudo usermod -aG libvirt $USER sudo usermod -aG kvm $USER`

Для проверки успешности установки и настройки можно использовать команду:

      `virsh list --all`

Эта команда должна вывести пустой список виртуальных машин без сообщений об ошибках. Для применения изменений, связанных с добавлением пользователя в группы, необходимо выйти из системы и выполнить повторный вход.

##### Больше материалов на тему виртуализации:

- [Магия виртуализации: вводный курс в Proxmox VE](https://selectel.ru/blog/magic-of-virtualization-intro/)
- [Работа с публичным облаком в привычной платформе виртуализации](https://selectel.ru/blog/selectel-vmware-cloud/)
- [Гипервизор: что это такое, роль в виртуализации, типы и сравнение](https://selectel.ru/blog/what-is-hypervisor/)

## Использование утилиты qemu-system

Утилита qemu-system представляет собой основной инструмент для создания и управления виртуальными машинами в QEMU. Она поддерживает различные архитектуры процессоров и позволяет гибко настраивать параметры виртуальной среды. Для работы с конкретной архитектурой используется соответствующая версия утилиты, например qemu-system-x86_64 для 64-битных систем x86.

Базовый синтаксис запуска виртуальной машины выглядит следующим образом:

      `qemu-system-x86_64 [опции] [образ_диска]`

Для создания простой виртуальной машины с минимальными параметрами можно использовать команду:

      `qemu-system-x86_64 -m 2G -hda образ_диска.qcow2`

Основные параметры для настройки виртуальной машины включают:

      `-m       # Указывает объем выделяемой памяти (например, -m 4G для 4 ГБ) -smp       # Задает количество процессорных ядер (например, -smp 4) -hda       # Подключает основной жесткий диск -cdrom    # Подключает образ CD/DVD -boot     # Определяет порядок загрузки (d - CD-ROM, c - диск)`

Для более сложных конфигураций можно использовать дополнительные опции:

      `-net nic         # Создает сетевой интерфейс -net user        # Настраивает пользовательскую сеть -vga std        # Выбирает тип видеокарты -display sdl    # Указывает способ отображения графики`

Пример запуска виртуальной машины с установочным образом ОС:

      `qemu-system-x86_64 -m 4G -smp 2 -hda vm_disk.qcow2 -cdrom ubuntu.iso -boot d`

Для работы с ускорением KVM необходимо добавить параметр:

      `-enable-kvm`

Полный список доступных опций можно просмотреть с помощью команды:

      `qemu-system-x86_64 --help`

Для сохранения параметров запуска рекомендуется создавать shell-скрипты или использовать более продвинутые системы управления виртуализацией, такие как libvirt.

## Эмуляция архитектуры

Одной из ключевых особенностей QEMU является способность эмулировать различные процессорные архитектуры, что делает этот инструмент незаменимым для кросс-платформенной разработки и тестирования. В отличие от большинства решений виртуализации, ограниченных родной архитектурой хоста, QEMU поддерживает эмуляцию ARM, MIPS, PowerPC, RISC-V и многих других процессоров на x86-системах и наоборот.

Для работы с различными архитектурами используются соответствующие варианты утилиты qemu-system:

      `qemu-system-arm        # Для ARM-архитектуры qemu-system-mips       # Для MIPS qemu-system-ppc        # Для PowerPC qemu-system-riscv      # Для RISC-V qemu-system-x86_64     # Для 64-битных x86-систем`

Базовый синтаксис запуска эмуляции отличается от родной архитектуры необходимостью указания конкретной машины (модели устройства) через параметр -M:

      `qemu-system-arm -M  [опции]`

Для просмотра списка поддерживаемых моделей устройств для конкретной архитектуры используйте:

      `qemu-system-arm -M help`

Пример запуска эмуляции Raspberry Pi (модель versatilepb):

      `qemu-system-arm -M versatilepb -kernel zImage -dtb versatile-pb.dtb -drive file=rootfs.ext2,if=scsi -append "root=/dev/sda2" -net nic -net user`

Особенности работы с различными архитектурами:

- Для ARM часто требуется явное указание ядра (опция -kernel) и device tree (опция -dtb)
- При эмуляции MIPS может потребоваться указание биоса (опция -bios)
- Для RISC-V необходимо использовать специальные образы firmware

Скорость эмуляции существенно зависит от:

- Разницы между хостовой и целевой архитектурами
- Использования динамической трансляции кода
- Наличия аппаратного ускорения (TCG)

Для повышения производительности рекомендуется:

- Использовать последнюю версию QEMU
- Указывать конкретную модель CPU через -cpu
- Оптимизировать параметры памяти и кэша

Пример комплексной команды для эмуляции ARM с оптимизацией:

      `qemu-system-arm -M vexpress-a9 -cpu cortex-a9 -m 1G -kernel zImage -dtb vexpress-v2p-ca9.dtb -drive file=rootfs.ext2,if=sd -append "console=ttyAMA0,115200 root=/dev/mmcblk0" -net nic -net user -nographic`

При работе с нестандартными архитектурами часто требуется:

- Специально подготовленные образы ядер
- Кастомные настройки device tree
- Дополнительные параметры инициализации (-append)
- Точная настройка периферии через параметры -device

Для отладки эмуляции можно использовать опции:

      `-d in_asm          # Показывать трансляцию ассемблера -d cpu             # Выводить информацию о CPU -D logfile         # Сохранять лог в файл`

## qemu-img для работы с дисками

Утилита qemu-img является важным инструментом в составе QEMU, предназначенным для создания, конвертации и управления образами виртуальных дисков. Она поддерживает все популярные форматы виртуальных носителей и предоставляет широкие возможности для работы с ними.

Для создания нового образа диска используйте:

      `qemu-img create -f    # Пример создания диска в формате qcow2 размером 20ГБ qemu-img create -f qcow2 disk.qcow2 20G`

Поддерживаемые форматы включают:

- raw – простой бинарный формат
- qcow2 – основной формат QEMU с поддержкой снэпшотов
- vdi – формат VirtualBox
- vmdk – формат VMware
- vhdx – формат Hyper-V

Для получения информации об образе диска:

      `qemu-img info` 

Чтобы изменить размер существующего образа, выполните:

      `qemu-img resize  [+] # Пример увеличения диска на 5ГБ qemu-img resize disk.qcow2 +5G`

Для конвертации между различными форматами:

      `qemu-img convert -f  -O`   

Для создания снэпшота существующего образа:

      `qemu-img snapshot -c`  

Список снэпшотов можно просмотреть командой:

      `qemu-img snapshot -l` 

Для проверки целостности образа диска:

      `qemu-img check` 

Особенности работы с qcow2:

- Поддержка сжатия (-c)
- Возможность шифрования (-o encryption)
- Поддержка различных кластерных размеров (-o cluster_size)
- Возможность указания базового образа (-b)

Пример создания сжатого qcow2 образа:

      `qemu-img create -f qcow2 -o compression_type=zlib compressed.qcow2 10G`

Для восстановления поврежденного образа можно использовать:

      `qemu-img amend -f qcow2 -O qcow2 поврежденный.qcow2 исправленный.qcow2`

При работе с qemu-img важно учитывать:

- Формат образа влияет на производительность
- Некоторые операции требуют значительного времени
- Размер образа может отличаться от фактического занимаемого места
- Для некоторых операций требуются права root

## qemu-io для ввода и вывода на диски

Утилита qemu-io представляет собой интерактивный инструмент командной строки для выполнения низкоуровневых операций чтения и записи на виртуальные диски. Этот инструмент особенно полезен для отладки, тестирования производительности и проверки целостности образов дисков.

Базовый синтаксис запуска:

      `qemu-io [опции]` 

Основные опции запуска:

      `-f     # Указание формата диска (qcow2, raw и др.) -c    # Выполнение одной команды без входа в интерактив -r             # Открыть диск только для чтения`

Пример проверки диска без входа в интерактивный режим:

      `qemu-io -f qcow2 -c "read 0 512" disk.qcow2`

Основные команды в интерактивном режиме:

      `# 1. Операции чтения read     # Чтение данных с диска # Пример чтения 512 байт с нулевого смещения read 0 512  # 2. Операции записи write   [данные]  # Запись данных на диск # Пример записи тестовых данных write 0 512 "test data"  # 3. Проверка производительности aio_read     # Асинхронное чтение aio_write    # Асинхронная запись  # 4. Управление кэшем flush   # Сброс кэша на диск  #5. Получение информации info    # Показать информацию о диске`

Пример тестирования производительности:

      `qemu-io -f qcow2 -c "aio_write 0 1M" -c "aio_read 0 1M" disk.qcow2`

Для работы с разными форматами данных:

      `-t    # Указание типа данных (hex, base64)`

Пример работы с hex-данными:

      `write -t hex 0 10 48656c6c6f576f726c64`

Дополнительные полезные команды:

      `discard    # Освобождение пространства truncate           # Изменение размера map                       # Показать занятые области`

Для выхода из интерактивного режима используйте:

      `quit`

Особенности работы с qemu-io:

- Все смещения указываются в байтах
- По умолчанию используется прямой доступ (без кэширования)
- Поддерживается работа с образами, защищенными паролем
- Можно тестировать различные режимы кэширования

Пример комплексного тестирования:

      `qemu-io -f qcow2 disk.qcow2 &lt;&lt;EOF write 0 1M read 0 1M aio_write 1M 1M aio_read 1M 1M flush info quit EOF`

Примечания по безопасности:

- Операции записи могут повредить данные
- Рекомендуется работать с копиями образов
- Для критически важных данных используйте режим только для чтения (-r)

## Заключение

QEMU — это универсальный инструмент для виртуализации и эмуляции, который открывает широкие возможности: от запуска различных операционных систем до тестирования ПО на разных архитектурах. В этой статье мы рассмотрели ключевые аспекты работы с QEMU: установку, управление виртуальными машинами, работу с дисками и настройку эмуляции.