# Маршрутизация в Linux

Вы уже знаете, что все данные в сети передаются в виде пакетов, а чтобы компьютер знал куда нужно отправить тот или иной пакет используются IP адреса. Но пакету, перед тем, как он достигнет точки назначения нужно пройти множество компьютеров и маршрутизаторов.

Каждому из маршрутизаторов нужно знать на какой компьютер передавать пакет дальше.

## Сетевые маршруты в Linux

Сетевые маршруты необходимы чтобы компьютеры могли определить по какой цепочке должен пойти пакет, чтобы достигнуть цели. Маршруты можно настроить на уровне интерфейса или маршрутизатора.

Когда компьютеру нужно отправить пакет в сеть он смотрит таблицу маршрутизации, в ней указанны ip адреса пунктов назначения и адреса интерфейсов и роутеров в домашней сети, которые могут отправить пакет по нужному адресу. Если для цели маршрут не указан то используется так называемый шлюз по умолчанию или маршрут по умолчанию. Точно такая же картина наблюдается на роутере. Устройство смотрит на IP адрес назначения и сверяет его со своей таблицей маршрутизации, а потом отправляет дальше.
Ниже мы рассмотрим как проверить текущие маршруты в системе, а также как настроить новые.
Самый удобный способ посмотреть таблицу маршрутизации linux - это команда ip:
__ip route__
пример вывода
default via 192.168.1.1 dev enp2s0 proto static metric 100

что вывод команды можно использовать в качестве аргумента для __ip route add__ или __ip route del__. Это очень удобно. Как вы видите, в качестве шлюза по умолчанию везде используется 192.168.1.1. Рассмотрим подробнее что означает вывод этой команды:
__default__ - в данной строке означает вариант по умолчанию. Здесь должен быть ip адрес цели или маска подсети;
__via 192.168.1.1__ - указывает через какой шлюз мы можем добраться до этой цели, у нас это 192.168.1.1;
__dev enp2s0__ - сетевой интерфейс, с помощью которого будет доступен этот шлюз;
__proto static__ - означает, что маршрут был установлен администратором, значение __kernel__ значит что он был установлен ядром;
__metric__ - это приоритет маршрута, чем меньше значение - тем выше приоритет.

## Настройка маршрутов в Linux

Вы можете настраивать таблицу маршрутизации с помощью команды ip. Например, чтобы изменить маршрут по умолчанию достаточно выполнить:
__ip route add default via 192.168.1.1__

Так вы можете добавить маршрут для любого IP адреса, например, для 243.143.5.25:
__sudo ip route add 243.143.5.25 via 192.168.1.1__

Все очень просто, сначала указывается IP адрес цели, а затем шлюз в локальной сети, через который можно достичь этого адреса. Но такие маршруты будут активны только до перезагрузки, после перезагрузки компьютера они будут автоматически удалены. Чтобы маршруты сохранились их нужно добавить в файл конфигурации.

В операционных системах семейства Red Hat используются конфигурационные файлы __/etc/sysconfig/network-scripts/route-ethX__. Каждый файл может описывать несколько маршрутов, например:
GATEWAY=10.10.0.1
NETMASK=255.0.0.0
IPADDR=10.10.0.22

Здесь gateway - шлюз по умолчанию для этого интерфейса, netmask - маска сети, а ipaddr - ip адрес интерфейса. В Debian и основанных на нем дистрибутивах можно настроить маршруты в файле __/etc/network/interfaces__. Здесь команда route добавляется в секцию iface. Например:

__up route add -net 10.10.0.0 netmask 255.0.0.0 gw 10.10.0.1__
С помощью опции -net мы указываем целевую сеть, netmask - это маска сети, а gw - шлюз. Все очень просто. Теперь добавленные маршруты останутся даже после перезагрузки.

## Примеры

Предположим, что мы только что добавили новую сетевую карту на этот компьютер. Мы набираем следующее и видим, что он отображается как enp0s8:
__ip link show__

Мы добавим новый маршрут к компьютеру, чтобы использовать этот новый интерфейс. Сначала мы вводим следующее, чтобы связать IP-адрес с интерфейсом:
__sudo ip addr add 192.168.121.1/24 dev enp0s8__

Маршрут по умолчанию с использованием существующего IP-адреса добавляется в новый интерфейс. Мы используем опцию delete и указываем его свойства, как показано ниже, чтобы удалить маршрут по умолчанию:
__sudo ip route delete default via 192.168.4.1 dev enp0s8__

Теперь мы будем использовать опцию add, чтобы добавить наш новый маршрут. Новый интерфейс будет обрабатывать сетевой трафик в диапазоне IP-адресов 192.168.121.0/24. Мы дадим ему метрику 100; потому что это будет единственный маршрут, обрабатывающий этот трафик, метрика в значительной степени академическая.

Мы вводим следующее:
__sudo ip route add 192.168.121.0/24 dev enp0s8 metric 100__

Теперь мы набираем следующее, чтобы увидеть, что мы получили в конечном счёте:
__ip route__

Наш новый маршрут уже на месте. Однако у нас все ещё есть маршрут 192.168.4.0/24, который указывает на интерфейс enp0s8 — мы набираем следующее, чтобы удалить его:
__sudo ip route delete 192.168.4.0/24 dev enp0s8__

Теперь у нас должен быть новый маршрут, который направляет весь трафик, предназначенный для диапазона IP 192.168.121.0/24, через интерфейс enp0s8. Это также должен быть единственный маршрут, который использует наш новый интерфейс.
Мы вводим следующее для подтверждения:
__ip route__