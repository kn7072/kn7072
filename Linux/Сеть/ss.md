https://blog.sedicomm.com/2018/03/28/komanda-ss-s-primerami-otobrazhenie-informatsii-o-seti-sokete-tcp-udp-v-linux/
https://losst.ru/monitoring-setevyh-podklyuchenij-v-linux

# ss
Команда ss — это инструмент, используемый для вывода сетевой статистики в виде, похожем на тот, который выдаёт команда netstat. Однако, ss делает это проще и быстрее, чем netstat. Кроме того, ss даёт более подробные сведения о TCP-подключениях и о состояниях соединений, чем большинство других инструментов. В частности, ss может выводить данные о таких сущностях, как PACKET, TCP, UDP, DCCP, RAW, и сокеты домена Unix. Команда ss проще, чем netstat. для того, чтобы в этом убедиться, достаточно сравнить страницы man этих двух инструментов. С помощью ss можно получить весьма подробные сведения о том, как машина, работающая под управлением Linux, обменивается данными с другими компьютерами. Всё это открывает возможности по диагностике и устранению различных сетевых ошибок.

## Общая информация

Как уже было сказано работает утилита ss в Linux на основе подсистемы ядра. Синтаксис очень простой - сама команда и ее опции:

__$ ss опции [фильтр_состояния] [фильтр_адреса]__

Для удобства вывод команды ss можно фильтровать с помощью grep:

__$ ss опции | grep шаблон__

Опции указывает различные параметры отображения и фильтрации информации. Фильтры по состоянию и адресу очень интересная вещь, они позволяют выполнять мониторинг сетевых подключений в Linux, только тех что нужно. Например, только открытых, закрытых или находящихся на этапе подключения. Подробнее мы рассмотрим это в конце статьи.

## Опции утилиты ss

Для сетевых подключений в Linux с помощью утилиты ss можно использовать такие опции:

    -V - Version показать версию утилиты.
    -n - Numeric не определять имена служб.
    -r - Resolve определять сетевые имена адресов с помощью DNS.
    -a - All отобразить все сокеты (открытые соединения).
    -l - Listening показать только прослушиваемые сокеты.
    -o - Options показать информацию таймера.
    -e - Extended выводить расширенную информацию о сокете.
    -m - показать использование памяти сокета
    -p - Processes, показать процессы, использующие сокет.
    -i - Internal, посмотреть внутреннюю информацию TCP.
    -s - Summary, статистика использования сокета.
    -D - экспортировать текущее состояние TCP сокетов в файл.
    -F - работать с информацией, взятой из файла.

Кроме того, можно вывести сокеты только нужного протокола:

    -4, --ipv4 - только сокеты протокола IP версии 4.
    -6 --ipv6 - только сокеты протокола IP версии 6.
    -0, --packet - только PACKET сокеты.
    -t, --tcp - TCP сокеты.
    -u, --udp - UDP сокеты.
    -d, --dhcp - DHCP сокеты.
    -r, --raw - RAW сокеты.
    -x, --unix - UNIX сокеты.

Для фильтрации протоколов можно использовать не только эти опции, но и универсальную опцию -f, передав ей в параметре название протокола. Здесь собраны самые основные опции, если вам нужно больше информации - смотрите справку команды.

## Примеры использования

-  Если запустить ss без аргументов командной строки или опций, она выведет полный список работающих соединений.

-  Посмотрим только TCP соединения:
    __sudo ss -t__ или __sudo ss -f tcp__

-  Теперь только Unix:
    __sudo ss -x__ или __sudo ss -xa__

-  Для отображения UDP сокетов используйте опцию u. По умолчанию будут показаны только подключенные соединения. Если хотите получить все, нужно использовать опцию __a__. Поскольку UDP, это протокол без постоянного соединения, то без опции __-a__ мы ничего не увидим:
    __sudo ss -ua__    

-  По умолчанию утилита не пытается определять имена хостов через dns, но можно ее попросить делать это опцией __-r__
    __sudo ss -tr__

-  Обратная опция __-n__, не будет выполняться не только dns резолвинг, но и определение протоколов портов, зато мониторинг сети в Linux работать будет быстрее:
    __sudo ss -tn__

-   Теперь просмотрим только прослушиваемые tcp сокеты.
    __sudo ss -tl__
    Здесь мы видим только имена служб, это не всегда удобно, указав опцию __n__, мы получим номера портов. Так же само можно посмотреть прослушиваемые udp сокеты:
    __sudo ss -tun__

-  Также мы можем попытаться узнать название и PID процесса, использующего сокет:
    __sudo ss -ltp__

-  Для просмотра статистики по использованию сетевых подключений наберите:
    __sudo ss -s__

-  С помощью опции __-о__ можно посмотреть информацию о таймере и состоянии подключения.
    __sudo ss -to__

-  Фильтрация по протоколу
    __sudo ss -tl -f inet4__ или __sudo ss -tl4__, или для ipv6 __sudo ss -tl6__

-  Фильтрация по состоянию соединения
    В синтаксисе команды мы описали два дополнительных параметра. Фильтрация состояния и фильтрация по адресу. Рассмотрим теперь как ими пользоваться. Сокет TCP может находиться в одном из нескольких состояний. Например, так утилита ss linux выведет только подключенные сокеты.
    __ss -t4 state established__
    или сокеты в состоянии ожидания __sudo ss -t4 state time-wait__

    Введите следующую команду, чтобы увидеть закрывающие сокеты:
    __sudo ss -4 state closing__

    В параметр state можно передать одно из следующих значений:
    - established
    - syn-sent
    - syn-recv
    - fin-wait-1
    - fin-wait-2
    - time-wait
    - closed
    - close-wait
    - last-ack
    - closing
    - all  - все состояния
    - connected - все кроме прослушиваемых и закрытых
    - synchronized - все кроме syn-sent
    - bucket -  time-wait и syn-recv
    - big - все кроме bucket
    Не все состояния подключений можно увидеть просто выполнив команду. Например, syn-sent и syn-recv вряд ли получиться словить, потому что соединения находятся в этом состоянии очень короткое время. Для их отображения удобно использовать команду watch:

    __watch -n 1 "ss -t4 state syn-sent"__

    После запуска команды откройте любой сайт в браузере. Вы увидите как появится одно или несколько соединений на несколько секунд.

-  Фильтрация по адресу и номеру порта
    Кроме фильтрации по состоянию, tcp сокеты можно фильтровать по адресам или портам соединений.

    Например, отберем все сетевые подключения linux с портом источником(удаленный порт dport) или приемником(локальный порт sport) ssh, то есть все входящие и исходящие соединения ssh:
    __ss -at '( dport = :ssh or sport = :ssh )'__
    Или сокеты с портом назначения 80 или 443:
    __ss -nt '( dst :443 or dst :80 )'__

    Такой синтаксис тоже будет работать:
    __ss -nt dst :443 or dst :80__

    Еще несколько примеров фильтрации:
    Фильтрация по адресу(Показать все порты, подключенные с удаленного 74.125.236.178):
    Одно из полезных применений ss заключается в том, чтобы получать с помощью этой команды сведения по соединениям, установленных с неких IP-адресов. Предположим, нужно выяснить, подключена ли машина, скажем, с IP-адресом 74.125.236.178 к нашему серверу, и если это так — узнать об этом подробности. Для решения этой задачи подойдёт такая команда:
    __ss -nt dst 74.125.236.178__

    Узнайте о подключении удаленного клиента с  123.1.2.100:http к нашим локальным виртуальным серверам:
    __ss dst 123.1.2.100:http__

    Фильтрация по адресу и подсети:
    __ss -nt dst 74.125.236.178/16__

    И по адресу и порту:
    __ss -nt dst 74.125.236.178:80__

    Если вы хотите фильтровать сетевые соединения по порту, перед портом ставьте двоеточие:
    __ss -nt dport = :80__

    Показать все установленные соединения SMTP
    __ss -o state established '( dport = :smtp or sport = :smtp )'__

    Показать все установленные HTTP-соединения
    __ss -o state established '( dport = :http or sport = :http )'__

    Найти все локальные процессы, подключенные к X-серверу
    __ss -x src /tmp/.X11-unix/*__

    Узнать все ips, связанные с ip-адресом nixcraft.com. 75.126.153.214 ###
    Показать все порты, подключенные к локальным 75.126.153.214 ##
    ss src 75.126.153.214

    http (80) port only
    __ss src 75.126.153.214:http__
    __ss src 75.126.153.214:80__

    smtp (25) port only
    __ss src 75.126.153.214:smtp__
    __ss src 75.126.153.214:25__

    Вывести список всех сокетов TCP в состоянии FIN-WAIT-1
    Выведите все сокеты TCP в состоянии -FIN-WAIT-1 для нашего httpd в сети 202.54.1/24 и посмотрите на их таймеры:
    __ss -o state fin-wait-1 '( sport = :http or sport = :https )' dst 202.54.1/24__

    Можно использовать такие операторы сравнения:

    <= или le - меньше или ровно порту.
    >= или ge - больше или ровно порту.
    == или eq - точное соответствие.
    != или ne - не равно.
    < или gt - меньше.
    > или lt - больше.
