https://blog.sedicomm.com/2017/05/30/tcpdump-poleznoe-rukovodstvo-s-primerami/
https://www.tcpdump.org/index.html

Утилита tcpdump - это очень мощный и популярный инструмент для перехвата и анализа сетевых пакетов. Она позволяет просматривать все входящие и исходящие из определенного интерфейса пакеты и работает в командной строке.

# Команда tcpdump

Перед тем как перейти к примерам работы с утилитой, давайте рассмотрим ее синтаксис и основные опции. Команда имеет такой синтаксис:

__$ tcpdump опции -i интерфейс фильтры__

При вызове обязательно нужно передать интерфейс, который будете отслеживать. Если интерфейс не указать, то будет использован первый в списке. Опции настраивают отображение и основные возможности утилиты, а фильтры позволяют отсеять ненужные пакеты. А теперь рассмотрим основные опции:

    -A - выводить все пакеты в формате ASCII;
    -c - закрыть программу после перехвата n-ого количества пакетов;
    -C - при записи пакетов в файл, проверять размер файла, и если он больше заданного - создать новый файл;
    -D - вывести список доступных сетевых интерфейсов;
    -e - выводить информацию уровня соединения для каждого пакета, это может быть полезно, например, для отображения MAC адреса;
    -f - выводить доменное имя для ip адресов;
    -F - читать пакеты из файла, а не интерфейса;
    -G - создавать новый файл лога через указанный промежуток времени;
    -H - обнаруживать заголовки 802.11s;
    -i - имя интерфейса для перехвата пакетов. Вы можете захватывать пакеты со всех интерфейсов, для этого укажите any ;
    -I - переключить интерфейс в режим монитора для захвата всех проходящих пакетов;
    -j - установить формат Timestamp для записи пакетов;
    -J - посмотреть доступные Timestamp;
    -K - не проверять контрольные суммы пакетов;
    -l - добавить поддержку прокрутки к выводу;
    -L - вывести поддерживаемые протоколы подключения для интерфейса;
    -n - не отображать доменные имена;
    -nn - выводить IP-адреса вместе с номерами портов, а не имена хостов с названиями протоколов;
    -r - прочитать пакеты из файла, созданного с помощью -w;
    -v, -vv, -vvv - более подробный вывод;
    -q - выводить минимум информации;
    -t - отключить вывод метки времени для всех строк;
    -tttt - включает для каждой из строк отображение временных меток в формате по умолчанию;
    -w - записать вывод в файл;
    -Z - пользователь, от имени которого будут создаваться файлы.
    -E - произвести расшифровку трафика IPSEC, отдав ключ шифрования.
    -X - отображать данные пакета одновременно в шестнадцатеричной и в ASCII кодировках;
    -XX - аналог -X, который также выводит ethernet header;

Это не все опции, но их вам будет вполне достаточно для решения большинства задач. Чаще мы будем применять фильтры. С помощью фильтров вы можете отсеивать только те типы пакетов, которые хотите видеть. Вы можете фильтровать по ip адресу, протоколу, сети, интерфейсу и многим другим параметрам. Но фильтры tcpdump мы будем рассматривать уже на примерах.

- посмотреть какие сетевые интерфейсы вы можете использовать. Для этого запустите команду с опцией -D
    __sudo tcpdump -D__

- Начнем рассматривать примеры tcpdump с захвата трафика на интерфейсе eth0
    __sudo tcpdump -i eth0__

    Чтобы остановить работу команды нажмите Ctrl+C. В выводе вы сразу же увидите все перехваченные пакеты. Формат записи для каждого пакета будет выглядеть следующим образом:

    13:03:41.795599 IP udp032919uds.hawaiiantel.net.6881 > 192.168.1.2.52055: Flags [.], seq 640160396:640161844, ack 436677393, win 2050, options [nop,nop,TS val 3805626438 ecr 4677385], length 1448

    Подробность вывода информации можно контролировать с помощью опций __-v__, Например:
    __sudo tcpdump -v -i eth0__
    Здесь уже появляется информация о протоколе IP:
    IP (tos 0x0, ttl 64, id 50309, offset 0, flags [DF], proto TCP (6), length 64)

## Понимание вывода tcpdump
https://routerus.com/tcpdump-command-in-linux/
tcpdump выводит информацию для каждого захваченного пакета в новой строке. Каждая строка включает метку времени и информацию об этом пакете в зависимости от протокола.

Типичный формат строки протокола TCP выглядит следующим образом:
[Timestamp] [Protocol] [Src IP].[Src Port] > [Dst IP].[Dst Port]: [Flags], [Seq], [Ack], [Win Size], [Options], [Data Length]

Пойдем по полю и объясним следующую строку:
__15:47:24.248737 IP 192.168.1.185.22 > 192.168.1.150.37445: Flags [P.], seq 201747193:201747301, ack 1226568763, win 402, options [nop,nop,TS val 1051794587 ecr 2679218230], length 108__

- 15:47:24.248737 — 15:47:24.248737 метка захваченного пакета 15:47:24.248737 по местному времени и использует следующий формат: hours:minutes:seconds.frac , где frac — доли секунды с полуночи.
- IP — пакетный протокол. В данном случае IP означает Интернет-протокол версии 4 (IPv4).
- 192.168.1.185.22 — IP-адрес и порт источника, разделенные точкой ( . ).
- 192.168.1.150.37445 — IP-адрес и порт назначения, разделенные точкой ( . ).
- Flags [P.] — поле TCP Flags. В этом примере [P.] означает пакет подтверждения push, который используется для подтверждения предыдущего пакета и отправки данных. Другие типичные значения поля флага следующие:

    [.] — ACK (подтверждение)
    [S] — SYN (Начать соединение)
    [P] — PSH (Push-данные)
    [F] — FIN (Завершить соединение)
    [R] — RST (сбросить соединение)
    [S.] — SYN-ACK (пакет SynAcK)
- seq 201747193:201747301 — Порядковый номер находится в seq 201747193:201747301 first:last . Он показывает количество данных, содержащихся в пакете. За исключением первого пакета в потоке данных, где эти числа являются абсолютными, все последующие пакеты используются как относительные позиции байтов. В этом примере номер 201747193:201747301 , что означает, что этот пакет содержит байты от 201747193 до 201747301 потока данных. Используйте параметр -S для вывода абсолютных порядковых номеров.
- ack 1226568763 Номер подтверждения — это порядковый номер следующих данных, ожидаемых на другом конце этого соединения.
- win 402 — Номер окна — это количество доступных байтов в приемном буфере.
- options [nop,nop,TS val 1051794587 ecr 2679218230] — параметры TCP. nop , или «нет операции» — это заполнение, используемое для того, чтобы сделать заголовок TCP кратным 4 байтам. TS val — это временная метка TCP, а ecr — эхо-ответ. Посетите документацию IANA для получения дополнительной информации о параметрах TCP.
- length 108 — длина данных полезной нагрузки

## Примеры

- После опций вы можете указывать фильтры для пакетов. Вот основные параметры, по которым можно отсеивать пакеты:

    host - имя хоста;
    ip - ip адрес;
    proto - протокол;
    net - адрес сети или подсети;
    port - адрес порта;
    src - параметр, касающийся отправителя;
    dst - параметр, касающейся получателя;
    Доступны такие протоколы: ether, fddi, tr, wlan, ip, ip6, arp, rarp, decnet, tcp и udp.
    Вы можете все это комбинировать между собой, чтобы получить желаемый результат.     

- Рассмотрим более детально на примерах. Отсеем только пакеты, адресованные нашему компьютеру:
    __sudo tcpdump -i eth0 ip dst 192.168.1.2__

- Также мы можем отобрать пакеты, отправляемые на определенный узел:
    __sudo tcpdump -i eth0 dst host google-public-dns-a.google.com__
    Как видите, это DNS пакеты и здесь вместо флагов TCP содержится полезная информация, запрос ip адреса хоста.

- Фильтрация по источнику и назначению
    Вы также можете фильтровать пакеты на основе порта или хоста источника или назначения, используя квалификаторы __src__ , __dst__ , __src and dst__ , а также __src or dst__ .
    Следующая команда захватывает приходящие пакеты от хоста с IP 192.168.1.185:  
    __sudo tcpdump -n src host 192.168.1.185__  
    Чтобы найти трафик, поступающий из любого источника на порт 80, вы должны использовать:
    __sudo tcpdump -n dst port 80__

- Также вы можете выбрать ответные пакеты от определенного хоста:
    __sudo tcpdump -i eth0 src host google-public-dns-a.google.com__
    Здесь нет полного содержимого пакета, если вы хотите его получить нужно использовать опцию __-v__ или __-vv__:
    __sudo tcpdump -vv -i eth0 host dst google-public-dns-a.google.com__

- С помощью оператора __and__ вы можете объединить несколько фильтров в один:
    __sudo tcpdump -i eth0 dst host google-public-dns-a.google.com and src host google-public-dns-a.google.com__  
    Из операций объедения доступны and и or, также можно применять скобки для обозначения приоритета. Вам необязательно указывать host, во многих случаях достаточно src или dst, утилита сама поймет что имелось в виду. Точно такую же конструкцию можно использовать для портов. Например, мы можем отсеять все запросы или ответы к DNS (на порт 53):
    __sudo tcpdump -vv -i eth0 port 53__

    Точно такое же можно провернуть для http (порт 80):
    __sudo tcpdump -vv -i eth0 port 80__

    Естественно, тут тоже можно применять dst и src для более конкретных результатов. Вы можете фильтровать не один порт, а целый диапазон портов:
    __sudo tcpdump portrange 21-23__

- Вы можете указать количество пакетов для захвата с помощью опции -c . Например, чтобы захватить только десять пакетов, введите
    __sudo tcpdump -c 10__
    После захвата пакетов tcpdump остановится.

- несложно вывести весь трафик IP6 с помощью опции протокола.
    __tcpdump ip6__

- По умолчанию tcpdump выполняет обратное разрешение DNS для IP-адресов и переводит номера портов в имена. Используйте параметр -n чтобы отключить перевод:
    __sudo tcpdump -n__
    Пропуск поиска DNS позволяет избежать генерации трафика DNS и делает вывод более читаемым. __Рекомендуется использовать эту опцию всякий раз, когда вы вызываете tcpdump__.

- Вместо отображения вывода на экране вы можете перенаправить его в файл с помощью операторов перенаправления > и >> :
    __sudo tcpdump -n -i any > file.out__
    Вы также можете просматривать данные при сохранении в файл с помощью команды tee :
    __sudo tcpdump -n -l | tee file.out__
    Параметр __-l__ в приведенной выше команде сообщает tcpdump о необходимости буферизации выходной строки. Если этот параметр не используется, вывод не будет записан на экране при создании новой строки.    

- Если указать один из протоколов, вы отфильтруете только пакеты этого протокола, например tcp, udp или arp:
    __sudo tcpdump -vv arp__  
    
    Точно также можно выбрать все udp пакеты:
    __sudo tcpdump -vv udp__ __sudo tcpdump -vv -n udp__
    
    Следующая команда отфильтрует протокол номер 17 и выдаст тот же результат, что и приведенный выше:
    __sudo tcpdump -n proto 17__
    Для получения дополнительной информации о числах проверьте список(https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers)

    Также доступен фильтр по обозначению сети:
    __sudo tcpdump net 129.168.1.1/24__
    Вы также можете фильтровать вывод по заданному диапазону IP-адресов, используя квалификатор __net__ . Например, чтобы выгрузить только пакеты, относящиеся к 10.10.0.0/16 вы должны использовать:
    __sudo tcpdump -n net 10.10__
    
    Кроме того, вы можете фильтровать пакеты по их размеру, например, меньше 32 байт:
    __sudo tcpdump less 32__ или больше 128: __tcpdump greater 128__

- Фильтрация по хосту
    Чтобы захватить только пакеты, относящиеся к определенному хосту, используйте квалификатор host :
    __sudo tcpdump -n host 192.168.1.185__
    Хостом может быть IP-адрес или имя.

- Иногда бывает необходимо сохранить захваченный трафик в файл, для этого используется опция -w:
    __sudo tcpdump -i eth0 -w file.pcap__
    Этот файл можно открыть с помощью любой программы для чтения таких файлов, например, Wireshark. Чтобы открыть сохраненные в файл пакеты используйте опцию __-r__:
    __sudo tcpdump -r file.pcap__
    При захвате пакетов в течение длительного периода времени вы можете включить ротацию файлов. tcpdump позволяет создавать новые файлы и вращать файл дампа через указанный интервал времени или фиксированного размера. Следующая команда создаст до десяти файлов размером 200 file.pcap0 именами file.pcap0 , file.pcap1 и т. Д. Перед перезаписью старых файлов.
    __sudo tcpdump -n -W 10 -C 200 -w /tmp/file.pcap__

    После создания десяти файлов старые файлы будут перезаписаны.
    Обратите внимание, что запускать tcpdump только во время устранения неполадок.

    Если вы хотите запустить tcpdump в определенное время, вы можете использовать __cronjob__ . tcpdump не имеет возможности выйти через заданное время. Вы можете использовать команду timeout чтобы остановить tcpdump через некоторое время. Например, чтобы выйти через 5 минут, вы должны использовать
    __sudo timeout 300 tcpdump -n -w data.pcap__

- Остался еще один момент, на который стоит обратить внимание. Это формат отображения содержимого пакетов. Вы можете вывести содержимое пакета в формате ASCII используйте опцию __-A__:
    __sudo tcpdump -A -i eth0__
    Также вы можете отобразить содержимое в формате HEX и ASCII для этого используйте __-XX__:
    __sudo tcpdump -XX -i eth0__

- Предположим, что нам нужно вывести трафик из 192.168.0.1 до любого хоста на порте 8000.
    __tcpdump -nnvvS src 192.168.0.1 and dst port 8000__    

- Или же нам может понадобится найти весь трафик из 192.168.x.x, направляющийся в сети 10.x или 172.16.x.x. Кроме того, попробуем указать шестнадцатеричный формат вывода и не указывать имена хостов. И добавим уровень дополнительной детализации.
    __tcpdump -nvX src net 192.168.0.0/16 and dst net 10.0.0.0/8 or 172.16.0.0/16__

- Следующий пример позволит вывести весь трафик из 192.168.0.2, не являющийся ICMP.
    __tcpdump dst 192.168.0.2 and src net and not icmp__
    А такая комбинация позволит отобразить трафик, кроме SSH (22 порта).
    __tcpdump -vv src mars and not dst port 22__

## Спецсимволы и комплексное группирование

Стоит отметить, что в сложных запросах обычно приходится комбинировать различные опции внутри одинарных кавычек. Эти символы дают понять tcpdump, что отдельные спец символы нужно игнорировать. Однако так же можно группировать и выражения, включая хост, порт, сеть и т.д. Следующий пример показывает команду, не использующую одинарные кавычки.
__tcpdump src 10.0.2.4 and (dst port 3389 or 22)__

Однако наличие скобок приведет к тому, что выполнение команды вернет ошибку. Решить проблему можно, поставив перед каждой из скобок \ или заключив команду в одинарные кавычки:
__tcpdump 'src 10.0.2.4 and (dst port 3389 or 22)'__

Отображение конкретных TCP-флагов

Трафик можно захватывать на основании конкретных TCP-флагов.
__tcpdump 'tcp[13] & 32!=0'__

Вывод пакетов ACKNOWLEDGE (ACK)
__tcpdump 'tcp[13] & 16!=0'__

Вывод пакетов PUSH (PSH)
__tcpdump 'tcp[13] & 8!=0'__

Вывод пакетов RESET (RST)
__tcpdump 'tcp[13] & 4!=0'__

Вывод пакетов SYNCHRONIZE (SYN)
__tcpdump 'tcp[13] & 2!=0'__

Вывод пакетов FINISH (FIN)
__tcpdump 'tcp[13] & 1!=0'__

Вывод пакетов SYNCHRONIZE / ACKNOWLEDGE (SYNACK)
__tcpdump 'tcp[13]=18'__
Примечание: лишь флаги PSH, RST, SYN и FIN присутствуют в соответствующем поле tcpdump. Безусловно, URG и ACK тоже отображаются, но не в поле flags.

- Столь многофункциональные инструменты предусматривают возможность выполнения одного действия несколькими способами. Вот еще один пример захвата пакетов по конкретному списку TCP-флагов.
__tcpdump 'tcp[tcpflags] == tcp-syn'__

Снятие флагов RST за счет tcpflags
__tcpdump 'tcp[tcpflags] == tcp-rst'__

Снятие флагов FIN за счет tcpflags
__tcpdump 'tcp[tcpflags] == tcp-fin'__
Примечание: данный метод подходит и для других флагов.

## Выявление трафика, заслуживающего особого внимания
Обычно есть несколько видов трафика, способы выявления которых обязательно нужно запомнить. Например, это могут быть неправильные либо предположительно вредоносные пакеты данных.

Поиск пакетов с нормальными комплектами RST и SYN
__tcpdump 'tcp[13] = 6'__

Открытый текст HTTP и запрос
__tcpdump 'tcp[32:4] = 0x47455420'__

SSH-соединения на конкретный порт (через баннер)
__tcpdump 'tcp[(tcp[12] >>2):4] = 0x5353482D'__

Пакеты С TTL < 10 (проблема или TRACEROUTE)
__tcpdump 'ip[8] < 10'__

Пакеты с установкой EVIL BIT
__tcpdump 'ip[6] & 128 != 0'__