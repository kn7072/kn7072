Команда `ausearch` является инструментом поиска по журналу аудита. `ausearch` может также принимать данные со стандартного ввода (stdin) до тех пор, пока на входе будут необработанные данные логов. Все условия, указанные в параметрах, объединяются логическим «И».

Каждый системный вызов ядра из пользовательского пространства и возвращение данных в пользовательское пространство имеет один уникальный (для каждого системного вызова) идентификатор события.

Различные части ядра могут добавлять дополнительные записи. Например, в событие аудита для системного вызова «open» добавляется запись PATH с именем файла. `ausearch` показывает все записи события вместе. Это означает, что при запросе определенных записей результат может содержать записи SYSCALL.

Не все типы записей содержат указанную информацию. Например, запись PATH не содержит имя узла или loginuid.

Синтаксис команды:

ausearch [опции]

**Опции команды ausearch**

|Опция|Описание|
|---|---|
|`-a, --event <идентификатор события>`|Искать события с заданным идентификатором события. В сообщении: _msg=audit(1116360555.329:2401771)_, идентификатор события — число после «:». Все события аудита, связанные с одним системным вызовом, имеют одинаковый идентификатор.|
|`--arch <CPU>`|Искать события на основе определенной архитектуры процессора. Для определения архитектуры необходимо использовать команду `uname –m`. В случае, если архитектура ПЭВМ неизвестна, необходимо использовать таблицу 32-х битных системных вызовов, если она поддерживается ПЭВМ, можно использовать b32. Аналогичным образом применяется таблица системных вызовов b64.|
|`-c, --comm <comm-name>`|Искать события с заданным «comm name», именем исполняемого файла из структуры задачи.|
|`--debug`|Вывести сообщения, пропущенные stderr.|
|`--checkpoint <файл контрольной точки>`|Контрольная точка — это вывод между последовательными вызовами ausearch, так что в последующих вызовах будут выводиться только события, не попавшие в предыдущий вывод.<br><br>Событие auditd состоит из одной или нескольких записей. При обработке события ausearch определяет события как завершенные и незавершенные. Завершенное событие — это одно событие записи или то, которое произошло раньше, чем за две секунды по сравнению с текущим обрабатываемым событием. Контрольная точка обеспечивается путем записи последнего завершенного события вывода вместе с номером устройства и индексом файла последнего завершившегося события в файл контрольной точки. При следующем вызове ausearch загрузит данные контрольной точки и при обработке файлов журнала, будет отбрасывать все завершенные события, пока они не соответствуют контрольной точке, в этот момент ausearch начнет выводить события.

sudo ausearch --checkpoint /etc/audit/auditd_checkpoint.txt -i -k git
sudo ausearch --checkpoint /etc/audit/auditd_checkpoint.txt --start checkpoint -i -k git

|
|`-e, --exit <код>`|Искать события на основе кода системного вызова exit или errno.|
|`--escape <опция>`|Экранировать вывод. Возможные значения: raw, tty, shell и shell_quote. Каждый режим включает в себя символы предыдущего режима и экранирует больше символов. То есть shell включает все символы, экранируемые tty, и добавляет новые. Значение по умолчанию — tty.|
|`--extra-keys`|Если параметр `format` имеет значение csv, вывести столбец с дополнительной информацией.<br><br>Работает только с записями SYSCALL, которые были записаны в результате запуска правила аудита, определенного ключом.|
|`--extra-labels`|Если параметр `format` имеет значение csv, добавить информацию о метках субъекта и объекта (если метки существуют).|
|`--extra-obj2`|Если параметр `format` имеет значение csv, добавить информацию о втором объекте (если он существует). Второй объект иногда является частью записи, например, при переименовании файла или монтировании устройства.|
|`--extra-time`|Если параметр `format` имеет значение csv, добавить информацию о времени простоя.|
|`-f, --file <файл>`|Искать события с заданным именем файла.|
|`--format <опции>`|Отформатировать события, которые соответствуют критериям поиска. Поддерживаемые форматы: raw, default, interpret, csv и text. Значение raw описано в опции `raw`. При значении default строки выводятся без форматирования, в выводе используется одна строка в качестве визуального разделителя, далее указывается метка времени, а затем следуют записи события. Значение interpret объясняется в описании опции `-i`. При значении csv результат поиска выводится в формате CSV. Значение text преобразует вывод к формату предложений, что упрощает понимание вывода, но происходит это за счет потери деталей.|
|`-ga, --gid-all all-<идентификатор группы>`|Искать события с заданным эффективным или обычным идентификатором группы.|
|`-ge, --gid-effective <эффективный идентификатор группы>`|Искать события с заданным эффективным идентификатором группы или именем группы.|
|`-gi, --gid <группа>`|Искать события с заданным идентификатором группы или именем группы.|
|`-h, --help`|Справка|
|`-hn, --host <имя узла>`|Искать события с заданным именем узла. Имя узла может быть именем узла, полным доменным именем или цифровым сетевым адресом.|
|`-i, --interpret`|Транслировать числовые значения в текстовые. Например, идентификатор пользователя будет транслирован в имя пользователя. Трансляция выполняется с использованием данных с той машины, где запущена команда `ausearch`.|
|`-if, --input <файл>\|<каталог>`|Использовать указанный файл или каталог вместо логов аудита. Это может быть полезно при анализе логов с другой машины или при анализе частично сохраненных логов.|
|`--input-logs`|Использовать местоположение файла журнала из auditd.conf как исходные данные для анализа. Применяется при использовании команды `ausearch` в задании cron.|
|`--just-one`|Остановиться после выдачи первого события, соответствующего критериям поиска.|
|`-k, --key <ключевое слово>`|Искать события с заданным ключевым словом.|
|`-l, --line-buffered`|Сбрасывать вывод после каждой строки.|
|`-m, --message <тип>\|<список типов>`|Искать события с заданным типом, при этом можно указать список значений, разделенных запятыми. Можно указать несуществующий в событиях тип «ALL», который позволяет получить все сообщения системы аудита (список допустимых типов будет показан, если указать эту опцию без значения). Тип сообщения может быть строкой или числом. В списке значений этого параметра в качестве разделителя используются запятые и пробелы недопустимы.|
|`-n , --node`|Искать события с определенного узла. Допускается указание нескольких узлов (для вывода достаточно совпадение любого узла).|
|`-p, --pid <идентификатор процесса>`|Искать события с заданным идентификатором процесса.|
|`-pp, --ppid <идентификатор процесса>`|Искать события с заданным идентификатором родительского процесса.|
|`-r, --raw`|Необработанный вывод. Используется для извлечения записей для дальнейшего анализа.|
|`-sc, --syscall <системный вызов>`|Искать события с заданным системным вызовом. Можно указать номер или имя системного вызова. При указании имени системного вызова, оно будет проверено по таблице системных вызовов на машине, где запущена команда `ausearch`.|
|`--session <идентификатор сеанса>`|Искать события с заданным идентификатором сеанса. Этот атрибут устанавливается, когда пользователь входит в систему и может связать любой процесс с определенным именем пользователя.|
|`-sv, --success <флаг>`|Искать события с заданным флагом успешного выполнения. Допустимые значения: yes (успешно) и no (неудачно).|
|`-te, --end <дата> <время>`|Искать события, которые произошли раньше (или во время) указанной временной точки. Формат даты и времени зависит от региональных настроек. В случае если дата не указана, то подразумевается текущий день (today). В случае если не указано время, то подразумевается текущий момент (now).|
|`--ts, --start <дата> <время>`|Искать события, которые произошли после (или во время) указанной временной точки.|
|`-tm, --terminal <терминал>`|Искать события с заданным терминалом. Некоторые службы (такие как cron и atd) используют имя службы как имя терминала.|
|`-ua, --uid-all <идентификатор пользователя>`|Искать события, у которых любой из идентификатора пользователя, эффективного идентификатора пользователя или loginuid (auid) совпадают с заданным идентификатором пользователя.|
|`-ue, --uid-effective <эффективный идентификатор пользователя>`|Искать события с заданным эффективным идентификатором пользователя.|
|`-ui, --uid <идентификатор пользователя>`|Искать события с заданным идентификатором пользователя.|
|`-ul, --loginuid <идентификатор пользователя>`|Искать события с заданным идентификатором пользователя. Все программы, которые его используют, должны использовать pam_loginuid.|
|`-uu, --uuid <идентификатор гостя>`|Искать события с заданным идентификатором гостя.|
|`-v, --verbose`|Показать версию и выйти.|
|`--vm, --vm-name <имя гостя>`|Искать события с заданным именем гостя.|
|`-x, --executable <программа>`|Искать события с заданным именем исполняемой программы.|

Нотацию времени следует использовать в формате «24 часа», а не «AM/PM». Например, дата может быть задана как «10/24/2005», а время — как «18:00:00». Также допускается использовать следующие ключевые слова:

- `now` — сейчас;
    
- `recent` — десять минут назад;
    
- `boot` — время за секунду до того, когда система загружалась в последний раз;
    
- `today` — первая секунда после полуночи текущего дня;
    
- `yesterday` — первая секунда после полуночи предыдущего дня;
    
- `this-week` — первая секунда после полуночи первого дня текущей недели, первый день недели определяется из региональных настроек;
    
- `week-ago` — первая секунда после полуночи ровно 7 дней назад;
    
- `this-month` — первая секунда после полуночи первого числа текущего месяца;
    
- `this-year` — первая секунда после полуночи первого числа первого месяца текущего года.



пример
```
ausearch -i -k monitor_sshd_conf
```
```bash
----
type=CONFIG_CHANGE msg=audit(12/08/2021 20:24:38.290:13) : auid=itsecforu ses=3 subj==unconfined op=add_rule key=monitor_sshd_conf list=exit res=yes 
----
type=PROCTITLE msg=audit(12/08/2021 20:25:57.760:38) : proctitle=tee -a /etc/ssh/sshd_config 
type=PATH msg=audit(12/08/2021 20:25:57.760:38) : item=1 name=/etc/ssh/sshd_config inode=526305 dev=08:01 mode=file,644 ouid=root ogid=root rdev=00:00 nametype=NORMAL cap_fp=none cap_fi=none cap_fe=0 cap_fver=0 cap_frootid=0 
type=PATH msg=audit(12/08/2021 20:25:57.760:38) : item=0 name=/etc/ssh/ inode=523877 dev=08:01 mode=dir,755 ouid=root ogid=root rdev=00:00 nametype=PARENT cap_fp=none cap_fi=none cap_fe=0 cap_fver=0 cap_frootid=0 
type=CWD msg=audit(12/08/2021 20:25:57.760:38) : cwd=/home/itsecforu 
type=SYSCALL msg=audit(12/08/2021 20:25:57.760:38) : arch=x86_64 syscall=openat success=yes exit=3 a0=0xffffff9c a1=0x7fffe54487de a2=O_WRONLY|O_CREAT|O_APPEND a3=0x1b6 items=2 ppid=987 pid=988 auid=kifarunix uid=root gid=root euid=root suid=root fsuid=root egid=root sgid=root fsgid=root tty=pts1 ses=5 comm=tee exe=/usr/bin/tee subj==unconfined key=monitor_sshd_conf 
```
Из вывода отчета ausearch попробуем интерпретировать поля записей.

- type=PROCTITLE: Тип записи, который дает полную командную строку, вызвавшую это событие аудита.
- msg=audit(12/08/2021 20:24:38.290:13): Определяет метку времени и уникальный ID записи в форме audit(time_stamp:ID). Время обычно отображается в EPOCH, если вы не используете опцию -i.  
    Если время в EPOCH, например, 1638984357.760, то преобразуйте его с помощью команды date;


date -d @1638984357.760
```

```
Wed 08 Dec 2021 08:25:57 PM EAT
```

- proctitle=tee -a /etc/ssh/sshd_config: В поле записывается полная строка команды, которая была использована для вызова анализируемого процесса. Без опции -i она была бы отображена в шестнадцатеричном виде.
- type=PATH: тип записи PATH записывает путь, который передается системному вызову в качестве аргумента, в данном случае путь – /etc/ssh/sshd_config.
- item=1: поле item указывает, какой элемент из общего числа элементов, на которые ссылается запись типа SYSCALL, является текущим. значение 1 означает, что это второй элемент.
- name=/etc/ssh/sshd_config: Записывает путь к файлу или каталогу, который был передан системному вызову в качестве аргумента. В данном случае это был файл /etc/ssh/sshd_config.
- inode=526305: поле inode содержит номер inode, связанный с файлом или каталогом, записанным в этом событии. Следующая команда отображает файл или каталог, связанный с номером inode 526305:

```
find / -inum 526305 -print
```

```
/etc/ssh/sshd_config
```

- dev=08:01: Поле определяет минорный и мажорный идентификатор устройства, которое содержит файл или каталог, записанный в этом событии.
- mode=file,644: Поле mode записывает разрешения на файл или каталог, 644 означает -rw-r-r- для файла /etc/ssh/sshd_config.
- ouid=root: В поле ouid записывается идентификатор пользователя/имя пользователя владельца объекта.
- ogid=root: В поле ogid записывается идентификатор группы/имя пользователя владельца объекта.
- rdev=00:00: Поле rdev содержит записанный идентификатор устройства только для специальных файлов. В данном случае оно не используется, так как записанный файл является обычным файлом.
- nametype=NORMAL: записывает намерение операции каждой записи пути в контексте данного системного вызова.
- cap_fp=none: Поле cap_fp записывает данные, связанные с установкой разрешенной возможности объекта файла или каталога на основе файловой системы.
- cap_fi=none: В поле cap_fi записываются данные, связанные с установкой унаследованной возможности файловой системы объекта файла или каталога.
- cap_fe=0: В поле cap_fe записывается установка эффективного бита возможности объекта файла или каталога на основе файловой системы.
- cap_fver=0: В поле cap_fver записывается версия возможности объекта файла или каталога на основе файловой системы.
- type=CWD: записывает рабочий каталог, из которого выполнялся процесс, вызвавший системный вызов.
- cwd=/home/kifarunix: указывает каталог, в котором был вызван системный вызов.
- type=SYSCALL: указывает, что запись была вызвана системным вызовом ядра.
- arch=x86_64: Поле содержит информацию об архитектуре процессора системы. Если опция -i не используется с auseardh, значение отображается в шестнадцатеричной системе счисления.
- syscall=openat: В поле syscall записывается тип системного вызова, который был послан ядру. Если с ausearch используется опция -i, значения интерпретируются, в противном случае показываются числовые значения. Используйте команду ausyscall –dump, чтобы вывести список всех системных вызовов вместе с их номерами. Для получения дополнительной информации см. man ausyscall.
- success=yes: В поле success записывается, был ли системный вызов, записанный в данном событии, успешным или неудачным. В данном случае вызов прошел успешно.
- exit=3: Поле содержит значение, определяющее код завершения, возвращенный системным вызовом. Для разных системных вызовов это значение различно.
- a0=0xffffff9c a1=0x7fffe54487de a2=O_WRONLY|O_CREAT|O_APPEND a3=0x1b6: Поля a0 – a3 записывают первые четыре аргумента, закодированные в шестнадцатеричной системе счисления, системного вызова в данном событии. Эти аргументы зависят от используемого системного вызова.
- items=2: Поле items содержит количество вспомогательных записей PATH, которые следуют за записью системного вызова.
- ppid=987: В поле ppid записывается идентификатор родительского процесса (PPID).
- pid=988: В поле pid записывается идентификатор процесса (PID).
- auid=itsecforu: В поле auid записывается идентификатор пользователя аудита, то есть loginuid. Этот идентификатор присваивается пользователю при входе в систему и наследуется каждым процессом, даже если личность пользователя меняется, например, при смене учетной записи.
- uid=root: В поле uid записывается идентификатор пользователя, который запустил анализируемый процесс. Идентификатор пользователя может быть интерпретирован в имена пользователей при использовании опции -i с ausearch. Вы также можете интерпретировать с помощью следующей команды: ausearch -i -uid UID.
- gid=root: В поле gid записывается идентификатор группы пользователя, который запустил анализируемый процесс.
- euid=root: В поле euid записывается эффективный идентификатор пользователя, запустившего анализируемый процесс.
- suid=root: В поле suid записывается установленный идентификатор пользователя, запустившего анализируемый процесс.
- fsuid=root: В поле fsuid записывается идентификатор пользователя файловой системы пользователя, запустившего анализируемый процесс.
- egid=root: В поле egid записывается идентификатор эффективной группы пользователя, запустившего анализируемый процесс.
- sgid=root: В поле sgid записывается идентификатор установленной группы пользователя, запустившего анализируемый процесс.
- fsgid=root: В поле fsgid записывается идентификатор группы файловой системы пользователя, запустившего анализируемый процесс.
- tty=pts1: В поле tty записывается терминал, с которого был вызван анализируемый процесс.
- ses=5: В поле ses записывается идентификатор сессии, из которой был вызван анализируемый процесс.
- comm=tee: В поле comm записывается имя командной строки команды, которая была использована для вызова анализируемого процесса.
- exe=/usr/bin/tee: В поле exe записывается путь к исполняемому файлу, который был использован для вызова анализируемого процесса.
- subj=unconfined: В поле subj записывается контекст SELinux, которым был помечен анализируемый процесс во время выполнения.
- key=monitor_sshd_conf: В поле key записывается определяемая администратором строка, связанная с правилом, которое породило это событие в логах аудита.

----
type=CONFIG_CHANGE msg=audit(12/08/2021 20:24:38.290:13) : auid=kifarunix ses=3 subj==unconfined op=add_rule key=monitor_sshd_conf list=exit res=yes 
----
type=PROCTITLE msg=audit(12/08/2021 20:25:57.760:38) : proctitle=tee -a /etc/ssh/sshd_config 
type=PATH msg=audit(12/08/2021 20:25:57.760:38) : item=1 name=/etc/ssh/sshd_config inode=526305 dev=08:01 mode=file,644 ouid=root ogid=root rdev=00:00 nametype=NORMAL cap_fp=none cap_fi=none cap_fe=0 cap_fver=0 cap_frootid=0 
type=PATH msg=audit(12/08/2021 20:25:57.760:38) : item=0 name=/etc/ssh/ inode=523877 dev=08:01 mode=dir,755 ouid=root ogid=root rdev=00:00 nametype=PARENT cap_fp=none cap_fi=none cap_fe=0 cap_fver=0 cap_frootid=0 
type=CWD msg=audit(12/08/2021 20:25:57.760:38) : cwd=/home/itsecforu
type=SYSCALL msg=audit(12/08/2021 20:25:57.760:38) : arch=x86_64 syscall=openat success=yes exit=3 a0=0xffffff9c a1=0x7fffe54487de a2=O_WRONLY|O_CREAT|O_APPEND a3=0x1b6 items=2 ppid=987 pid=988 auid=itsecforu uid=root gid=root euid=root suid=root fsuid=root egid=root sgid=root fsgid=root tty=pts1 ses=5 comm=tee exe=/usr/bin/tee subj==unconfined key=monitor_sshd_conf

Видно, что:

- файл конфигурации SSH-сервера, /etc/ssh/sshd_config, был обновлен с помощью команды tee.
- Команда была выполнена из каталога /home/itsecforu.
- Изменения были внесены пользователем itsecforu от пользователя root (с помощью sudo).
