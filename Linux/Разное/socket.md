# Сокеты в ОС Linux (https://habr.com/ru/company/otus/blog/539550/)

[Ссылка на примеры socat](https://linux-notes.org/ustanovka-socat-v-unix-linux/)

Что такое сокет?

Сокет - это абстракция сетевого взаимодействия в операционной системе Linux. Каждому сокету соответствует пара IP-адрес + номер порта. Это стандартное определение, к которому привыкли все, спасибо вики. Хотя нет, вот здесь(https://en.wikipedia.org/wiki/Network_socket) лучше описано. Поскольку сокет является только лишь абстракцией, то связка IP-адрес + номер порта - это уже имплементация в ОС. Верное название этой имплементации - "Интернет сокет". Абстракция используется для того, чтобы операционная система могла работать с любым типом канала передачи данных. Именно поэтому в ОС Linux Интернет сокет - это дескриптор, с которым система работает как с файлом. Типов сокетов, конечно же, намного больше. В ядре ОС Linux сокеты представлены тремя основными структурами:

- __struct socket__ - представление сокета BSD, того вида сокета, который стал основой для современных "Интернет сокетов";

- __struct sock__ - собственная оболочка, которая в Linux называется "INET socket";

- __struct sk_buff__ - "хранилище" данных, которые передает или получает сокет;

Как видно по исходным кодам, все структуры достаточно объемны. Работа с ними возможна при использовании языка программирования или специальных оберток и написания приложения. Для эффективного управления этими структурами нужно знать, какие типы операций над сокетами существуют и когда их применять. Для сокетов существует набор стандартных действий:

- socket - создание сокета;

- bind - действие используется на стороне сервера. В стандартных терминах - это открытие порта на прослушивание, используя указанный интерфейс;

- listen - используется для перевода сокета в прослушивающее состояние. Применяется к серверному сокету;

- connect - используется для инициализации соединения;

- accept - используется сервером, создает новое соединение для клиента;

- send/recv - используется для работы с отправкой/приемом данных;

- close - разрыв соединения, уничтожение сокета.

Если о структурах, которые описаны выше, заботится ядро операционной системы, то в случае команд по управлению соединением ответственность берет на себя приложение, которое хочет пересылать данные по сети. Попробуем использовать знания о сокетах для работы с приложениями __netcat__ и __socat__.

## socat

Инструмент, который до сих пор поддерживается и имеет весьма обширный функционал по склейке каналов для взаимодействия. Разработчиками инструмент именуется как netcat++. Ниже приведем небольшой список того что можно перенаправить через socat:

    STDIO -> TCP Socket;

    FILE -> TCP Socket;

    TCP Socket -> Custom Application;

    UDP Socket -> Custom Application;

    Socket -> Socket.

Для повседневного использования достаточно опций, но если понадобится когда-то работать напрямую с серийным портом или виртуальным терминалом, то socat тоже умеет это делать. Полный перечень опций можно вызвать с помощью команды:

__socat -h__

Помимо редиректов socat также можно использовать как универсальный сервер для расшаривания ресурсов, через него можно как через chroot ограничивать привилегии и доступ к директориям системы.

Чтобы комфортно пользоваться этим инструментом, нужно запомнить шаблон командной строки, который ожидает socat:

__socat additionalOptions addr1 addr2__

- additionalOptions - опции, которые могут добавлять возможности логирования информации, управления направлением передачи данных;

- addr1 - источник данных или приемник (влияет использование флага U или u), это может быть сокет, файл, пайп или виртуальный терминал;

- addr2 - источник данных или приемник (влияет использование флага U или u), это может быть сокет, файл, пайп или виртуальный терминал;

Попробуем провести трансляцию данных из сокета в сокет. Будем использовать для этого 1 машину. Перед началом эксперимента стоит отметить, что особенностью socat является то, что для его корректной работы нужно обязательно писать 2 адреса. Причем адрес не обязательно должен быть адресом, это может быть и приложение, и стандартный вывод на экран.

Например, чтобы использовать socat как netcat в качестве TCP сервера, можно запустить вот такую команду:

__socat TCP-LISTEN:4545, STDOUT__

Для коннекта можно использовать netcat:
__nc localhost 4545__

При таком использовании, socat дает возможность пересылать сообщения в обе стороны, но если добавить флаг "-u", то общение будет только от клиента к серверу. Все серверные сообшения пересылаться не будут:

Настроим более тонко наш сервер, добавив новые опции через запятую после используемого действия:
__socat TCP-LISTEN:4545,reuseaddr,keepalive,fork STDOUT__

Дополнительные параметры распространяются на те действия, которые socat может выполнять по отношению к адресу. Полный список опций можно найти здесь в разделе "SOCKET option group".

Таким образом socat дает практически полный контроль над состоянием сокетов и расшариваемых ресурсов.

## Примеры


## Работа в docker

Рабочий пример
Запускаем веб-сервис, который слушает порт 80, но не выставляет свой внутренний порт 80 (упс!):

__docker run -ti mkodockx/docker-pastebin   # Forgot to expose PORT 80!__
Найдите его сетевой IP-адрес Docker:

__docker inspect 63256f72142a | grep IPAddress__
                    "IPAddress": "172.17.0.2",
Запустите verb/socatс открытым портом 8080 и заставьте его перенаправлять TCP-трафик на этот IP-порт 80:

__docker run --rm -d -p 8080:1234 verb/socat TCP-LISTEN:1234,fork TCP-CONNECT:172.17.0.2:80__
Теперь вы можете получить доступ к pastebin по адресу http://localhost:8080/ , и ваши запросы socat:1234 перенаправляются на pastebin:80, а ответ идет по тому же пути в обратном направлении.