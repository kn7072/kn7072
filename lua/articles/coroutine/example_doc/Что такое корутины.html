<!DOCTYPE html>
<html lang="ru"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="description" content="Полный гайд по корутинам в Lua 5.3.">
<meta name="keywords" content="coroutine, lua, lua5.3, concurrency, programming">
<meta name="author" content="Fingercomp">
<title>Что такое корутины</title>
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section { display: block; }
audio, video { display: inline-block; }
audio:not([controls]) { display: none; height: 0; }
html { font-family: sans-serif; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%; }
a { background: transparent; }
a:focus { outline: thin dotted; }
a:active, a:hover { outline: 0; }
h1 { font-size: 2em; margin: 0.67em 0; }
abbr[title] { border-bottom: 1px dotted; }
b, strong { font-weight: bold; }
dfn { font-style: italic; }
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }
mark { background: #ff0; color: #000; }
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }
pre { white-space: pre-wrap; }
q { quotes: "\201C" "\201D" "\2018" "\2019"; }
small { font-size: 80%; }
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }
sup { top: -0.5em; }
sub { bottom: -0.25em; }
img { border: 0; }
svg:not(:root) { overflow: hidden; }
figure { margin: 0; }
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }
legend { border: 0; padding: 0; }
button, input, select, textarea { font-family: inherit; font-size: 100%; margin: 0; }
button, input { line-height: normal; }
button, select { text-transform: none; }
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; cursor: pointer; }
button[disabled], html input[disabled] { cursor: default; }
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; padding: 0; }
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }
textarea { overflow: auto; vertical-align: top; }
table { border-collapse: collapse; border-spacing: 0; }
*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
html, body { font-size: 100%; }
body { background: white; color: rgba(0, 0, 0, 0.8); padding: 0; margin: 0; font-family: "Noto Serif", "DejaVu Serif", serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; tab-size: 4; -moz-osx-font-smoothing: grayscale; -webkit-font-smoothing: antialiased;}
a:hover { cursor: pointer; }
img, object, embed { max-width: 100%; height: auto; }
object, embed { height: 100%; }
img { -ms-interpolation-mode: bicubic; }
.left { float: left !important; }
.right { float: right !important; }
.text-left { text-align: left !important; }
.text-right { text-align: right !important; }
.text-center { text-align: center !important; }
.text-justify { text-align: justify !important; }
.hide { display: none; }
img, object, svg { display: inline-block; vertical-align: middle; }
textarea { height: auto; min-height: 50px; }
select { width: 100%; }
.center { margin-left: auto; margin-right: auto; }
.stretch { width: 100%; }
.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.45; color: #7a2518; font-weight: normal; margin-top: 0; margin-bottom: 0.25em; }
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }
a { color: #2156a5; text-decoration: underline; line-height: inherit; }
a:hover, a:focus { color: #1d4b8f; }
a img { border: none; }
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: "Open Sans", "DejaVu Sans", sans-serif; font-weight: 300; font-style: normal; color: #ba3925; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.0125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #e99b8f; line-height: 0; }
h1 { font-size: 2.125em; }
h2 { font-size: 1.6875em; }
h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }
h4 { font-size: 1.125em; }
h5 { font-size: 1.125em; }
h6 { font-size: 1em; }
hr { border: solid #dddddf; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }
em, i { font-style: italic; line-height: inherit; }
strong, b { font-weight: bold; line-height: inherit; }
small { font-size: 60%; line-height: inherit; }
code { font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace; font-weight: normal; color: rgba(0, 0, 0, 0.9); }
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }
ul, ol { margin-left: 1.5em; }
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }
abbr, acronym { text-transform: uppercase; font-size: 90%; color: rgba(0, 0, 0, 0.8); border-bottom: 1px dotted #dddddd; cursor: help; }
abbr { text-transform: none; }
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.9375em; color: rgba(0, 0, 0, 0.6); }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: rgba(0, 0, 0, 0.6); }
blockquote, blockquote p { line-height: 1.6; color: rgba(0, 0, 0, 0.85); }
@media screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.2; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
table { background: white; margin-bottom: 1.25em; border: solid 1px #dedede; }
table thead, table tfoot { background: #f7f8f7; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: rgba(0, 0, 0, 0.8); text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: rgba(0, 0, 0, 0.8); }
table tr.even, table tr.alt { background: #f8f8f7; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.6; }
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.2; word-spacing: -0.05em; }
h1 strong, h2 strong, h3 strong, #toctitle strong, .sidebarblock > .content > .title strong, h4 strong, h5 strong, h6 strong { font-weight: 400; }
.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }
:not(pre):not([class^=L]) > code { font-size: 0.9375em; font-style: normal !important; letter-spacing: 0; padding: 0.1em 0.5ex; word-spacing: -0.15em; background-color: #f7f7f8; -webkit-border-radius: 4px; border-radius: 4px; line-height: 1.45; text-rendering: optimizeSpeed; word-wrap: break-word; }
:not(pre) > code.nobreak { word-wrap: normal; }
:not(pre) > code.nowrap { white-space: nowrap; }
pre { color: rgba(0, 0, 0, 0.9); font-family: "Droid Sans Mono", "DejaVu Sans Mono", "Monospace", monospace; line-height: 1.45; text-rendering: optimizeSpeed; }
pre code, pre pre { color: inherit; font-size: inherit; line-height: inherit; }
pre > code { display: block; }
pre.nowrap, pre.nowrap pre { white-space: pre; word-wrap: normal; }
em em { font-style: normal; }
strong strong { font-weight: normal; }
.keyseq { color: rgba(51, 51, 51, 0.8); }
kbd { font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace; display: inline-block; color: rgba(0, 0, 0, 0.8); font-size: 0.65em; line-height: 1.45; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: 0 0.15em; padding: 0.2em 0.5em; vertical-align: middle; position: relative; top: -0.1em; white-space: nowrap; }
.keyseq kbd:first-child { margin-left: 0; }
.keyseq kbd:last-child { margin-right: 0; }
.menuseq, .menuref { color: #000; }
.menuseq b:not(.caret), .menuref { font-weight: inherit; }
.menuseq { word-spacing: -0.02em; }
.menuseq b.caret { font-size: 1.25em; line-height: 0.8; }
.menuseq i.caret { font-weight: bold; text-align: center; width: 0.45em; }
b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }
b.button:before { content: "["; padding: 0 3px 0 2px; }
b.button:after { content: "]"; padding: 0 2px 0 3px; }
p a > code:hover { color: rgba(0, 0, 0, 0.9); }
#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }
#content { margin-top: 1.25em; }
#content:before { content: none; }
#header > h1:first-child { color: rgba(0, 0, 0, 0.85); margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddf; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddf; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddf; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: rgba(0, 0, 0, 0.6); display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: rgba(0, 0, 0, 0.85); }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: rgba(0, 0, 0, 0.85); }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }
#content > h1:first-child:not([class]) { color: rgba(0, 0, 0, 0.85); border-bottom: 1px solid #dddddf; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }
#toc { border-bottom: 1px solid #e7e7e9; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: "Open Sans", "DejaVu Sans", sans-serif; list-style-type: none; }
#toc li { line-height: 1.3334; margin-top: 0.3334em; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }
#toctitle { color: #7a2518; font-size: 1.2em; }
@media screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background: #f8f8f7; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #e7e7e9; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; margin-bottom: 0.8rem; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #e7e7e9; left: auto; right: 0; } }
@media screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #e0e0dc; margin-bottom: 1.25em; padding: 1.25em; background: #f8f8f7; -webkit-border-radius: 4px; border-radius: 4px; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }
#footer { max-width: 100%; background: rgba(0, 0, 0, 0.8); padding: 1.25em; }
#footer-text { color: rgba(255, 255, 255, 0.8); line-height: 1.44; }
#content { margin-bottom: 0.625em; }
.sect1 { padding-bottom: 0.625em; }
@media screen and (min-width: 768px) { #content { margin-bottom: 1.25em; }
  .sect1 { padding-bottom: 1.25em; } }
.sect1:last-child { padding-bottom: 0; }
.sect1 + .sect1 { border-top: 1px solid #e7e7e9; }
#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #ba3925; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #a53221; }
details, .audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }
video { max-width: 100%; }
details > summary:first-of-type { cursor: pointer; display: list-item; outline: none; margin-bottom: 0.75em; }
.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; font-family: "Noto Serif", "DejaVu Serif", serif; font-size: 1rem; font-style: italic; }
table.tableblock.fit-content > caption.title { white-space: nowrap; width: 0; }
.paragraph.lead > p, #preamble > .sectionbody > [class="paragraph"]:first-of-type p { font-size: 1.21875em; line-height: 1.6; color: rgba(0, 0, 0, 0.85); }
table.tableblock #preamble > .sectionbody > [class="paragraph"]:first-of-type p { font-size: inherit; }
.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: "Open Sans", "DejaVu Sans", sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddf; color: rgba(0, 0, 0, 0.6); }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }
.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 4px; border-radius: 4px; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.sidebarblock { border-style: solid; border-width: 1px; border-color: #dbdbd6; margin-bottom: 1.25em; padding: 1.25em; background: #f3f3f2; -webkit-border-radius: 4px; border-radius: 4px; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #7a2518; margin-top: 0; text-align: center; }
.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }
.literalblock pre, .listingblock > .content > pre { -webkit-border-radius: 4px; border-radius: 4px; word-wrap: break-word; overflow-x: auto; padding: 1em; font-size: 0.8125em; }
@media screen and (min-width: 768px) { .literalblock pre, .listingblock > .content > pre { font-size: 0.90625em; } }
@media screen and (min-width: 1280px) { .literalblock pre, .listingblock > .content > pre { font-size: 1em; } }
.literalblock pre, .listingblock > .content > pre:not(.highlight), .listingblock > .content > pre[class="highlight"], .listingblock > .content > pre[class^="highlight "] { background: #f7f7f8; }
.literalblock.output pre { color: #f7f7f8; background-color: rgba(0, 0, 0, 0.9); }
.listingblock > .content { position: relative; }
.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: inherit; opacity: 0.5; }
.listingblock:hover code[data-lang]:before { display: block; }
.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: inherit; opacity: 0.5; }
.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }
.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 1em; -webkit-border-radius: 4px; border-radius: 4px; }
.listingblock pre.prettyprint { border-width: 0; }
.prettyprint { background: #f7f7f8; }
pre.prettyprint .linenums { line-height: 1.45; margin-left: 2em; }
pre.prettyprint li { background: none; list-style-type: inherit; padding-left: 0; }
pre.prettyprint li code[data-lang]:before { opacity: 1; }
pre.prettyprint li:not(:first-child) code[data-lang]:before { display: none; }
table.linenotable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }
table.linenotable td[class] { color: inherit; vertical-align: top; padding: 0; line-height: inherit; white-space: normal; }
table.linenotable td.code { padding-left: 0.75em; }
table.linenotable td.linenos { border-right: 1px solid currentColor; opacity: 0.35; padding-right: 0.5em; }
pre.pygments .lineno { border-right: 1px solid currentColor; opacity: 0.35; display: inline-block; margin-right: 0.75em; }
pre.pygments .lineno:before { content: ""; margin-right: -0.125em; }
.quoteblock { margin: 0 1em 1.25em 1.5em; display: table; }
.quoteblock:not(.excerpt) > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock p { color: rgba(0, 0, 0, 0.85); font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #7a2518; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.75em; margin-right: 0.5ex; text-align: right; }
.videoblock.text-left { text-align: left; }
.videoblock.text-center { text-align: center; }
.videoblock.text-right { text-align: right; }
.videoblock .content { display: inline-block; }
.videoblock .content ul { list-style: none; text-align: center; margin: 0; }
.videoblock .content li { display: inline-block; margin: 0.25em; }
.videoblock .content li > * { display: block; }
.videoblock .content button { margin: 0 1em; height: 100%; }
.verseblock { margin: 0 1em 1.25em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: rgba(0, 0, 0, 0.85); font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }
.quoteblock .attribution, .verseblock .attribution { font-size: 0.9375em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.025em; color: rgba(0, 0, 0, 0.6); }
.quoteblock.abstract blockquote:before, .quoteblock.excerpt blockquote:before, .quoteblock .quoteblock blockquote:before { display: none; }
.quoteblock.abstract blockquote, .quoteblock.abstract p, .quoteblock.excerpt blockquote, .quoteblock.excerpt p, .quoteblock .quoteblock blockquote, .quoteblock .quoteblock p { line-height: 1.6; word-spacing: 0; }
.quoteblock.abstract { margin: 0 1em 1.25em 1em; display: block; }
.quoteblock.abstract > .title { margin: 0 0 0.375em 0; font-size: 1.15em; text-align: center; }
.quoteblock.excerpt > blockquote, .quoteblock .quoteblock { padding: 0 0 0.25em 1em; border-left: 0.25em solid #dddddf; }
.quoteblock.excerpt, .quoteblock .quoteblock { margin-left: 0; }
.quoteblock.excerpt blockquote, .quoteblock.excerpt p, .quoteblock .quoteblock blockquote, .quoteblock .quoteblock p { color: inherit; font-size: 1.0625rem; }
.quoteblock.excerpt .attribution, .quoteblock .quoteblock .attribution { color: inherit; text-align: left; margin-right: 0; }
table.tableblock { max-width: 100%; border-collapse: separate; }
p.tableblock:last-child { margin-bottom: 0; }
td.tableblock > .content > :last-child { margin-bottom: -1.25em; }
td.tableblock > .content > :last-child.sidebarblock { margin-bottom: 0; }
table.tableblock, th.tableblock, td.tableblock { border: 0 solid #dedede; }
table.grid-all > thead > tr > .tableblock, table.grid-all > tbody > tr > .tableblock { border-width: 0 1px 1px 0; }
table.grid-all > tfoot > tr > .tableblock { border-width: 1px 1px 0 0; }
table.grid-cols > * > tr > .tableblock { border-width: 0 1px 0 0; }
table.grid-rows > thead > tr > .tableblock, table.grid-rows > tbody > tr > .tableblock { border-width: 0 0 1px 0; }
table.grid-rows > tfoot > tr > .tableblock { border-width: 1px 0 0 0; }
table.grid-all > * > tr > .tableblock:last-child, table.grid-cols > * > tr > .tableblock:last-child { border-right-width: 0; }
table.grid-all > tbody > tr:last-child > .tableblock, table.grid-all > thead:last-child > tr > .tableblock, table.grid-rows > tbody > tr:last-child > .tableblock, table.grid-rows > thead:last-child > tr > .tableblock { border-bottom-width: 0; }
table.frame-all { border-width: 1px; }
table.frame-sides { border-width: 0 1px; }
table.frame-topbot, table.frame-ends { border-width: 1px 0; }
table.stripes-all tr, table.stripes-odd tr:nth-of-type(odd), table.stripes-even tr:nth-of-type(even), table.stripes-hover tr:hover { background: #f8f8f7; }
th.halign-left, td.halign-left { text-align: left; }
th.halign-right, td.halign-right { text-align: right; }
th.halign-center, td.halign-center { text-align: center; }
th.valign-top, td.valign-top { vertical-align: top; }
th.valign-bottom, td.valign-bottom { vertical-align: bottom; }
th.valign-middle, td.valign-middle { vertical-align: middle; }
table thead th, table tfoot th { font-weight: bold; }
tbody tr th { display: table-cell; line-height: 1.6; background: #f7f8f7; }
tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: rgba(0, 0, 0, 0.8); font-weight: bold; }
p.tableblock > code:only-child { background: none; padding: 0; }
p.tableblock { font-size: 1em; }
ol { margin-left: 1.75em; }
ul li ol { margin-left: 1.5em; }
dl dd { margin-left: 1.125em; }
dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }
ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }
ul.checklist, ul.none, ol.none, ul.no-bullet, ol.no-bullet, ol.unnumbered, ul.unstyled, ol.unstyled { list-style-type: none; }
ul.no-bullet, ol.no-bullet, ol.unnumbered { margin-left: 0.625em; }
ul.unstyled, ol.unstyled { margin-left: 0; }
ul.checklist { margin-left: 0.625em; }
ul.checklist li > p:first-child > .fa-square-o:first-child, ul.checklist li > p:first-child > .fa-check-square-o:first-child { width: 1.25em; font-size: 0.8em; position: relative; bottom: 0.125em; }
ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }
ul.inline { display: -ms-flexbox; display: -webkit-box; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; list-style: none; margin: 0 0 0.625em -1.25em; }
ul.inline > li { margin-left: 1.25em; }
.unstyled dl dt { font-weight: normal; font-style: normal; }
ol.arabic { list-style-type: decimal; }
ol.decimal { list-style-type: decimal-leading-zero; }
ol.loweralpha { list-style-type: lower-alpha; }
ol.upperalpha { list-style-type: upper-alpha; }
ol.lowerroman { list-style-type: lower-roman; }
ol.upperroman { list-style-type: upper-roman; }
ol.lowergreek { list-style-type: lower-greek; }
.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }
td.hdlist1, td.hdlist2 { vertical-align: top; padding: 0 0.625em; }
td.hdlist1 { font-weight: bold; padding-bottom: 1.25em; }
.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }
.colist td:not([class]):first-child { padding: 0.4em 0.75em 0 0.75em; line-height: 1; vertical-align: top; }
.colist td:not([class]):first-child img { max-width: none; }
.colist td:not([class]):last-child { padding: 0.25em 0; }
.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }
.imageblock.left { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }
.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }
a.image { text-decoration: none; display: inline-block; }
a.image object { pointer-events: none; }
sup.footnote, sup.footnoteref { font-size: 0.875em; position: static; vertical-align: super; }
sup.footnote a, sup.footnoteref a { text-decoration: none; }
sup.footnote a:active, sup.footnoteref a:active { text-decoration: underline; }
#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -0.25em 0 0.75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em 0 0.225em; line-height: 1.3334; font-size: 0.875em; margin-left: 1.2em; margin-bottom: 0.2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; margin-left: -1.05em; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }
#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }
.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }
div.unbreakable { page-break-inside: avoid; }
.big { font-size: larger; }
.small { font-size: smaller; }
.underline { text-decoration: underline; }
.overline { text-decoration: overline; }
.line-through { text-decoration: line-through; }
.aqua { color: #00bfbf; }
.aqua-background { background-color: #00fafa; }
.black { color: black; }
.black-background { background-color: black; }
.blue { color: #0000bf; }
.blue-background { background-color: #0000fa; }
.fuchsia { color: #bf00bf; }
.fuchsia-background { background-color: #fa00fa; }
.gray { color: #606060; }
.gray-background { background-color: #7d7d7d; }
.green { color: #006000; }
.green-background { background-color: #007d00; }
.lime { color: #00bf00; }
.lime-background { background-color: #00fa00; }
.maroon { color: #600000; }
.maroon-background { background-color: #7d0000; }
.navy { color: #000060; }
.navy-background { background-color: #00007d; }
.olive { color: #606000; }
.olive-background { background-color: #7d7d00; }
.purple { color: #600060; }
.purple-background { background-color: #7d007d; }
.red { color: #bf0000; }
.red-background { background-color: #fa0000; }
.silver { color: #909090; }
.silver-background { background-color: #bcbcbc; }
.teal { color: #006060; }
.teal-background { background-color: #007d7d; }
.white { color: #bfbfbf; }
.white-background { background-color: #fafafa; }
.yellow { color: #bfbf00; }
.yellow-background { background-color: #fafa00; }
span.icon > .fa { cursor: default; }
a span.icon > .fa { cursor: inherit; }
.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #19407c; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }
.conum[data-value] { display: inline-block; color: #fff !important; background-color: rgba(0, 0, 0, 0.8); -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }
b.conum * { color: inherit !important; }
.conum:not([data-value]):empty { display: none; }
dt, th.tableblock, td.content, div.footnote { text-rendering: optimizeLegibility; }
h1, h2, p, td.content, span.alt { letter-spacing: -0.01em; }
p strong, td.content strong, div.footnote strong { letter-spacing: -0.005em; }
p, blockquote, dt, td.content, span.alt { font-size: 1.0625rem; }
p { margin-bottom: 1.25rem; }
.sidebarblock p, .sidebarblock dt, .sidebarblock td.content, p.tableblock { font-size: 1em; }
.exampleblock > .content { background-color: #fffef7; border-color: #e0e0dc; -webkit-box-shadow: 0 1px 4px #e0e0dc; box-shadow: 0 1px 4px #e0e0dc; }
.print-only { display: none !important; }
@page { margin: 1.25cm 0.75cm; }
@media print { * { -webkit-box-shadow: none !important; box-shadow: none !important; text-shadow: none !important; }
  html { font-size: 80%; }
  a { color: inherit !important; text-decoration: underline !important; }
  a.bare, a[href^="#"], a[href^="mailto:"] { text-decoration: none !important; }
  a[href^="http:"]:not(.bare):after, a[href^="https:"]:not(.bare):after { content: "(" attr(href) ")"; display: inline-block; font-size: 0.875em; padding-left: 0.25em; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  pre, blockquote, tr, img, object, svg { page-break-inside: avoid; }
  thead { display: table-header-group; }
  svg { max-width: 100%; }
  p, blockquote, dt, td.content { font-size: 1em; orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  #toc, .sidebarblock, .exampleblock > .content { background: none !important; }
  #toc { border-bottom: 1px solid #dddddf !important; padding-bottom: 0 !important; }
  body.book #header { text-align: center; }
  body.book #header > h1:first-child { border: 0 !important; margin: 2.5em 0 1em 0; }
  body.book #header .details { border: 0 !important; display: block; padding: 0 !important; }
  body.book #header .details span:first-child { margin-left: 0 !important; }
  body.book #header .details br { display: block; }
  body.book #header .details br + span:before { content: none !important; }
  body.book #toc { border: 0 !important; text-align: left !important; padding: 0 !important; margin: 0 !important; }
  body.book #toc, body.book #preamble, body.book h1.sect0, body.book .sect1 > h2 { page-break-before: always; }
  .listingblock code[data-lang]:before { display: block; }
  #footer { padding: 0 0.9375em; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
@media print, amzn-kf8 { #header > h1:first-child { margin-top: 1.25rem; }
  .sect1 { padding: 0 !important; }
  .sect1 + .sect1 { border: 0; }
  #footer { background: none; }
  #footer-text { color: rgba(0, 0, 0, 0.6); font-size: 0.9em; } }
@media amzn-kf8 { #header, #content, #footnotes, #footer { padding: 0; } }

</style>
<link rel="stylesheet" href="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/font-awesome.min.css">
</head>
<body class="article">
<div id="header">
<h1>Что такое корутины</h1>
<div class="details">
<span id="author" class="author">Fingercomp</span><br>
<span id="revnumber">version 1.0.1,</span>
<span id="revdate">2020-05-07</span>
<br><span id="revremark">Обновлен раздел с примерами корутин в дикой природе.</span>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Корутины (сопрограммы) — функции, которые могут приостанавливать исполнение и возобновлять впоследствии.
Lua поддерживает их из коробки.
В гайде — история об этих зверях с подробностями.</p>
</div>
</div>
<div id="toc" class="toc">
<div id="toctitle">Содержание</div>
<ul class="sectlevel1">
<li><a href="#_введение">Введение</a></li>
<li><a href="#_итератор_фибоначчи">1. Итератор Фибоначчи</a></li>
<li><a href="#_принцип_работы_корутин">2. Принцип работы корутин</a>
<ul class="sectlevel2">
<li><a href="#_корутины_в_движении">2.1. Корутины в движении</a></li>
</ul>
</li>
<li><a href="#_coroutine_api">3. Coroutine API</a></li>
<li><a href="#_классификация_корутин">4. Классификация корутин</a></li>
<li><a href="#_преобразования">5. Преобразования</a>
<ul class="sectlevel2">
<li><a href="#_преобразование_в_симметричную_корутину">5.1. Преобразование в симметричную корутину</a></li>
<li><a href="#_переписывание_без_корутин">5.2. Переписывание без корутин</a></li>
</ul>
</li>
<li><a href="#_применение">6. Применение</a>
<ul class="sectlevel2">
<li><a href="#_пайпинг_итераторы">6.1. Пайпинг. Итераторы</a></li>
<li><a href="#_многопоточность">6.2. Многопоточность</a></li>
<li><a href="#_конечные_автоматы">6.3. Конечные автоматы</a></li>
<li><a href="#_ещё_применения">6.4. Ещё применения</a></li>
</ul>
</li>
<li><a href="#_заключение">7. Заключение</a>
<ul class="sectlevel2">
<li><a href="#_библиография">Библиография</a></li>
<li><a href="#_примеры">Приложение A: Примеры</a></li>
<li><a href="#_корутины_в_дикой_природе">Приложение B: Корутины в дикой природе</a></li>
<li><a href="#_видяхи_с_интерпретацией">Приложение C: Видяхи с интерпретацией</a></li>
<li><a href="#_сырцы_и_лицензия">Приложение D: Сырцы и лицензия</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="sect1">
<h2 id="_введение"><a class="anchor" href="#_введение"></a><a class="link" href="#_введение">Введение</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Концепт корутин не новый: появился он в шестидесятых годах прошлого века.
Корутины использовали в те времена для реализации многопоточности,
так как полноценные потоки требовали много ресурсов.
В конце девяностых — начале нулевых дороговизна перестала сильно мешаться,
и о корутинах подзабыли.</p>
</div>
<div class="paragraph">
<p>Но люди одумались, когда стали писать много сетевого (по сути, вебовского) софта.
Серверы, обрабатывающие по десятку тысяч запросов в секунду, теперь не редкость.
Потому серверы делают быстрыми.
Чтобы убрать оверхед от полноценных потоков, снова потребовались корутины.
Новые версии языков: JavaScript, Rust, Kotlin, Python, Go, C++ и т. д. — пытаются выделиться их поддержкой.</p>
</div>
<div class="paragraph">
<p>В Lua корутины появились в версии 5.0 — она выпущена в 2003 году, до этого хайпа.
Если понять, как они работают в этом языке, проще изучать аналогичные реализации в других.
Поэтому приступим.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_итератор_фибоначчи"><a class="anchor" href="#_итератор_фибоначчи"></a><a class="link" href="#_итератор_фибоначчи">1. Итератор Фибоначчи</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Начнём с наивного примера: обнаружив итеративный цикл for,
вам почему-то захотелось создать итератор последовательности Фибоначчи.</p>
</div>
<div id="code-1.1" class="listingblock">
<div class="title">Листинг 1.1. Итератор Фибоначчи. Самый простой вариант решения.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">fibonacciSeq</span><span class="tok-p">(</span><span class="tok-n">n</span><span class="tok-p">)</span>
  <span class="tok-kd">local</span> <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-p">{}</span> <i class="conum" data-value="1"></i><b>(1)</b>

  <span class="tok-kr">for</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">n</span> <span class="tok-kr">do</span>
    <span class="tok-n">result</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">result</span><span class="tok-p">[</span><span class="tok-n">i</span> <span class="tok-o">-</span> <span class="tok-mi">2</span><span class="tok-p">]</span> <span class="tok-ow">or</span> <span class="tok-mi">0</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-p">(</span><span class="tok-n">result</span><span class="tok-p">[</span><span class="tok-n">i</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-ow">or</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-kr">end</span>

  <span class="tok-kr">return</span> <span class="tok-nb">ipairs</span><span class="tok-p">(</span><span class="tok-n">result</span><span class="tok-p">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-kr">end</span>

<span class="tok-kr">for</span> <span class="tok-n">_</span><span class="tok-p">,</span> <span class="tok-n">n</span> <span class="tok-kr">in</span> <span class="tok-n">fibonacciSeq</span><span class="tok-p">(</span><span class="tok-mi">10</span><span class="tok-p">)</span> <span class="tok-kr">do</span> <i class="conum" data-value="4"></i><b>(4)</b>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">n</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Создаём таблицу.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Наполняем её числами из последовательности Фибоначчи.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Возвращаем итератор.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Запускаем цикл на 10 элементов.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Функция <code>fibonacciSeq</code> сначала готовит сразу все элементы, а потом отдаёт итератор.
Решение это плохое: если <code>n</code> слишком большое, закончится память.</p>
</div>
<div class="paragraph">
<p>Переделаем функцию так, чтобы считать по одному числу, а не сразу все:</p>
</div>
<div id="code-1.2" class="listingblock">
<div class="title">Листинг 1.2. Итератор Фибоначчи. Решение без лишнего мусора.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">fibonacciSeq</span><span class="tok-p">(</span><span class="tok-n">n</span><span class="tok-p">)</span>
  <span class="tok-kd">local</span> <span class="tok-n">penultimate</span> <span class="tok-o">=</span> <span class="tok-mi">1</span>
  <span class="tok-kd">local</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>

  <span class="tok-kr">return</span> <span class="tok-kr">function</span><span class="tok-p">(</span><span class="tok-n">_</span><span class="tok-p">,</span> <span class="tok-n">previous</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-kd">local</span> <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">penultimate</span> <span class="tok-o">+</span> <span class="tok-n">previous</span>
    <span class="tok-n">penultimate</span> <span class="tok-o">=</span> <span class="tok-n">previous</span>
    <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-n">i</span> <span class="tok-o">+</span> <span class="tok-mi">1</span>

    <span class="tok-kr">if</span> <span class="tok-n">i</span> <span class="tok-o">&lt;=</span> <span class="tok-n">n</span> <span class="tok-kr">then</span>
      <span class="tok-kr">return</span> <span class="tok-n">result</span>
    <span class="tok-kr">end</span>
  <span class="tok-kr">end</span><span class="tok-p">,</span> <span class="tok-kc">nil</span><span class="tok-p">,</span> <span class="tok-mi">0</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-kr">end</span>

<span class="tok-kr">for</span> <span class="tok-n">n</span> <span class="tok-kr">in</span> <span class="tok-n">fibonacciSeq</span><span class="tok-p">(</span><span class="tok-mi">10</span><span class="tok-p">)</span> <span class="tok-kr">do</span> <i class="conum" data-value="4"></i><b>(4)</b>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">n</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Здесь создаём замыкание: функция обрастает стейтом и обращается к нему за предпоследним значением.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Итераторы в Lua первым аргументом получают иммутабельный стейт, а вторым — предыдущий элемент.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Для запуска цикла for нужны три значения:
<div class="ulist">
<ul>
<li>
<p>Сама функция-итератор.</p>
</li>
<li>
<p>Иммутабельный стейт.
Это любое значение: оно просто передаётся функции.
Нам оно не нужно, ибо стейт вынесли в замыкание.</p>
</li>
<li>
<p>Инициализирующее значение.
Его функция получит вторым аргументом на первой итерации.</p>
</li>
</ul>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>И снова запускаем на 10 элементов.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Это решение лучше.
Если сделать <code>break</code>, лишние значения считаться не будут.
Однако для такой задачи код странно многословен.</p>
</div>
<div class="paragraph">
<p>Другое решение — на корутинах:</p>
</div>
<div id="code-1.3" class="listingblock">
<div class="title">Листинг 1.3. Фибоначчи на корутинах.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">fibonacciSeq</span><span class="tok-p">(</span><span class="tok-n">n</span><span class="tok-p">)</span>
  <span class="tok-kr">return</span> <span class="tok-nb">coroutine.wrap</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
    <span class="tok-kd">local</span> <span class="tok-n">penultimate</span><span class="tok-p">,</span> <span class="tok-n">previous</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span>

    <span class="tok-kr">for</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">n</span> <span class="tok-kr">do</span>
      <span class="tok-n">penultimate</span><span class="tok-p">,</span> <span class="tok-n">previous</span> <span class="tok-o">=</span> <span class="tok-n">previous</span><span class="tok-p">,</span> <span class="tok-n">penultimate</span> <span class="tok-o">+</span> <span class="tok-n">previous</span>
      <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">previous</span><span class="tok-p">)</span>
    <span class="tok-kr">end</span>
  <span class="tok-kr">end</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>

<span class="tok-kr">for</span> <span class="tok-n">n</span> <span class="tok-kr">in</span> <span class="tok-n">fibonacciSeq</span><span class="tok-p">(</span><span class="tok-mi">10</span><span class="tok-p">)</span> <span class="tok-kr">do</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">n</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Напоминает <a href="#code-1.1">первый вариант</a>.
Здесь тоже цикл.
Однако с толку сбивают <code>coroutine.wrap</code> и <code>coroutine.yield</code>.
Давайте разбираться.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_принцип_работы_корутин"><a class="anchor" href="#_принцип_работы_корутин"></a><a class="link" href="#_принцип_работы_корутин">2. Принцип работы корутин</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Корутина — надстройка над функцией, в которой можно вернуть значения несколько раз.
Вот как они работают:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Создаём корутину.</p>
</li>
<li>
<p>Запускаем корутину, передаём аргументы.</p>
</li>
<li>
<p>Корутина запускается, обрабатывает аргументы, возвращает какие-то значения.</p>
</li>
<li>
<p>Значения снаружи получаем и снова запускаем корутину, передавая уже другие значения.</p>
</li>
<li>
<p>Корутина принимает их и продолжает работу <strong>с момента остановки</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Затем она так же может приостановить исполнение.
Продолжается так, пока корутина не завершится насовсем.
Или можно её не вызвать в очередной раз.</p>
</div>
<div class="paragraph">
<p>Перенесём всё это в код.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Создаёт корутину <code>coroutine.create</code> — ей нужна функция, которая станет кодом корутины.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">co</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">)</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">)</span>
  <span class="tok-p">...</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</li>
<li>
<p>Запускаем через <code>coroutine.resume</code>, передавая корутину и аргументы.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">co</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">)</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">)</span>
  <span class="tok-p">...</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>

<span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">,</span> <span class="tok-mi">42</span><span class="tok-p">,</span> <span class="tok-mi">24</span><span class="tok-p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</li>
<li>
<p>Пока корутина работает, как обычная функция.
Получает <code>a</code>, <code>b</code>, принтит их.
Приостановим её: используем <code>coroutine.yield</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">co</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">)</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">)</span>
  <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-o">+</span> <span class="tok-n">b</span><span class="tok-p">)</span>
  <span class="tok-p">...</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>

<span class="tok-kd">local</span> <span class="tok-n">success</span><span class="tok-p">,</span> <span class="tok-n">sum</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">,</span> <span class="tok-mi">42</span><span class="tok-p">,</span> <span class="tok-mi">24</span><span class="tok-p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</li>
<li>
<p>Теперь мы снаружи.
<code>coroutine.resume</code> рапортует об успехе и отдаёт, что вернула корутина.
Успех сохраним в <code>success</code>, а отданное — в <code>sum</code>.
Опять запустим корутину.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">co</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">)</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">)</span>
  <span class="tok-kd">local</span> <span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">d</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-o">+</span> <span class="tok-n">b</span><span class="tok-p">)</span>
  <span class="tok-p">...</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>

<span class="tok-kd">local</span> <span class="tok-n">success</span><span class="tok-p">,</span> <span class="tok-n">sum</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">,</span> <span class="tok-mi">42</span><span class="tok-p">,</span> <span class="tok-mi">24</span><span class="tok-p">)</span>
<span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">,</span> <span class="tok-n">sum</span><span class="tok-p">,</span> <span class="tok-mi">12</span><span class="tok-p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</li>
<li>
<p>Корутина приняла <code>sum</code> (в <code>c</code>) и <code>12</code> (в <code>d</code>) и желает завершиться насовсем.
Делает она это <code>return</code>ом.
И тоже передаёт значения.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">co</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">)</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">)</span>
  <span class="tok-kd">local</span> <span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">d</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-o">+</span> <span class="tok-n">b</span><span class="tok-p">)</span>
  <span class="tok-kr">return</span> <span class="tok-n">a</span> <span class="tok-o">*</span> <span class="tok-n">b</span> <span class="tok-o">*</span> <span class="tok-n">c</span> <span class="tok-o">*</span> <span class="tok-n">d</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>

<span class="tok-kd">local</span> <span class="tok-n">success</span><span class="tok-p">,</span> <span class="tok-n">sum</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">,</span> <span class="tok-mi">42</span><span class="tok-p">,</span> <span class="tok-mi">24</span><span class="tok-p">)</span>
<span class="tok-kd">local</span> <span class="tok-n">success</span><span class="tok-p">,</span> <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">,</span> <span class="tok-n">sum</span><span class="tok-p">,</span> <span class="tok-mi">12</span><span class="tok-p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</li>
<li>
<p><code>coroutine.resume</code> исправно отдаёт произведение.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Подытожим.</p>
</div>
<div class="dlist">
<div class="title">Самые главные функции по работе с корутинами</div>
<dl>
<dt class="hdlist1"><code>coroutine.create(f)</code></dt>
<dd>
<p>Создаёт корутину из функции <code>f</code>.</p>
</dd>
<dt class="hdlist1"><code>coroutine.resume(co, ...)</code></dt>
<dd>
<p>Запускает корутину <code>co</code> и передаёт ей все дополнительные аргументы.
Когда корутина останавливается или завершается насовсем, <code>coroutine.resume</code> вернёт <code>true</code> и всё, что передала корутина.
Если же возникла ошибка, вернёт <code>false</code> и сообщение об ошибке.</p>
</dd>
<dt class="hdlist1"><code>coroutine.yield(...)</code></dt>
<dd>
<p>Приостановит корутину, а всё, что функции дано, передаст в <code>coroutine.resume</code>.
Если корутина затем снова возобновляется, <code>coroutine.yield</code> вернёт всё, что передали извне.</p>
</dd>
<dt class="hdlist1"><code>coroutine.wrap(f)</code></dt>
<dd>
<p>Возвращает обёртку, создавая корутину из функции <code>f</code>.
Обёртка — функция, которая работает, как <code>coroutine.resume</code>.
С тремя отличиями:</p>
<div class="ulist">
<ul>
<li>
<p>Не надо самому передавать корутину.</p>
</li>
<li>
<p>Не добавляет <code>true</code> или <code>false</code> в начало.</p>
</li>
<li>
<p>Пробрасывает ошибку наружу.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Подробнее — в <a href="#_coroutine_api">главе ниже</a>.</p>
</div>
<div class="sect2">
<h3 id="_корутины_в_движении"><a class="anchor" href="#_корутины_в_движении"></a><a class="link" href="#_корутины_в_движении">2.1. Корутины в движении</a></h3>
<div class="paragraph">
<p>Чтобы понять работу корутин, нужно знать, как Lua интерпретирует код.
Это легко разъясняется на видео.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Кнопочки мотают видео на один кадр вперёд/назад.
</td>
</tr>
</tbody></table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="#code-1.1">Листинг 1.1. Итератор Фибоначчи. Самый простой вариант решения.</a></dt>
<dd>
<p></p>
<div class="openblock videoblock">
<div class="content">
<video controls="controls" preload="metadata">
<source src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/1-1.mp4" type="video/mp4">
</video>
<ul class="controls">
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.max(event.target.parentNode.parentNode.parentNode.children[0].currentTime - 1/4, 0)">
← 1 кадр туда
</button>
</li>
<li class="rate-slider">
<div>4 FPS</div>
<input type="range" min="1" max="20" step="1" value="4" autocomplete="off" onchange="event.target.parentNode.parentNode.parentNode.children[0].playbackRate = event.target.value / 4; event.target.parentNode.children[0].innerText = event.target.value + ' FPS'">
</li>
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.min(event.target.parentNode.parentNode.parentNode.children[0].currentTime + 1/4, event.target.parentNode.parentNode.parentNode.children[0].duration)">
1 кадр туда →
</button>
</li>
</ul>
</div>
</div>
</dd>
<dt class="hdlist1"><a href="#code-1.2">Листинг 1.2. Итератор Фибоначчи. Решение без лишнего мусора.</a></dt>
<dd>
<p></p>
<div class="openblock videoblock">
<div class="content">
<video controls="controls" preload="metadata">
<source src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/1-2.mp4" type="video/mp4">
</video>
<ul class="controls">
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.max(event.target.parentNode.parentNode.parentNode.children[0].currentTime - 1/4, 0)">
← 1 кадр туда
</button>
</li>
<li class="rate-slider">
<div>4 FPS</div>
<input type="range" min="1" max="20" step="1" value="4" autocomplete="off" onchange="event.target.parentNode.parentNode.parentNode.children[0].playbackRate = event.target.value / 4; event.target.parentNode.children[0].innerText = event.target.value + ' FPS'">
</li>
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.min(event.target.parentNode.parentNode.parentNode.children[0].currentTime + 1/4, event.target.parentNode.parentNode.parentNode.children[0].duration)">
1 кадр туда →
</button>
</li>
</ul>
</div>
</div>
</dd>
<dt class="hdlist1"><a href="#code-1.3">Листинг 1.3. Фибоначчи на корутинах.</a></dt>
<dd>
<p></p>
<div class="openblock videoblock">
<div class="content">
<video controls="controls" preload="metadata">
<source src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/1-3.mp4" type="video/mp4">
</video>
<ul class="controls">
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.max(event.target.parentNode.parentNode.parentNode.children[0].currentTime - 1/4, 0)">
← 1 кадр туда
</button>
</li>
<li class="rate-slider">
<div>4 FPS</div>
<input type="range" min="1" max="20" step="1" value="4" autocomplete="off" onchange="event.target.parentNode.parentNode.parentNode.children[0].playbackRate = event.target.value / 4; event.target.parentNode.children[0].innerText = event.target.value + ' FPS'">
</li>
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.min(event.target.parentNode.parentNode.parentNode.children[0].currentTime + 1/4, event.target.parentNode.parentNode.parentNode.children[0].duration)">
1 кадр туда →
</button>
</li>
</ul>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Дальше в гайде будут такие же видяхи.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_coroutine_api"><a class="anchor" href="#_coroutine_api"></a><a class="link" href="#_coroutine_api">3. Coroutine API</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Раскроем подробнее весь функционал, который Lua предоставляет для работы с корутинами.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>coroutine.create(f)</code></dt>
<dd>
<p>Создаёт корутину из функции <code>f</code>. Эта функция называется <strong>главной</strong>.</p>
</dd>
<dt class="hdlist1"><code>coroutine.resume(co, ...)</code></dt>
<dd>
<p>Запускает корутину <code>co</code> и передаёт ей содержимое <code>...</code>:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Если корутина запускается в первый раз, то эти значения функция получает как аргументы.</p>
<div class="exampleblock">
<div class="content">
<div id="code-3.1" class="listingblock">
<div class="title">Листинг 3.1. Отправка данных корутине при первом запуске.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">co</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">(...)</span>
  <span class="tok-nb">print</span><span class="tok-p">(...)</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>

<span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">,</span> <span class="tok-mi">7</span><span class="tok-p">,</span> <span class="tok-mi">21</span><span class="tok-p">,</span> <span class="tok-mi">42</span><span class="tok-p">)</span>
<span class="tok-c1">--&gt; 7       21      42</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Иначе данные эти возвращаются функцией <code>coroutine.yield</code>:</p>
<div class="exampleblock">
<div class="content">
<div id="code-3.2" class="listingblock">
<div class="title">Листинг 3.2. Отправка данных при последующем запуске.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">co</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"Got value a = "</span> <span class="tok-o">..</span> <span class="tok-n">a</span><span class="tok-p">)</span>
  <span class="tok-kd">local</span> <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.yield</span><span class="tok-p">()</span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">"Got value b = "</span> <span class="tok-o">..</span> <span class="tok-n">b</span><span class="tok-p">)</span>

  <span class="tok-kr">return</span> <span class="tok-n">a</span> <span class="tok-o">+</span> <span class="tok-n">b</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>

<span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-c1">--&gt; Got value a = 2</span>
<span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">,</span> <span class="tok-mi">8</span><span class="tok-p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-c1">--&gt; Got value b = 8</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Первый запуск: корутина получает данные как аргументы.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Последующий запуск: значения возвращает <code>coroutine.yield</code>.</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</li>
</ul>
</div>
<div class="dlist">
<div class="title">Возвращаемые значения</div>
<dl>
<dt class="hdlist1">Если возникла ошибка</dt>
<dd>
<p>Первое значение — <code>false</code>, второе — сообщение об ошибке.</p>
<div class="exampleblock">
<div class="content">
<div id="code-3.3" class="listingblock">
<div class="title">Листинг 3.3. Ошибка внутри корутины.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">co</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
  <span class="tok-nb">error</span><span class="tok-p">(</span><span class="tok-s2">"error example"</span><span class="tok-p">)</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; false   example.lua:2: error example</span>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; false   cannot resume dead coroutine</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Стэк вызовов при ошибке в корутине не "разматывается".
Это означает, что можно использовать <code>debug.traceback</code>, <code>debug.getlocal</code> и прочие функции из либы <code>debug</code>,
чтобы получить подробную информацию об ошибке.
</td>
</tr>
</tbody></table>
</div>
</dd>
<dt class="hdlist1">Если корутина вызвала <code>coroutine.yield</code></dt>
<dd>
<p>Первое значение — <code>true</code>, остальные — аргументы функции <code>coroutine.yield</code>.</p>
<div class="exampleblock">
<div class="content">
<div id="code-3.4" class="listingblock">
<div class="title">Листинг 3.4. Вызов <code>coroutine.yield</code>.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">co</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
  <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-mi">42</span><span class="tok-p">,</span> <span class="tok-mi">21</span><span class="tok-p">,</span> <span class="tok-mi">7</span><span class="tok-p">)</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; true    42      21      7</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1">Если корутина достигла конца исполнения</dt>
<dd>
<p>Первое значение — <code>true</code>, остальные — то, что вернула корутина.</p>
<div class="exampleblock">
<div class="content">
<div id="code-3.5" class="listingblock">
<div class="title">Листинг 3.5. Возврат в корутине.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">co</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
  <span class="tok-kr">return</span> <span class="tok-mi">7</span><span class="tok-p">,</span> <span class="tok-mi">21</span><span class="tok-p">,</span> <span class="tok-mi">42</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; true    7       21      42</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
</dd>
</dl>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>coroutine.yield(...)</code></dt>
<dd>
<p>Приостанавливает выполнение корутины.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Аргументы этой функции возвращаются в вызов <code>coroutine.resume</code>.</p>
</div>
<div class="paragraph">
<p>Возвращает данные, переданные аргументами при следующем вызове <code>coroutine.resume</code>.</p>
</div>
<div class="paragraph">
<p>Эту функцию можно вызвать только внутри корутины.
Если попытаться сделать это вне корутины (в главном потоке), выбросит ошибку.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="code-3.6" class="listingblock">
<div class="title">Листинг 3.6. Вызов <code>coroutine.yield</code> вне корутины.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><pre><span></span><span class="tok-nb">coroutine.yield</span><span class="tok-p">()</span>
<span class="tok-c1">--! attempt to yield from outside a coroutine</span>
<span class="tok-c1">--! stack traceback:</span>
<span class="tok-c1">--!        [C]: in function 'coroutine.yield'</span>
<span class="tok-c1">--!        example.lua:1: in main chunk</span>
<span class="tok-c1">--!        [C]: in ?</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div id="yield-across-c" class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="imageblock right text-center">
<div class="content">
<img src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/yield-across-c.png" alt="yield across c" width="253" height="377">
</div>
<div class="title">Рисунок 1. Опасная схема вызовов.</div>
</div>
<div class="paragraph">
<p><code>coroutine.yield</code> может выбросить ошибку даже внутри корутины.
Это бывает, если вызвать <code>coroutine.yield</code> внутри Lua-функции, которую вызывает определённая C-функция внутри корутины.
Конкретно то, какие это C-функции, зависит от их внутренностей, в которые не будем вдаваться.
Вот все найденные мною случаи (<code>y</code> во всех случаях — это функция, вызывающая <code>coroutine.yield</code>):</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Нет проблем</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>load("coroutine.yield()")()</code></p>
</li>
<li>
<p><code>pcall(<strong>y</strong>)</code></p>
</li>
<li>
<p><code>xpcall(<strong>y</strong>)</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Могут быть проблемы</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Внутри метаметода <code>__gc</code></p>
</li>
<li>
<p><code>load(<strong>y</strong>)</code></p>
</li>
<li>
<p><code>xpcall(f, <strong>y</strong>)</code></p>
</li>
<li>
<p><code>ipairs(t)</code>, если у <code>t</code> метаметод <code>__ipairs</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>pairs(t)</code>, если у <code>t</code> метаметод <code>__pairs</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>require</code>, если у <code>package.searchers</code> метаметод <code>__index</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>require</code>, если у <code>package.loaded</code> метаметод <code>__index</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>require</code>, если у <code>package.preload</code> метаметод <code>__index</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>require</code>, если у <code>package.loaded</code> метаметод <code>__newindex</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>print(t)</code>, если у <code>t</code> метаметод <code>__tostring</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>tostring(t)</code>, если у <code>t</code> метаметод <code>__tostring</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>string.format("%s", t)</code>, если у <code>t</code> метаметод <code>__tostring</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>string.gsub(s, pattern, <strong>y</strong>)</code></p>
</li>
<li>
<p><code>string.gsub(s, pattern, t)</code>, если у <code>t</code> метаметод <code>__index</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>table.insert(t)</code>, если у <code>t</code> метаметод <code>__index</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>table.insert(t)</code>, если у <code>t</code> метаметод <code>__newindex</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>table.insert(t)</code>, если у <code>t</code> метаметод <code>__len</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>table.concat(t)</code>, если у <code>t</code> метаметод <code>__len</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>table.concat(t)</code>, если у <code>t</code> метаметод <code>__index</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>table.move(t1, f, e, t, t2)</code>, если у <code>t1</code> метаметод <code>__index</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>table.move(t1, f, e, t, t2)</code>, если у <code>t2</code> метаметод <code>__newindex</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>table.remove(t)</code>, если у <code>t</code> метаметод <code>__len</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>table.remove(t)</code>, если у <code>t</code> метаметод <code>__index</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>table.remove(t)</code>, если у <code>t</code> метаметод <code>__newindex</code> — <code><strong>y</strong></code>.</p>
</li>
<li>
<p><code>table.sort(t, f)</code>, если у <code>t</code> метаметод <code>__len</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>table.sort(t, f)</code>, если у <code>t</code> метаметод <code>__index</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>table.sort(t, <strong>y</strong>)</code></p>
</li>
<li>
<p><code>table.unpack(t)</code>, если у <code>t</code> метаметод <code>__len</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>table.unpack(t)</code>, если у <code>t</code> метаметод <code>__index</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>os.time(t)</code>, если у <code>t</code> метаметод <code>__index</code> — <code><strong>y</strong></code></p>
</li>
<li>
<p><code>debug.sethook(<strong>y</strong>, mask)</code></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Поэтому будьте осторожны, если будете вызывать <code>coroutine.yield</code> внутри метаметодов.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="code-3.7" class="listingblock">
<div class="title">Листинг 3.7. Ошибка <code>"attempt to yield across a C-call boundary"</code>.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><pre><span></span><span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
  <span class="tok-kr">return</span> <span class="tok-nb">pairs</span><span class="tok-p">(</span><span class="tok-nb">setmetatable</span><span class="tok-p">({},</span> <span class="tok-p">{</span><span class="tok-n">__pairs</span> <span class="tok-o">=</span> <span class="tok-kr">function</span><span class="tok-p">()</span>
    <span class="tok-kr">return</span> <span class="tok-nb">coroutine.yield</span><span class="tok-p">()</span>
  <span class="tok-kr">end</span><span class="tok-p">}))</span>
<span class="tok-kr">end</span><span class="tok-p">)))</span>
<span class="tok-c1">--&gt; false   attempt to yield across a C-call boundary</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>См. <a href="#coroutine.isyieldable">[coroutine.isyieldable]</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>coroutine.running()</code></dt>
<dd>
<p>Возвращает корутину, в которой вызвана эта функция.</p>
<div class="paragraph">
<p>Вторым значением также возвращает <code>true</code>, если функция вызвана в главном потоке, или <code>false</code> в противном случае.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="code-3.8" class="listingblock">
<div class="title">Листинг 3.8. Вызов <code>coroutine.running</code> в корутине.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><pre><span></span><span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-nb">coroutine.running</span><span class="tok-p">())</span>
<span class="tok-kr">end</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; thread: 0x558a80ef07e8  false</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="code-3.9" class="listingblock">
<div class="title">Листинг 3.9. Вызов <code>coroutine.running</code> в главном потоке.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><pre><span></span><span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-nb">coroutine.running</span><span class="tok-p">())</span>
<span class="tok-c1">--&gt; thread: 0x558a80e92268  true</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>coroutine.wrap(f)</code></dt>
<dd>
<p>Создаёт новую корутину из функции <code>f</code>.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Возвращает новую функцию: при её вызове корутина возобновляется с переданными аргументами.
Возвращает эта функция всё, что передаст корутина.</p>
</div>
<div class="paragraph">
<p>Если возникает ошибка, <code>coroutine.wrap</code> не перехватывает её, в отличие от <code>coroutine.resume</code>.</p>
</div>
<div id="code-3.10" class="listingblock">
<div class="title">Листинг 3.10. Вариант <code>coroutine.wrap</code> на чистом Lua.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><pre><span></span><span class="tok-kr">function</span> <span class="tok-nc">coroutine</span><span class="tok-p">.</span><span class="tok-nf">wrap</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">)</span>
  <span class="tok-kd">local</span> <span class="tok-n">co</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">)</span>

  <span class="tok-kr">return</span> <span class="tok-kr">function</span><span class="tok-p">(...)</span>
    <span class="tok-kd">local</span> <span class="tok-n">executionResult</span> <span class="tok-o">=</span> <span class="tok-nb">table.pack</span><span class="tok-p">(</span><span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">,</span> <span class="tok-p">...))</span>

    <span class="tok-kr">if</span> <span class="tok-n">executionResult</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-kr">then</span>
      <span class="tok-kr">return</span> <span class="tok-nb">table.unpack</span><span class="tok-p">(</span><span class="tok-n">executionResult</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-n">executionResult</span><span class="tok-p">.</span><span class="tok-n">n</span><span class="tok-p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-kr">else</span>
      <span class="tok-nb">error</span><span class="tok-p">(</span><span class="tok-n">executionResult</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">],</span> <span class="tok-mi">2</span><span class="tok-p">)</span>
    <span class="tok-kr">end</span>
  <span class="tok-kr">end</span>
<span class="tok-kr">end</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>coroutine.wrap</code> возвращает только то, что передала корутина.
Этим она также отличается от <code>coroutine.resume</code>: та добавляет ещё <code>true</code>/<code>false</code> первым значением.</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>coroutine.status(co)</code></dt>
<dd>
<p>Возвращает статус корутины <code>co</code>:</p>
<div class="openblock">
<div class="content">
<div class="hdlist">
<table>
<tbody><tr>
<td class="hdlist1">
<code>"running"</code>
</td>
<td class="hdlist2">
<p><code>co</code> — корутина, которая вызвала <code>coroutine.status</code>.</p>
<div class="exampleblock">
<div class="content">
<div id="code-2.11" class="listingblock">
<div class="title">Листинг 3.11. Статус <code>"running"</code>.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><pre><span></span><span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-nb">coroutine.status</span><span class="tok-p">(</span><span class="tok-nb">coroutine.running</span><span class="tok-p">()))</span>
<span class="tok-kr">end</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; running</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>"suspended"</code>
</td>
<td class="hdlist2">
<p>Корутина ещё не запускалась или была приостановлена вызовом <code>coroutine.yield</code>.</p>
<div class="exampleblock">
<div class="content">
<div id="code-3.12" class="listingblock">
<div class="title">Листинг 3.12. Статус <code>"suspended"</code>.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">co</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
  <span class="tok-nb">coroutine.yield</span><span class="tok-p">()</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-nb">coroutine.status</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">))</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-c1">--&gt; suspended</span>

<span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-nb">coroutine.status</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; suspended</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Корутина ещё не запущена.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Корутина приостановлена вызовом <code>coroutine.yield</code>.</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>"normal"</code>
</td>
<td class="hdlist2">
<p>Корутина запустила другую корутину.</p>
<div class="exampleblock">
<div class="content">
<div id="code-3.13" class="listingblock">
<div class="title">Листинг 3.13. Статус <code>"normal"</code>.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">mainThread</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.running</span><span class="tok-p">()</span>

<span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-nb">coroutine.status</span><span class="tok-p">(</span><span class="tok-n">mainThread</span><span class="tok-p">))</span>
<span class="tok-kr">end</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; normal</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>"dead"</code>
</td>
<td class="hdlist2">
<p>Корутина завершила свою работу: или достигнув конца, или из-за ошибки.</p>
<div class="paragraph">
<p>Исполнение такой корутины больше нельзя возобновить.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="code-3.14" class="listingblock">
<div class="title">Листинг 3.14. Статус <code>"dead"</code>.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">co</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span> <span class="tok-kr">end</span><span class="tok-p">)</span>
<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; true</span>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-nb">coroutine.status</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; dead</span>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; false   cannot resume dead coroutine</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="code-3.15" class="listingblock">
<div class="title">Листинг 3.15. Статус <code>"dead"</code> в результате ошибки.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">co</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
  <span class="tok-nb">error</span><span class="tok-p">(</span><span class="tok-s2">"error example"</span><span class="tok-p">)</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>

<span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">)</span>
<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-nb">coroutine.status</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; dead</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</dd>
<dt class="hdlist1"><code>coroutine.isyieldable()</code></dt>
<dd>
<p><a id="coroutine.isyieldable"></a> Возвращает <code>true</code>, если можно вызвать <code>coroutine.yield</code>.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Если эта функция вернула <code>true</code>, то:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>она была вызвана в работающей корутине</p>
</li>
<li>
<p>и вызов этой функции не находится внутри C-функции, откуда <a href="#yield-across-c">нельзя вызвать <code>coroutine.yield</code></a>.</p>
</li>
</ul>
</div>
</div>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_классификация_корутин"><a class="anchor" href="#_классификация_корутин"></a><a class="link" href="#_классификация_корутин">4. Классификация корутин</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>В разных языках корутины тоже разные.</p>
</div>
<div class="ulist">
<div class="title">Механизм передачи управления</div>
<ul>
<li>
<p><strong>Асимметричный</strong>: есть иерархия корутин.</p>
<div class="paragraph">
<p><em>Используется в Lua.</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>У любой корутины, кроме главной, есть вызвавшая её “родительская” корутина.</p>
</li>
<li>
<p>Когда корутина завершается, она не может выбрать, куда отдать значение: его получит родитель.</p>
</li>
<li>
<p>Функция обычная работает так же: когда завершается, значения тоже возвращаются вызвавшему её коду.</p>
</li>
<li>
<p>Есть отдельные операции <code>resume</code> и <code>yield</code>.</p>
</li>
<li>
<p>Проще в понимании.</p>
</li>
<li>
<p>Применяют в языках, где в основном корутины — итераторы.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/asymmetric-hierarchy.png" alt="asymmetric hierarchy" width="1195" height="59">
</div>
<div class="title">Рисунок 2. Иерархия асимметричных корутин.</div>
</div>
</li>
<li>
<p><strong>Симметричный</strong>: иерархии корутин нет.</p>
<div class="ulist">
<ul>
<li>
<p>Корутины могут выбрать, куда передать значение.</p>
</li>
<li>
<p>Сделать просто <code>yield</code>, не указывая корутины, они не могут.</p>
</li>
<li>
<p><code>resume</code> и <code>yield</code> — одна операция: корутина приостанавливает себя и запускает другую.</p>
</li>
<li>
<p>Управлять ими гораздо сложнее.</p>
</li>
<li>
<p>Обычно присутствуют в языках, которые реализуют через них многопоточность.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/symmetric-hierarchy.png" alt="symmetric hierarchy" width="1075" height="59">
</div>
<div class="title">Рисунок 3. Иерархия симметричных корутин.</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Здесь не тот случай, когда сложность компенсируется мощью.
Из асимметричных корутин <a href="#_преобразование_в_симметричную_корутину">делаются симметричные</a> и наоборот.
Поэтому языкам достаточно предоставить одну из двух реализаций.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>В Lua корутина — <strong>объект первого класса</strong> (как и числа, строки, функции — и другие типы данных в Lua):</p>
<div class="ulist">
<ul>
<li>
<p>Её можно записать в переменную.</p>
</li>
<li>
<p>Её можно передать аргументом функции.</p>
</li>
<li>
<p>Она может не иметь имени (то есть не требуется в переменную сложить сначала, чтобы использовать).</p>
</li>
<li>
<p>Её может вернуть функция.</p>
</li>
<li>
<p>Её можно создать в процессе работы программы (в рантайме).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Бывают <strong>ограниченные</strong> корутины: например, если использовать можно только в цикле.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ещё один вид классификации — по тому, откуда делается <code>yield</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Только в главной функции.</strong></p>
<div class="paragraph">
<p>Если вызвать внутри корутины функцию, то <code>yield</code> внутри её будет ошибкой.
(Пример: генераторы в Python.)</p>
</div>
</li>
<li>
<p><strong>Откуда угодно</strong> — то есть у них есть свой стэк вызовов.</p>
<div class="paragraph">
<p><em>Это путь Lua.</em>
Такие корутины удобнее и мощнее.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="code-4.1" class="listingblock">
<div class="title">Листинг 4.1. <code>coroutine.yield</code> из функции внутри корутины.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">inner</span><span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-p">)</span>
  <span class="tok-kr">return</span> <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>

<span class="tok-kd">local</span> <span class="tok-n">co</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.wrap</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-p">)</span>
  <span class="tok-kr">return</span> <span class="tok-mi">2</span> <span class="tok-o">*</span> <span class="tok-n">inner</span><span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-p">)</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">(</span><span class="tok-mi">3</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; 3</span>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">(</span><span class="tok-mi">21</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; 42</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="openblock videoblock text-center">
<div class="content">
<video controls="controls" preload="metadata">
<source src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/4-1.mp4" type="video/mp4">
</video>
<ul class="controls">
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.max(event.target.parentNode.parentNode.parentNode.children[0].currentTime - 1/4, 0)">
← 1 кадр туда
</button>
</li>
<li class="rate-slider">
<div>4 FPS</div>
<input type="range" min="1" max="20" step="1" value="4" autocomplete="off" onchange="event.target.parentNode.parentNode.parentNode.children[0].playbackRate = event.target.value / 4; event.target.parentNode.children[0].innerText = event.target.value + ' FPS'">
</li>
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.min(event.target.parentNode.parentNode.parentNode.children[0].currentTime + 1/4, event.target.parentNode.parentNode.parentNode.children[0].duration)">
1 кадр туда →
</button>
</li>
</ul>
</div>
</div>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Итак, корутины в Луа асимметричные, являются объектами первого класса и имеют стэк вызовов.
Дальше будем использовать это.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_преобразования"><a class="anchor" href="#_преобразования"></a><a class="link" href="#_преобразования">5. Преобразования</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Корутины в Lua используются редко, ибо часто можно обойтись без них.
Но если знать, как переписать код без корутин, станет понятно, когда делать обратное.</p>
</div>
<div class="sect2">
<h3 id="_преобразование_в_симметричную_корутину"><a class="anchor" href="#_преобразование_в_симметричную_корутину"></a><a class="link" href="#_преобразование_в_симметричную_корутину">5.1. Преобразование в симметричную корутину</a></h3>
<div class="paragraph">
<p>Чтобы реализовать симметричный механизм передачи управления, придумаем функцию <code>transfer</code>,
которая сочетает в себе <code>yield</code> работающей корутины и <code>resume</code> другой.</p>
</div>
<div class="paragraph">
<p>Первое сделать просто: вызвать <code>coroutine.yield</code>.
Второе — проблема: если корутина останавливает себя, то кому запускать другую корутину?
Поэтому нужен "оркестратор": он запускает все корутины, и поэтому к нему они возвращаются при <code>yield</code>.
Так мы минимизируем высоту иерархии.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/sym-impl-hierarchy.png" alt="sym impl hierarchy" width="879" height="155">
</div>
<div class="title">Рисунок 4. Иерархия корутин в нашей реализации.</div>
</div>
<div id="code-5.1.1" class="listingblock">
<div class="title">Листинг 5.1.1. Симметричные корутины в Lua.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">mainThread</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.running</span><span class="tok-p">()</span>

<span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">transfer</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">,</span> <span class="tok-p">...)</span>
  <span class="tok-kr">if</span> <span class="tok-nb">coroutine.running</span><span class="tok-p">()</span> <span class="tok-o">~=</span> <span class="tok-n">mainThread</span> <span class="tok-kr">then</span>
    <span class="tok-kr">return</span> <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">,</span> <span class="tok-p">...)</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-kr">end</span>

  <span class="tok-kd">local</span> <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-nb">table.pack</span><span class="tok-p">(...)</span>

  <span class="tok-kr">while</span> <span class="tok-kc">true</span> <span class="tok-kr">do</span>
    <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-nb">table.pack</span><span class="tok-p">(</span>
      <span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span>
        <span class="tok-n">co</span><span class="tok-p">,</span>
        <span class="tok-nb">table.unpack</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-p">,</span>
                     <span class="tok-mi">1</span><span class="tok-p">,</span>
                     <span class="tok-n">data</span><span class="tok-p">.</span><span class="tok-n">n</span><span class="tok-p">)</span>
      <span class="tok-p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-p">)</span>

    <span class="tok-kd">local</span> <span class="tok-n">success</span> <span class="tok-o">=</span> <span class="tok-nb">table.remove</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">)</span>

    <span class="tok-kr">if</span> <span class="tok-ow">not</span> <span class="tok-n">success</span> <span class="tok-kr">then</span>
      <span class="tok-nb">error</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">])</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-kr">end</span>

    <span class="tok-n">data</span><span class="tok-p">.</span><span class="tok-n">n</span> <span class="tok-o">=</span> <span class="tok-n">data</span><span class="tok-p">.</span><span class="tok-n">n</span> <span class="tok-o">-</span> <span class="tok-mi">1</span>

    <span class="tok-kr">if</span> <span class="tok-nb">coroutine.status</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-s2">"dead"</span> <span class="tok-kr">then</span>
      <span class="tok-kr">return</span> <span class="tok-nb">table.unpack</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-p">.</span><span class="tok-n">n</span><span class="tok-p">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-kr">end</span>

    <span class="tok-n">co</span> <span class="tok-o">=</span> <span class="tok-nb">table.remove</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
    <span class="tok-n">data</span><span class="tok-p">.</span><span class="tok-n">n</span> <span class="tok-o">=</span> <span class="tok-n">data</span><span class="tok-p">.</span><span class="tok-n">n</span> <span class="tok-o">-</span> <span class="tok-mi">1</span>

    <span class="tok-kr">if</span> <span class="tok-n">co</span> <span class="tok-o">==</span> <span class="tok-n">mainThread</span> <span class="tok-kr">then</span>
      <span class="tok-kr">return</span> <span class="tok-nb">table.unpack</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-p">.</span><span class="tok-n">n</span><span class="tok-p">)</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="tok-kr">end</span>

    <i class="conum" data-value="6"></i><b>(6)</b>
  <span class="tok-kr">end</span>
<span class="tok-kr">end</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Вызвано внутри корутины — делаем <code>yield</code> в главный поток.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Вызвано в главном потоке.
Запускаем корутину, передаём все данные.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Если корутина завершается с ошибкой, то её выбрасываем.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Если корутина сделала ретурн, то возвращаем результат.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Если корутина передала исполнение в главную, также возвращаем результат.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Корутина передала исполнение в другую корутину — зацикливаемся.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Эта реализация позволяет корутине завершаться с помощью <code>return</code>, а не <code>transfer(mainThread)</code>.
Можно сделать обёртку вокруг <code>coroutine.create</code>, которая бы добавляла <code>error</code> в таком случае.</p>
</div>
<div id="code-5.1.2" class="listingblock">
<div class="title">Листинг 5.1.2. Симметричные корутины. Обёртка вокруг <code>coroutine.create</code>.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">createCoroutine</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">)</span>
  <span class="tok-kr">return</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
    <span class="tok-n">f</span><span class="tok-p">()</span>
    <span class="tok-nb">error</span><span class="tok-p">(</span><span class="tok-s2">"coroutine returned"</span><span class="tok-p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-kr">end</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Если исполнение достигает этой строки, то вызов <code>f()</code> выше завершился.
То есть функция или дошла до конца, или сделала <code>return</code>.
Поэтому кидаем ошибку.</td>
</tr>
</tbody></table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Воспользуемся симметричными корутинами для построчного копирования файла.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Конкретно потребности в симметричных тут нет (на асимметричных даже удобнее),
но сойдёт как первый пример в этом гайде, который делает что-то полезное.
</td>
</tr>
</tbody></table>
</div>
<div id="code-5.1.3" class="listingblock">
<div class="title">Листинг 5.1.3. Копирование файлов на симметричных корутинах.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">writer</span><span class="tok-p">,</span> <span class="tok-n">reader</span>

<span class="tok-n">writer</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">)</span>
  <span class="tok-kr">while</span> <span class="tok-kc">true</span> <span class="tok-kr">do</span>
    <span class="tok-kd">local</span> <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">transfer</span><span class="tok-p">(</span><span class="tok-n">reader</span><span class="tok-p">)</span>

    <span class="tok-kr">if</span> <span class="tok-n">line</span> <span class="tok-kr">then</span>
      <span class="tok-n">f</span><span class="tok-p">:</span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
    <span class="tok-kr">else</span>
      <span class="tok-kr">break</span>
    <span class="tok-kr">end</span>
  <span class="tok-kr">end</span>

  <span class="tok-n">transfer</span><span class="tok-p">(</span><span class="tok-n">mainThread</span><span class="tok-p">,</span> <span class="tok-n">f</span><span class="tok-p">)</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>

<span class="tok-n">reader</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
  <span class="tok-kr">for</span> <span class="tok-n">line</span> <span class="tok-kr">in</span> <span class="tok-nb">io.lines</span><span class="tok-p">(</span><span class="tok-s2">"sym.lua"</span><span class="tok-p">,</span> <span class="tok-s2">"L"</span><span class="tok-p">)</span> <span class="tok-kr">do</span>
    <span class="tok-n">transfer</span><span class="tok-p">(</span><span class="tok-n">writer</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-p">)</span>
  <span class="tok-kr">end</span>

  <span class="tok-n">transfer</span><span class="tok-p">(</span><span class="tok-n">writer</span><span class="tok-p">,</span> <span class="tok-kc">nil</span><span class="tok-p">)</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>

<span class="tok-kd">local</span> <span class="tok-n">f</span> <span class="tok-o">=</span> <span class="tok-n">transfer</span><span class="tok-p">(</span><span class="tok-n">writer</span><span class="tok-p">,</span> <span class="tok-nb">io.open</span><span class="tok-p">(</span><span class="tok-s2">"sym-copy.lua"</span><span class="tok-p">,</span> <span class="tok-s2">"w"</span><span class="tok-p">))</span>
<span class="tok-n">f</span><span class="tok-p">:</span><span class="tok-n">close</span><span class="tok-p">()</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="openblock videoblock text-center">
<div class="content">
<video controls="controls" preload="metadata">
<source src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/5-1-3.mp4" type="video/mp4">
</video>
<ul class="controls">
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.max(event.target.parentNode.parentNode.parentNode.children[0].currentTime - 1/4, 0)">
← 1 кадр туда
</button>
</li>
<li class="rate-slider">
<div>4 FPS</div>
<input type="range" min="1" max="20" step="1" value="4" autocomplete="off" onchange="event.target.parentNode.parentNode.parentNode.children[0].playbackRate = event.target.value / 4; event.target.parentNode.children[0].innerText = event.target.value + ' FPS'">
</li>
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.min(event.target.parentNode.parentNode.parentNode.children[0].currentTime + 1/4, event.target.parentNode.parentNode.parentNode.children[0].duration)">
1 кадр туда →
</button>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_переписывание_без_корутин"><a class="anchor" href="#_переписывание_без_корутин"></a><a class="link" href="#_переписывание_без_корутин">5.2. Переписывание без корутин</a></h3>
<div class="paragraph">
<p>В большинстве случаев от корутин можно избавиться в принципе.
Если можно переписать содержимое главной функции, то во всех.
Один такой пример я уже показывал — смотрите <a href="#_итератор_фибоначчи">секцию про итератор</a>.
Идея состоит в том, чтобы вынести весь стейт в нелокальные переменные, а сам код превратить в замыкание.
Например, из цикла <code>for i = …​</code> вынести переменную <code>i</code> и в функции самому увеличивать счётчик.</p>
</div>
<div class="paragraph">
<p>Ещё вариант. Если делается <code>coroutine.yield</code> посреди функции, то её можно разделить на две части:
в первой всё, что до <code>yield</code>, во второй то, что после.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="code-5.2.1" class="listingblock">
<div class="title">Листинг 5.2.1. Переписывание без корутин: деление функции. С корутинами.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">f</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.wrap</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">)</span>
  <span class="tok-kd">local</span> <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-o">*</span> <span class="tok-mi">2</span><span class="tok-p">)</span>
  <span class="tok-kr">return</span> <span class="tok-n">a</span> <span class="tok-o">+</span> <span class="tok-n">b</span> <span class="tok-o">*</span> <span class="tok-mi">2</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">(</span><span class="tok-mi">3</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; 6</span>
<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">(</span><span class="tok-mi">6</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; 15</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="openblock videoblock text-center">
<div class="content">
<video controls="controls" preload="metadata">
<source src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/5-2-1.mp4" type="video/mp4">
</video>
<ul class="controls">
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.max(event.target.parentNode.parentNode.parentNode.children[0].currentTime - 1/4, 0)">
← 1 кадр туда
</button>
</li>
<li class="rate-slider">
<div>4 FPS</div>
<input type="range" min="1" max="20" step="1" value="4" autocomplete="off" onchange="event.target.parentNode.parentNode.parentNode.children[0].playbackRate = event.target.value / 4; event.target.parentNode.children[0].innerText = event.target.value + ' FPS'">
</li>
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.min(event.target.parentNode.parentNode.parentNode.children[0].currentTime + 1/4, event.target.parentNode.parentNode.parentNode.children[0].duration)">
1 кадр туда →
</button>
</li>
</ul>
</div>
</div>
<div id="code-5.2.2" class="listingblock">
<div class="title">Листинг 5.2.2. Переписывание без корутин: деление функции. Без корутин.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">f</span> <span class="tok-kr">do</span>
  <span class="tok-kd">local</span> <span class="tok-n">beforeYield</span> <span class="tok-o">=</span> <span class="tok-kc">true</span>
  <span class="tok-kd">local</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span>

  <span class="tok-n">f</span> <span class="tok-o">=</span> <span class="tok-kr">function</span><span class="tok-p">(</span><span class="tok-n">val</span><span class="tok-p">)</span>
    <span class="tok-kr">if</span> <span class="tok-n">beforeYield</span> <span class="tok-kr">then</span>
      <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-n">val</span>
      <span class="tok-n">beforeYield</span> <span class="tok-o">=</span> <span class="tok-kc">false</span>
      <span class="tok-kr">return</span> <span class="tok-n">a</span> <span class="tok-o">*</span> <span class="tok-mi">2</span>
    <span class="tok-kr">else</span>
      <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-n">val</span>
      <span class="tok-kr">return</span> <span class="tok-n">a</span> <span class="tok-o">+</span> <span class="tok-n">b</span> <span class="tok-o">*</span> <span class="tok-mi">2</span>
    <span class="tok-kr">end</span>
  <span class="tok-kr">end</span>
<span class="tok-kr">end</span>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">(</span><span class="tok-mi">3</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; 6</span>
<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">(</span><span class="tok-mi">6</span><span class="tok-p">))</span>
<span class="tok-c1">--&gt; 15</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="openblock videoblock text-center">
<div class="content">
<video controls="controls" preload="metadata">
<source src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/5-2-2.mp4" type="video/mp4">
</video>
<ul class="controls">
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.max(event.target.parentNode.parentNode.parentNode.children[0].currentTime - 1/4, 0)">
← 1 кадр туда
</button>
</li>
<li class="rate-slider">
<div>4 FPS</div>
<input type="range" min="1" max="20" step="1" value="4" autocomplete="off" onchange="event.target.parentNode.parentNode.parentNode.children[0].playbackRate = event.target.value / 4; event.target.parentNode.children[0].innerText = event.target.value + ' FPS'">
</li>
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.min(event.target.parentNode.parentNode.parentNode.children[0].currentTime + 1/4, event.target.parentNode.parentNode.parentNode.children[0].duration)">
1 кадр туда →
</button>
</li>
</ul>
</div>
</div>
<div class="paragraph">
<p>Без корутин получилось страшнее, не так ли?</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Третий способ избавиться от корутин — поменяться местами между генератором и обработчиком.
То есть сделать так, чтобы не обработчик вызвал генератор, а наоборот.
Например, передать обработчик как коллбэк.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="code-5.2.3" class="listingblock">
<div class="title">Листинг 5.2.3. Обход дерева с корутинами.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">dfsPreOrder</span> <span class="tok-kr">do</span>
<span class="hll">  <span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">traverse</span><span class="tok-p">(</span><span class="tok-n">node</span><span class="tok-p">)</span>
</span><span class="hll">    <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">node</span><span class="tok-p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
</span><span class="hll">
</span><span class="hll">    <span class="tok-kr">for</span> <span class="tok-n">_</span><span class="tok-p">,</span> <span class="tok-n">child</span> <span class="tok-kr">in</span> <span class="tok-nb">ipairs</span><span class="tok-p">(</span><span class="tok-n">node</span><span class="tok-p">.</span><span class="tok-n">children</span><span class="tok-p">)</span> <span class="tok-kr">do</span>
</span><span class="hll">      <span class="tok-n">traverse</span><span class="tok-p">(</span><span class="tok-n">child</span><span class="tok-p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
</span><span class="hll">    <span class="tok-kr">end</span>
</span><span class="hll">  <span class="tok-kr">end</span>
</span>
  <span class="tok-n">dfsPreOrder</span> <span class="tok-o">=</span> <span class="tok-kr">function</span><span class="tok-p">(</span><span class="tok-n">node</span><span class="tok-p">)</span>
    <span class="tok-kr">return</span> <span class="tok-nb">coroutine.wrap</span><span class="tok-p">(</span><span class="tok-n">traverse</span><span class="tok-p">),</span> <span class="tok-n">node</span> <i class="conum" data-value="3"></i><b>(3)</b>
  <span class="tok-kr">end</span>
<span class="tok-kr">end</span>

<span class="tok-kd">local</span> <span class="tok-n">count</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>

<span class="tok-kr">for</span> <span class="tok-n">node</span> <span class="tok-kr">in</span> <span class="tok-n">dfsPreOrder</span><span class="tok-p">(</span><span class="tok-n">node</span><span class="tok-p">)</span> <span class="tok-kr">do</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">node</span><span class="tok-p">.</span><span class="tok-n">content</span><span class="tok-p">)</span>
  <span class="tok-n">count</span> <span class="tok-o">=</span> <span class="tok-n">count</span> <span class="tok-o">+</span> <span class="tok-mi">1</span>

  <span class="tok-kr">if</span> <span class="tok-n">count</span> <span class="tok-o">&gt;</span> <span class="tok-mi">30</span> <span class="tok-kr">then</span>
    <span class="tok-kr">break</span> <i class="conum" data-value="4"></i><b>(4)</b>
  <span class="tok-kr">end</span>
<span class="tok-kr">end</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Возвращаем текущую ноду.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Затем обрабатываем детей (рекурсивно).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Возвращаем саму функцию-итератор и первое значение.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Останавливаем итерацию привычным <code>break</code>.</td>
</tr>
</tbody></table>
</div>
<div class="openblock videoblock text-center">
<div class="content">
<video controls="controls" preload="metadata">
<source src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/5-2-3.mp4" type="video/mp4">
</video>
<ul class="controls">
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.max(event.target.parentNode.parentNode.parentNode.children[0].currentTime - 1/4, 0)">
← 1 кадр туда
</button>
</li>
<li class="rate-slider">
<div>4 FPS</div>
<input type="range" min="1" max="20" step="1" value="4" autocomplete="off" onchange="event.target.parentNode.parentNode.parentNode.children[0].playbackRate = event.target.value / 4; event.target.parentNode.children[0].innerText = event.target.value + ' FPS'">
</li>
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.min(event.target.parentNode.parentNode.parentNode.children[0].currentTime + 1/4, event.target.parentNode.parentNode.parentNode.children[0].duration)">
1 кадр туда →
</button>
</li>
</ul>
</div>
</div>
<div id="code-5.2.4" class="listingblock">
<div class="title">Листинг 5.2.4. Обход дерева с обработчиком.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">dfsPreOrder</span><span class="tok-p">(</span><span class="tok-n">node</span><span class="tok-p">,</span> <span class="tok-n">f</span><span class="tok-p">)</span>
  <span class="tok-kr">if</span> <span class="tok-n">f</span><span class="tok-p">(</span><span class="tok-n">node</span><span class="tok-p">)</span> <span class="tok-kr">then</span>
    <span class="tok-kr">return</span> <span class="tok-kc">true</span>
  <span class="tok-kr">end</span>

  <span class="tok-kr">for</span> <span class="tok-n">_</span><span class="tok-p">,</span> <span class="tok-n">child</span> <span class="tok-kr">in</span> <span class="tok-nb">ipairs</span><span class="tok-p">(</span><span class="tok-n">node</span><span class="tok-p">.</span><span class="tok-n">children</span><span class="tok-p">)</span> <span class="tok-kr">do</span>
    <span class="tok-kr">if</span> <span class="tok-n">dfsPreOrder</span><span class="tok-p">(</span><span class="tok-n">child</span><span class="tok-p">,</span> <span class="tok-n">f</span><span class="tok-p">)</span> <span class="tok-kr">then</span>
      <span class="tok-kr">return</span> <span class="tok-kc">true</span>
    <span class="tok-kr">end</span>
  <span class="tok-kr">end</span>
<span class="tok-kr">end</span>

<span class="tok-kd">local</span> <span class="tok-n">count</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>

<span class="tok-n">dfsPreOrder</span><span class="tok-p">(</span><span class="tok-n">node</span><span class="tok-p">,</span> <span class="tok-kr">function</span><span class="tok-p">(</span><span class="tok-n">node</span><span class="tok-p">)</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">node</span><span class="tok-p">.</span><span class="tok-n">content</span><span class="tok-p">)</span>
  <span class="tok-n">count</span> <span class="tok-o">=</span> <span class="tok-n">count</span> <span class="tok-o">+</span> <span class="tok-mi">1</span>

  <span class="tok-kr">return</span> <span class="tok-n">count</span> <span class="tok-o">&gt;</span> <span class="tok-mi">30</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="openblock videoblock text-center">
<div class="content">
<video controls="controls" preload="metadata">
<source src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/5-2-4.mp4" type="video/mp4">
</video>
<ul class="controls">
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.max(event.target.parentNode.parentNode.parentNode.children[0].currentTime - 1/4, 0)">
← 1 кадр туда
</button>
</li>
<li class="rate-slider">
<div>4 FPS</div>
<input type="range" min="1" max="20" step="1" value="4" autocomplete="off" onchange="event.target.parentNode.parentNode.parentNode.children[0].playbackRate = event.target.value / 4; event.target.parentNode.children[0].innerText = event.target.value + ' FPS'">
</li>
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.min(event.target.parentNode.parentNode.parentNode.children[0].currentTime + 1/4, event.target.parentNode.parentNode.parentNode.children[0].duration)">
1 кадр туда →
</button>
</li>
</ul>
</div>
</div>
<div class="paragraph">
<p>Без корутин кажется проще.
Однако я бы выбрал <a href="#code-5.2.3">вариант первый</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Сам алгоритм (<code>traverse</code>) на самом деле занимает 7 строк против 11 в другом варианте.
Остальное — обёртки, которые опциональны.</p>
</li>
<li>
<p>Можно использовать в цикле <code>for</code> — и останавливать через <code>break</code>, а не костылями.</p>
</li>
<li>
<p>Алгоритм проще расширять.
Ниже разберём пайпинг — его можно здесь использовать.</p>
</li>
<li>
<p>Более строгое разделение обязанностей.
Итератор итерирует, и ему не важно, что с выхлопными значениями делают.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Есть итератор дерева, который итерируется в <code>for</code>, как и первый вариант, но не содержит корутин.
Но его код сложнее, особенно если дерево не бинарное.
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_применение"><a class="anchor" href="#_применение"></a><a class="link" href="#_применение">6. Применение</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Есть несколько юз-кейсов, где корутины очень полезны.
Одно из таких типичных применений корутин — обход дерева.
<a href="#code-5.2.3">О нём я уже рассказал в предыдущей главе</a>.
В этой секции — ещё несколько.</p>
</div>
<div class="sect2">
<h3 id="_пайпинг_итераторы"><a class="anchor" href="#_пайпинг_итераторы"></a><a class="link" href="#_пайпинг_итераторы">6.1. Пайпинг. Итераторы</a></h3>
<div class="paragraph">
<p>Если использовали какого-нибудь родственника юникса, вы наверняка знакомы с пайпингом.
Одна программа генерирует данные, другая их читает и генерирует свои.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ find lua | <i class="conum" data-value="1"></i><b>(1)</b>
  head -n512 | <i class="conum" data-value="2"></i><b>(2)</b>
  gzip &gt; test.gz <i class="conum" data-value="3"></i><b>(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Пролистывает список файлов в директории <code>lua</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Читает список, отрезает первые 512 строк и отдаёт их.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Принимает их, сжимает и выплёвывает байты в <code>test.gz</code>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Сделаем программу на Lua, которая делает то же, что и команда выше.
Программы запустим в корутинах, а читать и передавать данные заставим через <code>yield</code> и <code>resume</code>.</p>
</div>
<div id="code-6.1.1" class="listingblock">
<div class="title">Листинг 6.1.1. Пример пайпинга на корутинах.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">executeRead</span><span class="tok-p">(</span><span class="tok-n">cmd</span><span class="tok-p">)</span>
  <span class="tok-kd">local</span> <span class="tok-n">proc</span> <span class="tok-o">=</span> <span class="tok-nb">io.popen</span><span class="tok-p">(</span><span class="tok-n">cmd</span><span class="tok-p">,</span> <span class="tok-s2">"r"</span><span class="tok-p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>

  <span class="tok-kr">return</span> <span class="tok-nb">coroutine.wrap</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
    <span class="tok-kr">for</span> <span class="tok-n">line</span> <span class="tok-kr">in</span> <span class="tok-n">proc</span><span class="tok-p">:</span><span class="tok-n">lines</span><span class="tok-p">(</span><span class="tok-s2">"L"</span><span class="tok-p">)</span> <span class="tok-kr">do</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-kr">end</span>

    <span class="tok-n">proc</span><span class="tok-p">:</span><span class="tok-n">close</span><span class="tok-p">()</span>
  <span class="tok-kr">end</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>

<span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">head</span><span class="tok-p">(</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-n">producer</span><span class="tok-p">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
  <span class="tok-kr">return</span> <span class="tok-nb">coroutine.wrap</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
    <span class="tok-kr">for</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">n</span> <span class="tok-kr">do</span>
      <span class="tok-kd">local</span> <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">producer</span><span class="tok-p">()</span> <i class="conum" data-value="5"></i><b>(5)</b>

      <span class="tok-kr">if</span> <span class="tok-ow">not</span> <span class="tok-n">line</span> <span class="tok-kr">then</span>
        <span class="tok-kr">break</span>
      <span class="tok-kr">end</span>

      <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span> <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="tok-kr">end</span>
  <span class="tok-kr">end</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>

<span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">executeWrite</span><span class="tok-p">(</span><span class="tok-n">cmd</span><span class="tok-p">,</span> <span class="tok-n">producer</span><span class="tok-p">)</span> <i class="conum" data-value="7"></i><b>(7)</b>
  <span class="tok-kd">local</span> <span class="tok-n">proc</span> <span class="tok-o">=</span> <span class="tok-nb">io.popen</span><span class="tok-p">(</span><span class="tok-n">cmd</span><span class="tok-p">,</span> <span class="tok-s2">"w"</span><span class="tok-p">)</span>

  <span class="tok-kr">for</span> <span class="tok-n">data</span> <span class="tok-kr">in</span> <span class="tok-n">producer</span> <span class="tok-kr">do</span> <i class="conum" data-value="8"></i><b>(8)</b>
    <span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-n">proc</span><span class="tok-p">:</span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-p">))</span>
  <span class="tok-kr">end</span>

  <span class="tok-n">proc</span><span class="tok-p">:</span><span class="tok-n">close</span><span class="tok-p">()</span>
<span class="tok-kr">end</span>

<span class="tok-n">executeWrite</span><span class="tok-p">(</span><span class="tok-s2">"gzip &gt; test.gz"</span><span class="tok-p">,</span> <span class="tok-n">head</span><span class="tok-p">(</span><span class="tok-mi">512</span><span class="tok-p">,</span> <span class="tok-n">executeRead</span><span class="tok-p">(</span><span class="tok-s2">"find lua"</span><span class="tok-p">)))</span> <i class="conum" data-value="9"></i><b>(9)</b>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Запускаем команду для чтения.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Читаем по одной строчке (вместе с <code>\n</code>, чтобы было проще).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Передаём строку через <code>coroutine.yield</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Так как <code>head</code> должен откуда-то читать данные, передаём функции корутину.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Все корутины заключены в <code>coroutine.wrap</code> для простоты, поэтому просто вызываем функцию, чтобы получить строку.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>После того как проверили, что строка есть, передаём её следующему.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Здесь тоже надо корутину передавать, откуда брать данные.
Так как функция не отдаёт данных каких-либо, корутина здесь не нужна.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Читаем строку, проверяем её наличие и скармливаем процессу.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Теперь можно всё сложить в однострочник. Красота!</td>
</tr>
</tbody></table>
</div>
<div class="openblock videoblock text-center">
<div class="content">
<video controls="controls" preload="metadata">
<source src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/6-1-1.mp4" type="video/mp4">
</video>
<ul class="controls">
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.max(event.target.parentNode.parentNode.parentNode.children[0].currentTime - 1/4, 0)">
← 1 кадр туда
</button>
</li>
<li class="rate-slider">
<div>4 FPS</div>
<input type="range" min="1" max="20" step="1" value="4" autocomplete="off" onchange="event.target.parentNode.parentNode.parentNode.children[0].playbackRate = event.target.value / 4; event.target.parentNode.children[0].innerText = event.target.value + ' FPS'">
</li>
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.min(event.target.parentNode.parentNode.parentNode.children[0].currentTime + 1/4, event.target.parentNode.parentNode.parentNode.children[0].duration)">
1 кадр туда →
</button>
</li>
</ul>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/piping-hierarchy.png" alt="piping hierarchy" width="900" height="131">
</div>
<div class="title">Рисунок 5. Иерархия корутин в примере с пайпингом.</div>
</div>
<div class="paragraph">
<p>Конкретно эта программа вам может и не понадобиться.
Но пайпинг полезен не только для такого.
В коде выше мы реализовали три вида функций:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>executeRead</code> — <strong>итератор</strong>.
Это функция, которая каждый раз возвращает очередное значение.
Её можно также уместить в цикл <code>for</code>.</p>
</li>
<li>
<p><code>head</code> — <strong>адаптер</strong>.
Адаптер принимает один итератор (или несколько) и возвращает другой.
Этот отдаёт первые <code>n</code> значений.</p>
</li>
<li>
<p><code>executeWrite</code> — <strong>потребитель</strong> (обработчик).
Потребляет значения из итератора и завершает цепочку.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>В следующем примере придумаем ещё несколько похожих функций,
которые встречаются в других языках программирования.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="code-6.1.2" class="listingblock">
<div class="title">Листинг 6.1.2. Некоторые функции для работы с итераторами.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">unpack</span><span class="tok-p">(</span><span class="tok-n">t</span><span class="tok-p">)</span>
  <span class="tok-kr">return</span> <span class="tok-nb">table.unpack</span><span class="tok-p">(</span><span class="tok-n">t</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">t</span><span class="tok-p">.</span><span class="tok-n">n</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>

<span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">filter</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">,</span> <span class="tok-n">iterator</span><span class="tok-p">)</span>
  <span class="tok-kr">return</span> <span class="tok-nb">coroutine.wrap</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
    <span class="tok-kr">while</span> <span class="tok-kc">true</span> <span class="tok-kr">do</span>
      <span class="tok-kd">local</span> <span class="tok-n">values</span> <span class="tok-o">=</span> <span class="tok-nb">table.pack</span><span class="tok-p">(</span><span class="tok-n">iterator</span><span class="tok-p">())</span>

      <span class="tok-kr">if</span> <span class="tok-n">values</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-kc">nil</span> <span class="tok-kr">then</span>
        <span class="tok-kr">break</span>
      <span class="tok-kr">end</span>

      <span class="tok-kr">if</span> <span class="tok-n">f</span><span class="tok-p">(</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-n">values</span><span class="tok-p">))</span> <span class="tok-kr">then</span>
        <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-n">values</span><span class="tok-p">))</span>
      <span class="tok-kr">end</span>
    <span class="tok-kr">end</span>
  <span class="tok-kr">end</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>

<span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">map</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">,</span> <span class="tok-n">iterator</span><span class="tok-p">)</span>
  <span class="tok-kr">return</span> <span class="tok-nb">coroutine.wrap</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
    <span class="tok-kr">while</span> <span class="tok-kc">true</span> <span class="tok-kr">do</span>
      <span class="tok-kd">local</span> <span class="tok-n">values</span> <span class="tok-o">=</span> <span class="tok-nb">table.pack</span><span class="tok-p">(</span><span class="tok-n">iterator</span><span class="tok-p">())</span>

      <span class="tok-kr">if</span> <span class="tok-n">values</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-kc">nil</span> <span class="tok-kr">then</span>
        <span class="tok-kr">break</span>
      <span class="tok-kr">end</span>

      <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">(</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-n">values</span><span class="tok-p">)))</span>
    <span class="tok-kr">end</span>
  <span class="tok-kr">end</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>

<span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">takeFirst</span><span class="tok-p">(</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-n">iterator</span><span class="tok-p">)</span>
  <span class="tok-kr">return</span> <span class="tok-nb">coroutine.wrap</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
    <span class="tok-kr">for</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">n</span> <span class="tok-kr">do</span>
      <span class="tok-kd">local</span> <span class="tok-n">values</span> <span class="tok-o">=</span> <span class="tok-nb">table.pack</span><span class="tok-p">(</span><span class="tok-n">iterator</span><span class="tok-p">())</span>

      <span class="tok-kr">if</span> <span class="tok-n">values</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-kc">nil</span> <span class="tok-kr">then</span>
        <span class="tok-kr">break</span>
      <span class="tok-kr">end</span>

      <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-n">values</span><span class="tok-p">))</span>
    <span class="tok-kr">end</span>
  <span class="tok-kr">end</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>

<span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">zip</span><span class="tok-p">(...)</span>
  <span class="tok-kd">local</span> <span class="tok-n">iterators</span> <span class="tok-o">=</span> <span class="tok-p">{...}</span>

  <span class="tok-kr">return</span> <span class="tok-nb">coroutine.wrap</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
    <span class="tok-kr">while</span> <span class="tok-kc">true</span> <span class="tok-kr">do</span>
      <span class="tok-kd">local</span> <span class="tok-n">merged</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-n">n</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">}</span>

      <span class="tok-kr">for</span> <span class="tok-n">_</span><span class="tok-p">,</span> <span class="tok-n">iterator</span> <span class="tok-kr">in</span> <span class="tok-nb">ipairs</span><span class="tok-p">(</span><span class="tok-n">iterators</span><span class="tok-p">)</span> <span class="tok-kr">do</span>
        <span class="tok-kd">local</span> <span class="tok-n">values</span> <span class="tok-o">=</span> <span class="tok-nb">table.pack</span><span class="tok-p">(</span><span class="tok-n">iterator</span><span class="tok-p">())</span>

        <span class="tok-kr">if</span> <span class="tok-ow">not</span> <span class="tok-n">values</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-kr">then</span>
          <span class="tok-kr">goto</span> <span class="tok-nl">exhausted</span>
        <span class="tok-kr">end</span>

        <span class="tok-nb">table.move</span><span class="tok-p">(</span><span class="tok-n">values</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">values</span><span class="tok-p">.</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-n">merged</span><span class="tok-p">.</span><span class="tok-n">n</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">merged</span><span class="tok-p">)</span>
        <span class="tok-n">merged</span><span class="tok-p">.</span><span class="tok-n">n</span> <span class="tok-o">=</span> <span class="tok-n">merged</span><span class="tok-p">.</span><span class="tok-n">n</span> <span class="tok-o">+</span> <span class="tok-n">values</span><span class="tok-p">.</span><span class="tok-n">n</span>
      <span class="tok-kr">end</span>

      <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-n">merged</span><span class="tok-p">))</span>
    <span class="tok-kr">end</span>

    <span class="tok-p">::</span><span class="tok-nl">exhausted</span><span class="tok-p">::</span>
  <span class="tok-kr">end</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>

<span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">chain</span><span class="tok-p">(...)</span>
  <span class="tok-kd">local</span> <span class="tok-n">iterators</span> <span class="tok-o">=</span> <span class="tok-p">{...}</span>

  <span class="tok-kr">return</span> <span class="tok-nb">coroutine.wrap</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
    <span class="tok-kr">for</span> <span class="tok-n">_</span><span class="tok-p">,</span> <span class="tok-n">iterator</span> <span class="tok-kr">in</span> <span class="tok-nb">ipairs</span><span class="tok-p">(</span><span class="tok-n">iterators</span><span class="tok-p">)</span> <span class="tok-kr">do</span>
      <span class="tok-kr">while</span> <span class="tok-kc">true</span> <span class="tok-kr">do</span>
        <span class="tok-kd">local</span> <span class="tok-n">values</span> <span class="tok-o">=</span> <span class="tok-nb">table.pack</span><span class="tok-p">(</span><span class="tok-n">iterator</span><span class="tok-p">())</span>

        <span class="tok-kr">if</span> <span class="tok-n">values</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-kc">nil</span> <span class="tok-kr">then</span>
          <span class="tok-kr">break</span>
        <span class="tok-kr">end</span>

        <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-n">values</span><span class="tok-p">))</span>
      <span class="tok-kr">end</span>
    <span class="tok-kr">end</span>
  <span class="tok-kr">end</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>

<span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">only</span><span class="tok-p">(</span><span class="tok-n">nth</span><span class="tok-p">,</span> <span class="tok-n">iterator</span><span class="tok-p">)</span>
  <span class="tok-kr">return</span> <span class="tok-nb">coroutine.wrap</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
    <span class="tok-kr">while</span> <span class="tok-kc">true</span> <span class="tok-kr">do</span>
      <span class="tok-kd">local</span> <span class="tok-n">value</span> <span class="tok-o">=</span> <span class="tok-nb">select</span><span class="tok-p">(</span><span class="tok-n">nth</span><span class="tok-p">,</span> <span class="tok-n">iterator</span><span class="tok-p">())</span>

      <span class="tok-kr">if</span> <span class="tok-n">value</span> <span class="tok-o">==</span> <span class="tok-kc">nil</span> <span class="tok-kr">then</span>
        <span class="tok-kr">break</span>
      <span class="tok-kr">end</span>

      <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">value</span><span class="tok-p">)</span>
    <span class="tok-kr">end</span>
  <span class="tok-kr">end</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>

<span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">iter</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">,</span> <span class="tok-n">state</span><span class="tok-p">,</span> <span class="tok-n">var</span><span class="tok-p">)</span>
  <span class="tok-kr">return</span> <span class="tok-nb">coroutine.wrap</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
    <span class="tok-kr">while</span> <span class="tok-kc">true</span> <span class="tok-kr">do</span>
      <span class="tok-kd">local</span> <span class="tok-n">values</span> <span class="tok-o">=</span> <span class="tok-nb">table.pack</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">(</span><span class="tok-n">state</span><span class="tok-p">,</span> <span class="tok-n">var</span><span class="tok-p">))</span>
      <span class="tok-n">var</span> <span class="tok-o">=</span> <span class="tok-n">values</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span>

      <span class="tok-kr">if</span> <span class="tok-n">var</span> <span class="tok-o">==</span> <span class="tok-kc">nil</span> <span class="tok-kr">then</span>
        <span class="tok-kr">break</span>
      <span class="tok-kr">end</span>

      <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">unpack</span><span class="tok-p">(</span><span class="tok-n">values</span><span class="tok-p">))</span>
    <span class="tok-kr">end</span>
  <span class="tok-kr">end</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="dlist">
<div class="title">Реализованные функции</div>
<dl>
<dt class="hdlist1"><code>iter</code></dt>
<dd>
<p>Преобразовывает итераторы, которые требуют стейт и предыдущее значение, в функцию-замыкание.
Такую можно использовать с другими функциями из этого кода.</p>
</dd>
<dt class="hdlist1"><code>filter</code></dt>
<dd>
<p>Адаптер, который возвращает те значения, для которых <code>f</code> вернёт истинное значение.
Позволяет удобно отфильтровать значения.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">even</span><span class="tok-p">(</span><span class="tok-n">_</span><span class="tok-p">,</span> <span class="tok-n">v</span><span class="tok-p">)</span>
  <span class="tok-kr">return</span> <span class="tok-n">v</span> <span class="tok-o">%</span> <span class="tok-mi">2</span> <span class="tok-o">==</span> <span class="tok-mi">0</span>
<span class="tok-kr">end</span>

<span class="tok-kr">for</span> <span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">v</span> <span class="tok-kr">in</span> <span class="tok-n">filter</span><span class="tok-p">(</span><span class="tok-n">even</span><span class="tok-p">,</span> <span class="tok-n">iter</span><span class="tok-p">(</span><span class="tok-nb">ipairs</span><span class="tok-p">({</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-mi">3</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-mi">5</span><span class="tok-p">})))</span> <span class="tok-kr">do</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">v</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>
<span class="tok-c1">--&gt; 2 2</span>
<span class="tok-c1">--&gt; 4 4</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</dd>
<dt class="hdlist1"><code>map</code></dt>
<dd>
<p>Адаптер, который вызывает <code>f</code> и отдаёт возвращённые значения.
Так их можно преобразовать на лету.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><pre><span></span><span class="tok-kr">for</span> <span class="tok-n">v</span> <span class="tok-kr">in</span> <span class="tok-n">map</span><span class="tok-p">(</span><span class="tok-nb">math.sqrt</span><span class="tok-p">,</span> <span class="tok-n">only</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-n">iter</span><span class="tok-p">(</span><span class="tok-nb">ipairs</span><span class="tok-p">({</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">9</span><span class="tok-p">,</span> <span class="tok-mi">25</span><span class="tok-p">,</span> <span class="tok-mi">81</span><span class="tok-p">}))))</span> <span class="tok-kr">do</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">v</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>
<span class="tok-c1">--&gt; 1.0</span>
<span class="tok-c1">--&gt; 3.0</span>
<span class="tok-c1">--&gt; 5.0</span>
<span class="tok-c1">--&gt; 9.0</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</dd>
<dt class="hdlist1"><code>takeFirst</code></dt>
<dd>
<p>Адаптер, который берёт первые <code>n</code> элементов.
Подобен <code>head</code> в прошлом примере, но спокойно работает с итераторами, возвращающими несколько значений.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><pre><span></span><span class="tok-kr">for</span> <span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">v</span> <span class="tok-kr">in</span> <span class="tok-n">takeFirst</span><span class="tok-p">(</span><span class="tok-mi">3</span><span class="tok-p">,</span> <span class="tok-n">iter</span><span class="tok-p">(</span><span class="tok-nb">ipairs</span><span class="tok-p">({</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-mi">3</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-mi">5</span><span class="tok-p">})))</span> <span class="tok-kr">do</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">v</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>
<span class="tok-c1">--&gt; 1 1</span>
<span class="tok-c1">--&gt; 2 2</span>
<span class="tok-c1">--&gt; 3 3</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</dd>
<dt class="hdlist1"><code>zip</code></dt>
<dd>
<p>Адаптер, который соединяет несколько итераторов параллельно.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><pre><span></span><span class="tok-kr">for</span> <span class="tok-n">k1</span><span class="tok-p">,</span> <span class="tok-n">v1</span><span class="tok-p">,</span> <span class="tok-n">k2</span><span class="tok-p">,</span> <span class="tok-n">v2</span> <span class="tok-kr">in</span> <span class="tok-n">zip</span><span class="tok-p">(</span><span class="tok-n">iter</span><span class="tok-p">(</span><span class="tok-nb">ipairs</span><span class="tok-p">({</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">})),</span> <span class="tok-n">iter</span><span class="tok-p">(</span><span class="tok-nb">ipairs</span><span class="tok-p">({</span><span class="tok-mi">3</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-mi">5</span><span class="tok-p">})))</span> <span class="tok-kr">do</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">k1</span><span class="tok-p">,</span> <span class="tok-n">v1</span><span class="tok-p">,</span> <span class="tok-n">k2</span><span class="tok-p">,</span> <span class="tok-n">v2</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>
<span class="tok-c1">--&gt; 1 1 1 3</span>
<span class="tok-c1">--&gt; 2 2 2 4 </span><i class="conum" data-value="1"></i><b>(1)</b>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Третьей итерации нет, ибо <code>zip</code> итерирует, пока любой из итераторов не закончится.</td>
</tr>
</tbody></table>
</div>
</dd>
<dt class="hdlist1"><code>chain</code></dt>
<dd>
<p>Адаптер, который соединяет несколько итераторов последовательно.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><pre><span></span><span class="tok-kr">for</span> <span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">v</span> <span class="tok-kr">in</span> <span class="tok-n">chain</span><span class="tok-p">(</span><span class="tok-n">iter</span><span class="tok-p">(</span><span class="tok-nb">ipairs</span><span class="tok-p">({</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">})),</span> <span class="tok-n">iter</span><span class="tok-p">(</span><span class="tok-nb">ipairs</span><span class="tok-p">({</span><span class="tok-mi">5</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">,</span> <span class="tok-mi">3</span><span class="tok-p">})))</span> <span class="tok-kr">do</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">v</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>
<span class="tok-c1">--&gt; 1 1</span>
<span class="tok-c1">--&gt; 2 2</span>
<span class="tok-c1">--&gt; 1 5 </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-c1">--&gt; 2 4</span>
<span class="tok-c1">--&gt; 3 3</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Первый итератор закончился, теперь берёт значения из второго.</td>
</tr>
</tbody></table>
</div>
</dd>
<dt class="hdlist1"><code>only</code></dt>
<dd>
<p>Адаптер, который возвращает только <code>n</code>-ое значение итератора.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><pre><span></span><span class="tok-kr">for</span> <span class="tok-n">v</span> <span class="tok-kr">in</span> <span class="tok-n">only</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-n">iter</span><span class="tok-p">(</span><span class="tok-nb">pairs</span><span class="tok-p">({</span><span class="tok-mi">42</span><span class="tok-p">,</span> <span class="tok-mi">21</span><span class="tok-p">,</span> <span class="tok-mi">7</span><span class="tok-p">})))</span> <span class="tok-kr">do</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">v</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>
<span class="tok-c1">--&gt; 42</span>
<span class="tok-c1">--&gt; 21</span>
<span class="tok-c1">--&gt; 7</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>Продолжим тему итераторов. На корутинах легко сделать стримы — бесконечные итераторы.
Бесконечные они, конечно, только в теории, используют же ограниченное количество значений.</p>
</div>
<div id="code-6.1.3" class="listingblock">
<div class="title">Листинг 6.1.3. Стрим натуральных чисел.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">natural</span><span class="tok-p">(</span><span class="tok-n">start</span><span class="tok-p">)</span>
  <span class="tok-n">start</span> <span class="tok-o">=</span> <span class="tok-n">start</span> <span class="tok-ow">or</span> <span class="tok-mi">1</span>

  <span class="tok-kr">return</span> <span class="tok-nb">coroutine.wrap</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">()</span>
    <span class="tok-kr">for</span> <span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-n">start</span><span class="tok-p">,</span> <span class="tok-nb">math.huge</span><span class="tok-p">,</span> <span class="tok-mi">1</span> <span class="tok-kr">do</span>
      <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-p">)</span>
    <span class="tok-kr">end</span>
  <span class="tok-kr">end</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь, если поместить <code>natural()</code> в цикл <code>for</code>, он будет генерировать эти числа до посинения — пока не дойдёт до <code>break</code>.</p>
</div>
<div id="code-6.1.4" class="listingblock">
<div class="title">Листинг 6.1.4. Пример запуска <code>natural</code> в цикле <code>for</code>.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><pre><span></span><span class="tok-kr">for</span> <span class="tok-n">i</span> <span class="tok-kr">in</span> <span class="tok-n">natural</span><span class="tok-p">()</span> <span class="tok-kr">do</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-p">)</span>

  <span class="tok-kr">if</span> <span class="tok-n">i</span> <span class="tok-o">&gt;=</span> <span class="tok-mi">50</span> <span class="tok-kr">then</span>
    <span class="tok-kr">break</span>
  <span class="tok-kr">end</span>
<span class="tok-kr">end</span>
<span class="tok-c1">--&gt; 1</span>
<span class="tok-c1">--&gt; 2</span>
<span class="tok-c1">--&gt; 3</span>
<span class="tok-c1">--...it goes on and on...</span>
<span class="tok-c1">--&gt; 49</span>
<span class="tok-c1">--&gt; 50</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Сам по себе такой стрим удивительно бесполезен, но с функциями из <a href="#code-6.1.2">примера выше</a> он сияет.
Вот как прицепить номер итерации:</p>
</div>
<div id="code-6.1.5" class="listingblock">
<div class="title">Листинг 6.1.5. Использование <code>natural</code> вместе с адаптерами.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><pre><span></span><span class="tok-kr">for</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">v</span> <span class="tok-kr">in</span> <span class="tok-n">zip</span><span class="tok-p">(</span><span class="tok-n">natural</span><span class="tok-p">(),</span> <span class="tok-n">iter</span><span class="tok-p">(</span><span class="tok-nb">pairs</span><span class="tok-p">({</span><span class="tok-n">foo</span> <span class="tok-o">=</span> <span class="tok-s2">"bar"</span><span class="tok-p">,</span> <span class="tok-n">bar</span> <span class="tok-o">=</span> <span class="tok-s2">"baz"</span><span class="tok-p">,</span> <span class="tok-n">baz</span> <span class="tok-o">=</span> <span class="tok-s2">"spam"</span><span class="tok-p">,</span> <span class="tok-n">spam</span> <span class="tok-o">=</span> <span class="tok-s2">"eggs"</span><span class="tok-p">})))</span> <span class="tok-kr">do</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">k</span><span class="tok-p">,</span> <span class="tok-n">v</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>
<span class="tok-c1">--&gt; 1       foo     bar</span>
<span class="tok-c1">--&gt; 2       baz     spam</span>
<span class="tok-c1">--&gt; 3       spam    eggs</span>
<span class="tok-c1">--&gt; 4       bar     baz</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="openblock videoblock text-center">
<div class="content">
<video controls="controls" preload="metadata">
<source src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/6-1-5.mp4" type="video/mp4">
</video>
<ul class="controls">
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.max(event.target.parentNode.parentNode.parentNode.children[0].currentTime - 1/4, 0)">
← 1 кадр туда
</button>
</li>
<li class="rate-slider">
<div>4 FPS</div>
<input type="range" min="1" max="20" step="1" value="4" autocomplete="off" onchange="event.target.parentNode.parentNode.parentNode.children[0].playbackRate = event.target.value / 4; event.target.parentNode.children[0].innerText = event.target.value + ' FPS'">
</li>
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.min(event.target.parentNode.parentNode.parentNode.children[0].currentTime + 1/4, event.target.parentNode.parentNode.parentNode.children[0].duration)">
1 кадр туда →
</button>
</li>
</ul>
</div>
</div>
<div class="paragraph">
<p>Итератор — жутко универсальная вещь.
Позволяет удобно работать со структурами данных, файлами, различными объектами.
Если они грамотно сделаны, разработчики рады использовать итераторы в своих программах.
Скрасьте жизнь и вы.</p>
</div>
</div>
<div class="sect2">
<h3 id="_многопоточность"><a class="anchor" href="#_многопоточность"></a><a class="link" href="#_многопоточность">6.2. Многопоточность</a></h3>
<div class="paragraph">
<p>На корутинах можно запилить многопоточность.
Она бывает двух видов:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>вытесняющей</strong> — между потоками переключается планировщик;</p>
</li>
<li>
<p><strong>кооперативной</strong> — тогда потоки сами отдают исполнение.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Разумеется, если делать многопоточность на корутинах, то получится кооперативная.
Тогда если один поток зависнет, то заглохнут и все остальные.
Зачем же они такие нужны тогда?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Для разделения программ.
Корутина — это подпрограмма, как и функция (а функция — это подмножество корутин).
Функции используют, чтобы поделить функциональность на независимые кусочки.
То же делается и с корутинами.</p>
</li>
<li>
<p>Для работы с асинхронными данными без километровых цепей коллбэков и промисов.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>В асинхронных программах ключевой элемент — event loop.
Ивент луп — это цикл в программе, который ждёт событий и вызывает обработчиков.
Эта конструкция есть в большинстве UI-библиотек.
Ещё используют в серверах, которые занимаются обработкой запросов по сети, ибо сеть асинхронна.
И так далее.</p>
</div>
<div class="paragraph">
<p>Плюс корутины в том, что она умеет останавливаться несколько раз.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">С корутинами</dt>
<dd>
<p>Ивент луп получил событие A и вызвал корутину-обработчик.
Корутина же отправила HTTP-запрос и уснула.
Теперь ивент луп её разбудит, когда получит событие B, что соединение установлено.
И корутина продолжит работу с того момента в коде, как уснула, что очень удобно.
А пока она спит, могут работать другие корутины.</p>
</dd>
<dt class="hdlist1">Без корутин</dt>
<dd>
<p>Ивент луп запускает корутину, а она сделала HTTP-запрос.
Теперь все остальные корутины работать не будут, пока запрос не завершится и корутина его не обработает.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><a href="#_переписывание_без_корутин">Преобразованием</a> можно избавиться от корутин:
нацепить коллбэков или вместо <code>yield</code> делать <code>return</code> с именем следующего ивента и функцией-обработчиком его.
Однако это только усложнит код (попробуйте переписать и сравнить).</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Ещё корутины легковесны.
В Lua они кушают памяти, как 2–3 функции.
А переключение между ними не влияет существенно на производительность.
Отказываться от них ради оптимизации смысла не имеет.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Поэтому сделаем на корутинах:</p>
</div>
<div id="code-6.2.1" class="listingblock">
<div class="title">Листинг 6.2.1. Event loop на корутинах.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-n">handlers</span> <span class="tok-o">=</span> <span class="tok-p">{}</span>

<span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">_add</span><span class="tok-p">(</span><span class="tok-n">eventType</span><span class="tok-p">,</span> <span class="tok-n">handler</span><span class="tok-p">,</span> <span class="tok-n">default</span><span class="tok-p">)</span>
  <span class="tok-n">handlers</span><span class="tok-p">[</span><span class="tok-n">eventType</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">handlers</span><span class="tok-p">[</span><span class="tok-n">eventType</span><span class="tok-p">]</span> <span class="tok-ow">or</span> <span class="tok-p">{}</span>
  <span class="tok-n">handlers</span><span class="tok-p">[</span><span class="tok-n">eventType</span><span class="tok-p">][</span><span class="tok-n">handler</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">default</span>
<span class="tok-kr">end</span>

<span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">_del</span><span class="tok-p">(</span><span class="tok-n">eventType</span><span class="tok-p">,</span> <span class="tok-n">handler</span><span class="tok-p">)</span>
  <span class="tok-n">handlers</span><span class="tok-p">[</span><span class="tok-n">eventType</span><span class="tok-p">][</span><span class="tok-n">handler</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-kc">nil</span>
<span class="tok-kr">end</span>

<span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">addHandler</span><span class="tok-p">(</span><span class="tok-n">eventType</span><span class="tok-p">,</span> <span class="tok-n">f</span><span class="tok-p">)</span>
  <span class="tok-kd">local</span> <span class="tok-n">handler</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">)</span>
  <span class="tok-n">_add</span><span class="tok-p">(</span><span class="tok-n">eventType</span><span class="tok-p">,</span> <span class="tok-n">handler</span><span class="tok-p">,</span> <span class="tok-n">eventType</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>

<span class="tok-n">addHandler</span><span class="tok-p">(</span><span class="tok-s2">"relay"</span><span class="tok-p">,</span> <span class="tok-kr">function</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">)</span>
  <span class="tok-kr">while</span> <span class="tok-kc">true</span> <span class="tok-kr">do</span>
    <span class="tok-kd">local</span> <span class="tok-n">responseUrl</span> <span class="tok-o">=</span> <span class="tok-n">event</span><span class="tok-p">.</span><span class="tok-n">responseUrl</span>
    <span class="tok-n">sendRequest</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">.</span><span class="tok-n">url</span><span class="tok-p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">sendRequest</span><span class="tok-p">(</span><span class="tok-n">responseUrl</span><span class="tok-p">,</span> <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-s2">"http-connected"</span><span class="tok-p">).</span><span class="tok-n">body</span><span class="tok-p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tok-n">event</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.yield</span><span class="tok-p">()</span> <i class="conum" data-value="3"></i><b>(3)</b>
  <span class="tok-kr">end</span>
<span class="tok-kr">end</span><span class="tok-p">)</span>

<span class="tok-kr">while</span> <span class="tok-kc">true</span> <span class="tok-kr">do</span>
  <span class="tok-kd">local</span> <span class="tok-n">event</span> <span class="tok-o">=</span> <span class="tok-n">waitForEvent</span><span class="tok-p">()</span>

  <span class="tok-kr">if</span> <span class="tok-n">handlers</span><span class="tok-p">[</span><span class="tok-n">event</span><span class="tok-p">.</span><span class="tok-n">type</span><span class="tok-p">]</span> <span class="tok-kr">then</span>
    <span class="tok-kr">for</span> <span class="tok-n">handler</span><span class="tok-p">,</span> <span class="tok-n">defaultEvent</span> <span class="tok-kr">in</span> <span class="tok-nb">pairs</span><span class="tok-p">(</span><span class="tok-n">handlers</span><span class="tok-p">[</span><span class="tok-n">event</span><span class="tok-p">.</span><span class="tok-n">type</span><span class="tok-p">])</span> <span class="tok-kr">do</span>
      <span class="tok-kd">local</span> <span class="tok-n">nextEvent</span> <span class="tok-o">=</span> <span class="tok-nb">select</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">handler</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-p">)))</span> <i class="conum" data-value="4"></i><b>(4)</b>

      <span class="tok-kr">if</span> <span class="tok-nb">coroutine.status</span><span class="tok-p">(</span><span class="tok-n">handler</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-s2">"dead"</span> <span class="tok-kr">then</span> <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="tok-n">_del</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">.</span><span class="tok-n">type</span><span class="tok-p">,</span> <span class="tok-n">handler</span><span class="tok-p">)</span>
      <span class="tok-kr">elseif</span> <span class="tok-ow">not</span> <span class="tok-n">nextEvent</span> <span class="tok-ow">and</span> <span class="tok-n">defaultEvent</span> <span class="tok-o">~=</span> <span class="tok-n">event</span><span class="tok-p">.</span><span class="tok-n">type</span> <span class="tok-kr">then</span> <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="tok-n">_del</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">.</span><span class="tok-n">type</span><span class="tok-p">,</span> <span class="tok-n">handler</span><span class="tok-p">)</span>
        <span class="tok-n">_add</span><span class="tok-p">(</span><span class="tok-n">defaultEvent</span><span class="tok-p">,</span> <span class="tok-n">handler</span><span class="tok-p">,</span> <span class="tok-n">defaultEvent</span><span class="tok-p">)</span>
      <span class="tok-kr">elseif</span> <span class="tok-n">nextEvent</span> <span class="tok-ow">and</span> <span class="tok-n">nextEvent</span> <span class="tok-o">~=</span> <span class="tok-n">event</span><span class="tok-p">.</span><span class="tok-n">type</span> <span class="tok-kr">then</span> <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="tok-n">_del</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">.</span><span class="tok-n">type</span><span class="tok-p">,</span> <span class="tok-n">handler</span><span class="tok-p">)</span>
        <span class="tok-n">_add</span><span class="tok-p">(</span><span class="tok-n">nextEvent</span><span class="tok-p">,</span> <span class="tok-n">handler</span><span class="tok-p">,</span> <span class="tok-n">defaultEvent</span><span class="tok-p">)</span>
      <span class="tok-kr">end</span>
    <span class="tok-kr">end</span>
  <span class="tok-kr">end</span>
<span class="tok-kr">end</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Отправляем запрос.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Ждём ответа, затем снова отправляем запрос.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Так как ответ от второго запроса неинтересен, принимаем следующий ивент.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>assert</code> выбросит ошибку, если она была в корутине, а <code>select</code> уберёт ненужный булеан.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Если корутина сдохла, удаляем её из обработчиков.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Если корутина вернула пустоту, переставляем её обработчиком оригинального ивента (удобство!).</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Иначе переставляем её на другой ивент.</td>
</tr>
</tbody></table>
</div>
<div class="openblock videoblock text-center">
<div class="content">
<video controls="controls" preload="metadata">
<source src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/6-2-1.mp4" type="video/mp4">
</video>
<ul class="controls">
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.max(event.target.parentNode.parentNode.parentNode.children[0].currentTime - 1/4, 0)">
← 1 кадр туда
</button>
</li>
<li class="rate-slider">
<div>4 FPS</div>
<input type="range" min="1" max="20" step="1" value="4" autocomplete="off" onchange="event.target.parentNode.parentNode.parentNode.children[0].playbackRate = event.target.value / 4; event.target.parentNode.children[0].innerText = event.target.value + ' FPS'">
</li>
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.min(event.target.parentNode.parentNode.parentNode.children[0].currentTime + 1/4, event.target.parentNode.parentNode.parentNode.children[0].duration)">
1 кадр туда →
</button>
</li>
</ul>
</div>
</div>
<div class="paragraph">
<p>Мы предполагаем, что <code>sendRequest</code> не блокирует программу, а <code>waitForEvent</code> проверяет статус соединения.
Такое справедливо в большинстве случаев.
Если это не так, обычно есть опция специальная.
Но если и опции нет, то смысла в таком дизайне немного.
"Тяжёлые" функции должны быть асинхронными, чтобы схема выше работала.</p>
</div>
</div>
<div class="sect2">
<h3 id="_конечные_автоматы"><a class="anchor" href="#_конечные_автоматы"></a><a class="link" href="#_конечные_автоматы">6.3. Конечные автоматы</a></h3>
<div class="paragraph">
<p>Объяснить, что такое конечный автомат, можно тремя способами:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>формально;</p>
</li>
<li>
<p>корректно;</p>
</li>
<li>
<p>и по-простому.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Первые два объяснения можно найти, например, на Википедии.
Здесь попробуем простой вариант.</p>
</div>
<div class="paragraph">
<p>Есть дверь.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>У неё 2 состояния: <strong>открыта</strong>, <strong>закрыта</strong>.</p>
</li>
<li>
<p>С ней можно проделать 3 действия: <em>пройти</em>, <em>открыть</em>, <em>закрыть</em>.</p>
</li>
<li>
<p>Когда она <strong>закрыта</strong>, нельзя <em>пройти</em> и нельзя <em>закрыть</em> её.
Зато её можно <em>открыть</em> — тогда дверь становится <strong>открытой</strong>.</p>
</li>
<li>
<p>Когда она <strong>открыта</strong>, нельзя <em>открыть</em> её.
Но можно <em>пройти</em>.
Ещё её можно <em>закрыть</em> — дверь становится <strong>закрытой</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Во-первых, оказывается, что дверь — это сложный механизм.
Во-вторых, это <strong>конечный автомат</strong>.
Не знаю, какой из этих фактов удивительнее, но докажу второй.</p>
</div>
<div class="paragraph">
<p>Конечный автомат — это штука, у которой есть определённое число состояний, и она пребывает в одном из них.
На вход автомату подаются какие-то действия.
И в зависимости от действия и текущего состояния автомат переходит в новое состояние.</p>
</div>
<div class="paragraph">
<p>В примере с дверью я говорил, что какие-то действия сделать нельзя.
Например, нельзя закрыть закрытую дверь.
Иначе можно сказать, что действие <em>закрыть</em>, когда дверь <strong>закрыта</strong>, меняет состояние на <strong>закрытое</strong>.
Звучит бредово, зато понятно, почему дверь — конечный автомат.</p>
</div>
<div class="paragraph">
<p>Конечным же он называется только потому, что конечно число состояний.
В английском языке прямо так называют — finite-state machine.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Понятие это применяют не только к двери, разумеется.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Автомат с напитками — конечный автомат.</p>
<div class="paragraph">
<p>Число его состояний определяется числом видов напитков и максимальной вместимостью автомата.
Помножим одно число на другое, а потом ещё на два: когда монетка вставлена и когда не вставлена.
Получим, что число состояний определено и конечно; автомат пребывает только в одном из них.</p>
</div>
<div class="paragraph">
<p>Возможные действия: вставить монетку и нажать на одну из кнопок выбора напитка.</p>
</div>
</li>
<li>
<p>Автомат оружейный — конечный автомат.</p>
<div class="paragraph">
<p>Число его состояний определяется вместимостью магазина — по одному состоянию на каждое число патронов.</p>
</div>
<div class="paragraph">
<p>Возможные действия: стрелять и перезарядить.</p>
</div>
</li>
<li>
<p>И ещё огромная куча других вещей.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Вернёмся, впрочем, к программированию.
Конечный автомат (и его более фичастые родственники) используется для моделирования:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>сетевых протоколов;</p>
</li>
<li>
<p>компиляторов, в частности лексеров;</p>
</li>
<li>
<p>графических интерфейсов;</p>
</li>
<li>
<p>и т. д.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Эти вещи очень удобно реализовывать с помощью корутин.
Текущее состояние хранится как явно (переменные), так и неявно (стэк вызовов и исполняемая операция).</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Рассмотрим сетевой протокол FTP.
Типичный сценарий:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Подключиться к серверу.
Подождать ответа.</p>
</li>
<li>
<p>Послать юзернейм.
Подождать ответа.</p>
</li>
<li>
<p>Отослать пароль.
Получить подтверждение входа.</p>
</li>
<li>
<p>Попросить его открыть порт для передачи данных.
Получить подтверждение.</p>
</li>
<li>
<p>Подключиться на этот порт.</p>
</li>
<li>
<p>Отправить запрос на получение файла.
Получить подтверждение.</p>
</li>
<li>
<p>Считать файл.</p>
</li>
<li>
<p>Завершить подключение.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Состояние описывается текущим этапом подключения.
То есть позицией в коде.
Поэтому легко реализовать клиент на корутинах.</p>
</div>
<div id="code-6.3.1" class="listingblock">
<div class="title">Листинг 6.3.1. Очень абстрактная версия FTP-клиента.</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="lua"><table class="linenotable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre></div></td><td class="code"><pre><span></span><span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">send</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-p">)</span>
  <span class="tok-kr">return</span> <span class="tok-nb">coroutine.yield</span><span class="tok-p">(</span><span class="tok-s2">"send"</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-p">)</span>
<span class="tok-kr">end</span>

<span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">pasv</span><span class="tok-p">()</span>
  <span class="tok-kd">local</span> <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-n">send</span><span class="tok-p">(</span><span class="tok-s2">"PASV</span><span class="tok-se">\r\n</span><span class="tok-s2">"</span><span class="tok-p">)</span>
  <span class="tok-n">expectResponse</span><span class="tok-p">(</span><span class="tok-mi">227</span><span class="tok-p">,</span> <span class="tok-n">response</span><span class="tok-p">)</span>
  <span class="tok-c1">-- ...</span>
  <span class="tok-kr">return</span> <span class="tok-n">dataAddr</span>
<span class="tok-kr">end</span>

<span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">newConnection</span><span class="tok-p">(</span><span class="tok-n">address</span><span class="tok-p">,</span> <span class="tok-n">co</span><span class="tok-p">)</span>
  <span class="tok-kd">local</span> <span class="tok-n">socket</span> <span class="tok-o">=</span> <span class="tok-n">establishConnection</span><span class="tok-p">(</span><span class="tok-n">address</span><span class="tok-p">)</span>
  <span class="tok-n">socket</span><span class="tok-p">:</span><span class="tok-n">setBlocking</span><span class="tok-p">(</span><span class="tok-kc">true</span><span class="tok-p">)</span>

  <span class="tok-kr">return</span> <span class="tok-kr">function</span><span class="tok-p">()</span>
    <span class="tok-kr">while</span> <span class="tok-n">socket</span><span class="tok-p">:</span><span class="tok-n">isConnected</span><span class="tok-p">()</span> <span class="tok-kr">do</span>
      <span class="tok-kd">local</span> <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-n">socket</span><span class="tok-p">:</span><span class="tok-n">readLine</span><span class="tok-p">()</span>
      <span class="tok-kd">local</span> <span class="tok-n">tag</span><span class="tok-p">,</span> <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-nb">select</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-nb">coroutine.resume</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">,</span> <span class="tok-n">response</span><span class="tok-p">)))</span>

      <span class="tok-kr">if</span> <span class="tok-n">tag</span> <span class="tok-o">==</span> <span class="tok-s2">"send"</span> <span class="tok-kr">then</span>
        <span class="tok-n">socket</span><span class="tok-p">:</span><span class="tok-n">send</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-p">)</span>
      <span class="tok-kr">end</span>

      <span class="tok-kr">if</span> <span class="tok-nb">coroutine.status</span><span class="tok-p">(</span><span class="tok-n">co</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-s2">"dead"</span> <span class="tok-kr">then</span>
        <span class="tok-n">socket</span><span class="tok-p">:</span><span class="tok-n">close</span><span class="tok-p">()</span>
      <span class="tok-kr">end</span>
    <span class="tok-kr">end</span>
  <span class="tok-kr">end</span>
<span class="tok-kr">end</span>

<span class="tok-kd">local</span> <span class="tok-kr">function</span> <span class="tok-nf">getFile</span><span class="tok-p">(</span><span class="tok-n">addr</span><span class="tok-p">,</span> <span class="tok-n">user</span><span class="tok-p">,</span> <span class="tok-n">pass</span><span class="tok-p">,</span> <span class="tok-n">filename</span><span class="tok-p">)</span>
  <span class="tok-kr">return</span> <span class="tok-n">newConnection</span><span class="tok-p">(</span><span class="tok-n">addr</span><span class="tok-p">,</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">(</span><span class="tok-n">response</span><span class="tok-p">)</span>
    <span class="tok-n">expectResponse</span><span class="tok-p">(</span><span class="tok-mi">220</span><span class="tok-p">,</span> <span class="tok-n">response</span><span class="tok-p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">expectResponse</span><span class="tok-p">(</span><span class="tok-mi">331</span><span class="tok-p">,</span> <span class="tok-n">send</span><span class="tok-p">(</span><span class="tok-s2">"USER "</span> <span class="tok-o">..</span> <span class="tok-n">user</span> <span class="tok-o">..</span> <span class="tok-s2">"</span><span class="tok-se">\r\n</span><span class="tok-s2">"</span><span class="tok-p">))</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">expectResponse</span><span class="tok-p">(</span><span class="tok-mi">230</span><span class="tok-p">,</span> <span class="tok-n">send</span><span class="tok-p">(</span><span class="tok-s2">"PASS "</span> <span class="tok-o">..</span> <span class="tok-n">pass</span> <span class="tok-o">..</span> <span class="tok-s2">"</span><span class="tok-se">\r\n</span><span class="tok-s2">"</span><span class="tok-p">))</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-kd">local</span> <span class="tok-n">dataAddr</span> <span class="tok-o">=</span> <span class="tok-n">pasv</span><span class="tok-p">()</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-kd">local</span> <span class="tok-n">f</span> <span class="tok-o">=</span> <span class="tok-nb">assert</span><span class="tok-p">(</span><span class="tok-nb">io.open</span><span class="tok-p">(</span><span class="tok-s2">"./"</span> <span class="tok-o">..</span> <span class="tok-n">filename</span><span class="tok-p">,</span> <span class="tok-s2">"w"</span><span class="tok-p">))</span>

    <span class="tok-kd">local</span> <span class="tok-n">dataSocket</span> <span class="tok-o">=</span> <span class="tok-n">newConnection</span><span class="tok-p">(</span><span class="tok-n">dataAddr</span><span class="tok-p">,</span> <span class="tok-nb">coroutine.create</span><span class="tok-p">(</span><span class="tok-kr">function</span><span class="tok-p">(</span><span class="tok-n">chunk</span><span class="tok-p">)</span> <i class="conum" data-value="5"></i><b>(5)</b>
      <span class="tok-kr">while</span> <span class="tok-n">chunk</span> <span class="tok-kr">do</span>
        <span class="tok-n">f</span><span class="tok-p">:</span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">chunk</span><span class="tok-p">)</span>
        <span class="tok-n">chunk</span> <span class="tok-o">=</span> <span class="tok-nb">coroutine.yield</span><span class="tok-p">()</span>
      <span class="tok-kr">end</span>

      <span class="tok-n">f</span><span class="tok-p">:</span><span class="tok-n">close</span><span class="tok-p">()</span>
    <span class="tok-kr">end</span><span class="tok-p">))</span>

    <span class="tok-n">expectResponse</span><span class="tok-p">(</span><span class="tok-mi">150</span><span class="tok-p">,</span> <span class="tok-n">send</span><span class="tok-p">(</span><span class="tok-s2">"RETR "</span> <span class="tok-o">..</span> <span class="tok-n">filename</span> <span class="tok-o">..</span> <span class="tok-s2">"</span><span class="tok-se">\r\n</span><span class="tok-s2">"</span><span class="tok-p">))</span> <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="tok-n">dataSocket</span><span class="tok-p">()</span> <i class="conum" data-value="7"></i><b>(7)</b>
    <span class="tok-n">send</span><span class="tok-p">(</span><span class="tok-s2">"QUIT</span><span class="tok-se">\r\n</span><span class="tok-s2">"</span><span class="tok-p">)</span> <i class="conum" data-value="8"></i><b>(8)</b>
  <span class="tok-kr">end</span><span class="tok-p">))()</span>
<span class="tok-kr">end</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="openblock videoblock text-center">
<div class="content">
<video controls="controls" preload="metadata">
<source src="%D0%A7%D1%82%D0%BE%20%D1%82%D0%B0%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%BE%D1%80%D1%83%D1%82%D0%B8%D0%BD%D1%8B_files/6-3-1.mp4" type="video/mp4">
</video>
<ul class="controls">
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.max(event.target.parentNode.parentNode.parentNode.children[0].currentTime - 1/4, 0)">
← 1 кадр туда
</button>
</li>
<li class="rate-slider">
<div>4 FPS</div>
<input type="range" min="1" max="20" step="1" value="4" autocomplete="off" onchange="event.target.parentNode.parentNode.parentNode.children[0].playbackRate = event.target.value / 4; event.target.parentNode.children[0].innerText = event.target.value + ' FPS'">
</li>
<li>
<button type="button" onclick="event.target.parentNode.parentNode.parentNode.children[0].currentTime = Math.min(event.target.parentNode.parentNode.parentNode.children[0].currentTime + 1/4, event.target.parentNode.parentNode.parentNode.children[0].duration)">
1 кадр туда →
</button>
</li>
</ul>
</div>
</div>
<div class="paragraph">
<p>Чтобы показать, как близко транслируется протокол в код, я расставил номера шагов.</p>
</div>
<div class="paragraph">
<p>Если доделать <code>pasv</code>, <code>establishConnection</code>, <code>expectResponse</code>, то FTP-клиент будет готов.
И код будет выглядеть очень красиво.
Допилить код до нужного состояния проблемы тоже не составит.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ещё_применения"><a class="anchor" href="#_ещё_применения"></a><a class="link" href="#_ещё_применения">6.4. Ещё применения</a></h3>
<div class="ulist">
<ul>
<li>
<p>Лексер (разбивает код на токены, чтобы парсить).</p>
</li>
<li>
<p>Регулярные выражения.</p>
</li>
<li>
<p>Сложные системы логирования.</p>
</li>
<li>
<p>Модель акторов.</p>
</li>
<li>
<p>Дебаггер (запустить программу для дебага в корутине и общаться с помощью <code>yield</code>).</p>
</li>
<li>
<p>Обработка ошибок (благодаря тому, что значения переменных остаются даже после <code>error</code>).</p>
</li>
<li>
<p>Рисование анимаций.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_заключение"><a class="anchor" href="#_заключение"></a><a class="link" href="#_заключение">7. Заключение</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Тур по корутинам завершён.
Опираясь на этот материал, я надеюсь, вы сможете побороть страх перед ними.
Вопросы можно задать мне в <a href="irc://irc.esper.net/#cc.ru">IRC: #cc.ru @ irc.esper.net</a>.</p>
</div>
<div class="paragraph">
<p>Ниже — дополнительный материал.
Рекомендую полистать, если хочется что-то прояснить.</p>
</div>
<div class="sect2">
<h3 id="_библиография"><a class="anchor" href="#_библиография"></a><a class="link" href="#_библиография">Библиография</a></h3>
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p>Ana L ́ucia de Moura and Roberto Ierusalimschy. 2004.
<a href="http://www.inf.puc-rio.br/~roberto/docs/MCC15-04.pdf"><em>Revisiting Coroutines</em></a>.
ACM Transactions on Programming Languages and Systems.</p>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Эта работа очень помогла в написании гайда.
Рекомендую к прочтению.</p>
</div>
<div class="paragraph">
<p>Из неё взято и адаптировано:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Классификация корутин</p>
</li>
<li>
<p>Преобразование асимметричной корутины в симметричную</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Roberto Ierusalimschy. 2004.
<a href="https://www.lua.org/pil/9.html"><em>Coroutines</em></a>.
Programming in Lua (1st ed.). Lua.org.</p>
</li>
<li>
<p>Roberto Ierusalimschy.
<em>Coroutines</em>.
Programming in Lua (4th ed.), стр. 194–204.</p>
</li>
<li>
<p><a href="https://www.lua.org/manual/5.3/manual.html#6.2"><em>Coroutine Manipulation</em></a>.
Lua 5.3 Reference Manual. Lua.org.</p>
</li>
<li>
<p><a href="https://en.wikibooks.org/wiki/Lua_Programming/Standard_libraries#Coroutines"><em>Coroutines</em></a>.
Lua Programming/Standard Libraries. Wikibooks.org.</p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Coroutine"><em>Coroutine</em></a>.
Wikipedia.org.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_примеры"><a class="anchor" href="#_примеры"></a><a class="link" href="#_примеры">Приложение A: Примеры</a></h3>
<div class="ulist">
<div class="title">Список всех примеров с корутинами в этой статье</div>
<ul>
<li>
<p><a href="#code-1.3">Листинг 1.3. Фибоначчи на корутинах.</a></p>
</li>
<li>
<p><a href="#code-5.1.1">Листинг 5.1.1. Симметричные корутины в Lua.</a></p>
</li>
<li>
<p><a href="#code-5.1.2">Листинг 5.1.2. Симметричные корутины. Обёртка вокруг <code>coroutine.create</code>.</a></p>
</li>
<li>
<p><a href="#code-5.1.3">Листинг 5.1.3. Копирование файлов на симметричных корутинах.</a></p>
</li>
<li>
<p><a href="#code-5.2.1">Листинг 5.2.1. Переписывание без корутин: деление функции. С корутинами.</a></p>
</li>
<li>
<p><a href="#code-5.2.3">Листинг 5.2.3. Обход дерева с корутинами.</a></p>
</li>
<li>
<p><a href="#code-6.1.1">Листинг 6.1.1. Пример пайпинга на корутинах.</a></p>
</li>
<li>
<p><a href="#code-6.1.2">Листинг 6.1.2. Некоторые функции для работы с итераторами.</a></p>
</li>
<li>
<p><a href="#code-6.1.3">Листинг 6.1.3. Стрим натуральных чисел.</a></p>
</li>
<li>
<p><a href="#code-6.1.4">Листинг 6.1.4. Пример запуска <code>natural</code> в цикле <code>for</code>.</a></p>
</li>
<li>
<p><a href="#code-6.1.5">Листинг 6.1.5. Использование <code>natural</code> вместе с адаптерами.</a></p>
</li>
<li>
<p><a href="#code-6.2.1">Листинг 6.2.1. Event loop на корутинах.</a></p>
</li>
<li>
<p><a href="#code-6.3.1">Листинг 6.3.1. Очень абстрактная версия FTP-клиента.</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_корутины_в_дикой_природе"><a class="anchor" href="#_корутины_в_дикой_природе"></a><a class="link" href="#_корутины_в_дикой_природе">Приложение B: Корутины в дикой природе</a></h3>
<div class="paragraph">
<p>По ссылкам — код, который использует корутины.
Для каждого примера есть причина, почему там корутины к месту.
Если нечем заняться, предлагаю её найти и понять, как работает код.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/diegonehab/luasocket/blob/master/etc/dispatch.lua">Диспатчер в luasocket</a>.</p>
</li>
<li>
<p><a href="https://github.com/openwrt/luci/blob/master/libs/luci-lib-json/luasrc/json.lua">Парсер JSON</a>.</p>
</li>
<li>
<p><a href="https://github.com/stevedonovan/Penlight/blob/master/lua/pl/lexer.lua">Лексер Lua/C для докогенератора</a>.</p>
</li>
<li>
<p><a href="https://github.com/rxi/lite/blob/9fc185af2ff44c5c6a58312a9534bdf416c6c90d/data/plugins/treeview.lua#L67-L99">Treeview в редакторе кода</a>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Корутины используются довольно редко, что печалит.
Но список выше должен состоять явно не из 3 пунктов.
Если знаете программу на Lua, которая использует корутины для забавных вещей
(например, из <a href="#_ещё_применения">этого списка</a>), расскажите мне о ней в IRC.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_видяхи_с_интерпретацией"><a class="anchor" href="#_видяхи_с_интерпретацией"></a><a class="link" href="#_видяхи_с_интерпретацией">Приложение C: Видяхи с интерпретацией</a></h3>
<div class="paragraph">
<p>Сгенерировал своей программой.
Ссылка на неё: <a href="https://gitlab.com/cc-ru/crateriform">crateriform</a>.</p>
</div>
<div class="paragraph">
<p>Там же — код примеров, который использовался для рендера видео.</p>
</div>
</div>
<div class="sect2">
<h3 id="_сырцы_и_лицензия"><a class="anchor" href="#_сырцы_и_лицензия"></a><a class="link" href="#_сырцы_и_лицензия">Приложение D: Сырцы и лицензия</a></h3>
<div class="paragraph">
<p>Исходный код документа и сопровождающий контент доступен <a href="https://gitlab.com/fingercomp/lua-coroutines">в репозитории</a>.</p>
</div>
<div class="paragraph">
<p>Контент доступен по <a href="http://creativecommons.org/licenses/by/4.0/">лицензии Creative Commons Attribution 4.0 International</a>.
См. <a href="https://gitlab.com/fingercomp/lua-coroutines/blob/master/LICENSE">LICENSE</a> в репозитории.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0.1<br>
Последнее обновление: 2020-05-07 08:06:51 UTC
</div>
</div>
<style>
pre.pygments .hll { background-color: #ffffcc }
pre.pygments  { background: #f0f3f3; }
pre.pygments .tok-c { color: #0099FF; font-style: italic } /* Comment */
pre.pygments .tok-err { color: #AA0000; background-color: #FFAAAA } /* Error */
pre.pygments .tok-k { color: #006699; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #555555 } /* Operator */
pre.pygments .tok-ch { color: #0099FF; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #0099FF; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #009999 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #0099FF; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #0099FF; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #0099FF; font-weight: bold; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { background-color: #FFCCCC; border: 1px solid #CC0000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #FF0000 } /* Generic.Error */
pre.pygments .tok-gh { color: #003300; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { background-color: #CCFFCC; border: 1px solid #00CC00 } /* Generic.Inserted */
pre.pygments .tok-go { color: #AAAAAA } /* Generic.Output */
pre.pygments .tok-gp { color: #000099; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #003300; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #99CC66 } /* Generic.Traceback */
pre.pygments .tok-kc { color: #006699; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #006699; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #006699; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #006699 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #006699; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #007788; font-weight: bold } /* Keyword.Type */
pre.pygments .tok-m { color: #FF6600 } /* Literal.Number */
pre.pygments .tok-s { color: #CC3300 } /* Literal.String */
pre.pygments .tok-na { color: #330099 } /* Name.Attribute */
pre.pygments .tok-nb { color: #336666 } /* Name.Builtin */
pre.pygments .tok-nc { color: #00AA88; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #336600 } /* Name.Constant */
pre.pygments .tok-nd { color: #9999FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #CC0000; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #CC00FF } /* Name.Function */
pre.pygments .tok-nl { color: #9999FF } /* Name.Label */
pre.pygments .tok-nn { color: #00CCFF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #330099; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #003333 } /* Name.Variable */
pre.pygments .tok-ow { color: #000000; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #FF6600 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #FF6600 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #FF6600 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #FF6600 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #FF6600 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #CC3300 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #CC3300 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #CC3300 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #CC3300 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #CC3300; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #CC3300 } /* Literal.String.Double */
pre.pygments .tok-se { color: #CC3300; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #CC3300 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #AA0000 } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #CC3300 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #33AAAA } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #CC3300 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #FFCC33 } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #336666 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #CC00FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #003333 } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #003333 } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #003333 } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #003333 } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #FF6600 } /* Literal.Number.Integer.Long */
</style>

</body></html>